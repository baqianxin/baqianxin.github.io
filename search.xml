<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>webæœåŠ¡httpsè¯ä¹¦è®¾ç½®-nginx/golang</title>
      <link href="2021/05/26/web%E6%9C%8D%E5%8A%A1https%E8%AF%81%E4%B9%A6%E8%AE%BE%E7%BD%AE-nginx-golang/"/>
      <url>2021/05/26/web%E6%9C%8D%E5%8A%A1https%E8%AF%81%E4%B9%A6%E8%AE%BE%E7%BD%AE-nginx-golang/</url>
      
        <content type="html"><![CDATA[        <h2 id="è¯ä¹¦"   >          <a href="#è¯ä¹¦" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¯ä¹¦" class="headerlink" title="è¯ä¹¦"></a>è¯ä¹¦</h2>      <ul><li>ç”¨äºç­¾åçš„ä¿¡æ¯</li><li>â€¦</li><li>.crt/.cer è¯ä¹¦(Certificate)</li><li>.key å¯†é’¥/ç§é’¥(Private Key)</li><li>.csr è¯ä¹¦è®¤è¯ç­¾åè¯·æ±‚(Certificate signing request)</li><li>*.pem base64ç¼–ç æ–‡æœ¬å‚¨å­˜æ ¼å¼ï¼Œå¯ä»¥å•ç‹¬æ”¾è¯ä¹¦æˆ–å¯†é’¥ï¼Œä¹Ÿå¯ä»¥åŒæ—¶æ”¾ä¸¤ä¸ªï¼›base64ç¼–ç å°±æ˜¯ä¸¤æ¡â€”â€”-ä¹‹é—´çš„é‚£äº›è«åå…¶å¦™çš„å­—ç¬¦</li><li>*.der è¯ä¹¦çš„äºŒè¿›åˆ¶å‚¨å­˜æ ¼å¼(ä¸å¸¸ç”¨)</li></ul><p>è‡ªç­¾è¯ä¹¦ä½¿ç”¨æ³¨æ„äº‹é¡¹</p><ul><li>æ ¹è¯ä¹¦æ·»åŠ </li><li>ç­¾åè¯ä¹¦æ·»åŠ </li></ul>        <h2 id="ç”Ÿæˆæ–¹å¼"   >          <a href="#ç”Ÿæˆæ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç”Ÿæˆæ–¹å¼" class="headerlink" title="ç”Ÿæˆæ–¹å¼"></a>ç”Ÿæˆæ–¹å¼</h2>      <span id="more"></span><ul><li>å·¥å…·ç½‘ç«™</li><li>openssl</li></ul>        <h2 id="nginx-é…ç½®sslç›¸å…³å‚æ•°"   >          <a href="#nginx-é…ç½®sslç›¸å…³å‚æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#nginx-é…ç½®sslç›¸å…³å‚æ•°" class="headerlink" title="nginx é…ç½®sslç›¸å…³å‚æ•°"></a>nginx é…ç½®sslç›¸å…³å‚æ•°</h2>      <ul><li>listen 443 default_server ssl;</li><li>ssl_certificate /etc/nginx/certs/default.crt;</li><li>ssl_certificate_key /etc/nginx/certs/default.key;</li></ul><p>ä¼˜åŒ–è®¾ç½®</p><ul><li>æ”¯æŒåè®®</li><li>â€¦.</li></ul>        <h2 id="Go-webæœåŠ¡ä½¿ç”¨è¯ä¹¦"   >          <a href="#Go-webæœåŠ¡ä½¿ç”¨è¯ä¹¦" class="heading-link"><i class="fas fa-link"></i></a><a href="#Go-webæœåŠ¡ä½¿ç”¨è¯ä¹¦" class="headerlink" title="Go-webæœåŠ¡ä½¿ç”¨è¯ä¹¦"></a>Go-webæœåŠ¡ä½¿ç”¨è¯ä¹¦</h2>      ]]></content>
      
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> nginx </tag>
            
            <tag> https </tag>
            
            <tag> web </tag>
            
            <tag> ssl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang-sqlx-clickhouse-tuple</title>
      <link href="2020/09/23/golang-sqlx-clickhouse-tuple/"/>
      <url>2020/09/23/golang-sqlx-clickhouse-tuple/</url>
      
        <content type="html"><![CDATA[        <h1 id="GoæŸ¥è¯¢CH-æ•°æ®-tuple-è½¬æ•°ç»„æ“ä½œ"   >          <a href="#GoæŸ¥è¯¢CH-æ•°æ®-tuple-è½¬æ•°ç»„æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#GoæŸ¥è¯¢CH-æ•°æ®-tuple-è½¬æ•°ç»„æ“ä½œ" class="headerlink" title="GoæŸ¥è¯¢CH æ•°æ® tuple è½¬æ•°ç»„æ“ä½œ"></a>GoæŸ¥è¯¢CH æ•°æ® tuple è½¬æ•°ç»„æ“ä½œ</h1>              <h2 id="Go-æŸ¥è¯¢-ClickHouse"   >          <a href="#Go-æŸ¥è¯¢-ClickHouse" class="heading-link"><i class="fas fa-link"></i></a><a href="#Go-æŸ¥è¯¢-ClickHouse" class="headerlink" title="Go æŸ¥è¯¢ ClickHouse"></a>Go æŸ¥è¯¢ ClickHouse</h2>              <h2 id="Row-è½¬-Map"   >          <a href="#Row-è½¬-Map" class="heading-link"><i class="fas fa-link"></i></a><a href="#Row-è½¬-Map" class="headerlink" title="Row è½¬ Map"></a>Row è½¬ Map</h2>              <h2 id="Tuple-è½¬-æ•°ç»„"   >          <a href="#Tuple-è½¬-æ•°ç»„" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tuple-è½¬-æ•°ç»„" class="headerlink" title="Tuple è½¬ æ•°ç»„"></a>Tuple è½¬ æ•°ç»„</h2>      ]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>html-a-noreferer</title>
      <link href="2020/09/23/html-a-noreferer/"/>
      <url>2020/09/23/html-a-noreferer/</url>
      
        <content type="html"><![CDATA[        <h1 id="ä½¿ç”¨-a-æ ‡ç­¾çš„é—®é¢˜"   >          <a href="#ä½¿ç”¨-a-æ ‡ç­¾çš„é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä½¿ç”¨-a-æ ‡ç­¾çš„é—®é¢˜" class="headerlink" title="ä½¿ç”¨ a æ ‡ç­¾çš„é—®é¢˜"></a>ä½¿ç”¨ a æ ‡ç­¾çš„é—®é¢˜</h1>              <h2 id="HTMl-lt-a-gt-lt-a-gt-noreferrer-noopener-nofollow"   >          <a href="#HTMl-lt-a-gt-lt-a-gt-noreferrer-noopener-nofollow" class="heading-link"><i class="fas fa-link"></i></a><a href="#HTMl-lt-a-gt-lt-a-gt-noreferrer-noopener-nofollow" class="headerlink" title="HTMl:&lt;a&gt;&lt;/a&gt; noreferrer noopener nofollow"></a>HTMl:&lt;a&gt;&lt;/a&gt; noreferrer noopener nofollow</h2>      <p>åœ¨ä½¿ç”¨ VSCode ç¼–è¾‘ Html ä»£ç æ—¶:æç¤º</p><p><code>Line 71:36:  Using target=&quot;_blank&quot; without rel=&quot;noopener noreferrer&quot; is a security risk: see https://mathiasbynens.github.io/rel-noopener  react/jsx-no-target-blank</code></p><p>æˆ‘å¤§æ¦‚æŸ¥çœ‹äº†ä¸€ä¸‹ç›¸å…³çš„<span class="exturl"><a class="exturl__link"   href="https://web.dev/external-anchors-use-rel-noopener/" >æ¼æ´æè¿°</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>,å°±ç›´æ¥åŠ ä¸Šäº†å¯¹åº”çš„ <a href="https://web.dev/external-anchors-use-rel-noopener/"><code>rel=&quot;noopener noreferrer&quot;</code></a> å±æ€§,ä»¥ä¸ºå°±è¿™æ ·å®Œäº‹äº†,æ²¡é—®é¢˜!</p><hr><p>å¯åˆ°äº†æµ‹è¯•ç¯å¢ƒå‘ç°æœ‰ä¸€ä¸ªè·³è½¬åˆ°ä¸‹è½½é“¾æ¥çš„æ¥å£ä¸€ç›´èº«ä»½éªŒè¯ä¸é€šè¿‡<br>å°±å»å¾€ä¸‹æ’æŸ¥äº†ä¸€ä¸‹,å‘ç°èº«ä»½éªŒè¯é€»è¾‘ä¸­æœ‰:åœ¨æŒ‡å®šç¯å¢ƒä¸‹éªŒè¯è¯·æ±‚å¤´ä¸­çš„ <code>referer</code> å±æ€§æ˜¯å¦ç­‰äº <code>host</code><br>çš„é€»è¾‘,</p><p>ç„¶åå°±å»æ£€æŸ¥äº†ç›¸å…³çš„è¯·æ±‚å¤´ä¿¡æ¯,å‘ç°é—®é¢˜äº†: æ²¡æœ‰ <code>referer</code> å±æ€§;</p><p>æœ€åˆä»¥ä¸ºæ˜¯Nginxä»£ç†æ¥å£çš„æ—¶å€™æ²¡æœ‰è½¬å‘å¯¹äºçš„å¤´ä¿¡æ¯,ç»è¿‡æ’æŸ¥å‘ç°å¹¶ä¸æ˜¯.</p><p>åæ¥æœ‰ç»§ç»­å¯¹æ¯”çº¿ä¸Šç¯å¢ƒçš„æ¥å£,åŒæ ·æµè§ˆå™¨ä¸‹åŒä¸€ä¸ªæ¥å£å‡ºç°äº† çº¿ä¸Šç¯å¢ƒ è¯·æ±‚å¤´ä¸ æµ‹è¯•ç¯å¢ƒè¯·æ±‚å¤´ä¸ä¸€è‡´çš„é—®é¢˜.<br>é‡ç‚¹è¡¨ç°: <code>Request Header</code> ä¸­çš„ <code>Referrer Policy: no referer</code>.</p><p>è¿™æ‰çŸ¥é“: <code>a</code> æ ‡ç­¾çš„ <code>noreferrer</code> ä¼šå¯¼è‡´è·³è½¬åœ°å€çš„è¯·æ±‚é‡è®¾ <code>Referrer Policy</code></p>        <h2 id="Referrer-Policy"   >          <a href="#Referrer-Policy" class="heading-link"><i class="fas fa-link"></i></a><a href="#Referrer-Policy" class="headerlink" title="Referrer Policy:"></a>Referrer Policy:</h2>              <h3 id="ç­–ç•¥"   >          <a href="#ç­–ç•¥" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç­–ç•¥" class="headerlink" title="ç­–ç•¥"></a>ç­–ç•¥</h3>      <ul><li><code>No Referrer</code>ï¼šä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å‘é€Referrerä¿¡æ¯</li><li><code>No Referrer When Downgrade</code>ï¼šä»…å½“åè®®é™çº§ï¼ˆå¦‚HTTPSé¡µé¢å¼•å…¥HTTPèµ„æºï¼‰æ—¶ä¸å‘é€Referrerä¿¡æ¯ã€‚æ˜¯å¤§éƒ¨åˆ†æµè§ˆå™¨é»˜è®¤ç­–ç•¥ã€‚</li><li><code>Origin Only</code>ï¼šå‘é€åªåŒ…å«hostéƒ¨åˆ†çš„referrer.</li><li><code>Origin When Cross-origin</code>ï¼šä»…åœ¨å‘ç”Ÿè·¨åŸŸè®¿é—®æ—¶å‘é€åªåŒ…å«hostçš„Refererï¼ŒåŒåŸŸä¸‹è¿˜æ˜¯å®Œæ•´çš„ã€‚ä¸Origin Onlyçš„åŒºåˆ«æ˜¯å¤šåˆ¤æ–­äº†æ˜¯å¦Cross-originã€‚åè®®ã€åŸŸåå’Œç«¯å£éƒ½ä¸€è‡´ï¼Œæµè§ˆå™¨æ‰è®¤ä¸ºæ˜¯åŒåŸŸã€‚</li><li><code>Unsafe URL</code>ï¼šå…¨éƒ¨éƒ½å‘é€Referrerä¿¡æ¯ã€‚æœ€å®½æ¾æœ€ä¸å®‰å…¨çš„ç­–ç•¥ã€‚</li></ul>        <h3 id="ä½¿ç”¨"   >          <a href="#ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3>      <ul><li><p><a href="">CSP(Content-Security-Policy)</a></p></li><li><p>æ ‡ç­¾</p><ul><li>meta</li><li>a</li></ul><p>htmlé¡µé¢çš„metaæ ‡ç­¾æŒ‡å®šã€‚</p><p><code>&lt;meta name=referrer content=no-referrer&gt;</code></p><p>a æ ‡ç­¾çš„refererå±æ€§ä½œç”¨çš„åªæ˜¯å½“å‰æ ‡ç­¾ã€‚<br>ç­–ç•¥åªæœ‰ä¸‰ä¸­ï¼šä¸ä¼ ã€åªhostã€éƒ½ä¼ <br>é’ˆå¯¹å•ä¸ªé“¾æ¥è®¾ç½®çš„ç­–ç•¥ä¼˜å…ˆçº§é«˜ã€‚</p><p><code>&lt;a href=&quot;http://example.com&quot; rel=&quot;noopener noreferrer&quot; &gt;xxx&lt;/a&gt;</code></p><pre><code></code></pre></li></ul><ul><li>æœ€åå»æ‰äº† a æ ‡ç­¾çš„ rel=â€noopener noreferrerâ€ ğŸ˜Š</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> html </tag>
            
            <tag> a </tag>
            
            <tag> referer </tag>
            
            <tag> &lt;a&gt; </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>laravel-mysql2pgsql</title>
      <link href="2020/09/16/mysql2pgsql/"/>
      <url>2020/09/16/mysql2pgsql/</url>
      
        <content type="html"><![CDATA[        <h1 id="Laravel-mysql-to-pgsql"   >          <a href="#Laravel-mysql-to-pgsql" class="heading-link"><i class="fas fa-link"></i></a><a href="#Laravel-mysql-to-pgsql" class="headerlink" title="Laravel mysql to pgsql"></a>Laravel mysql to pgsql</h1>      <p>laravel é¡¹ç›®ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯åˆ‡æ¢ driver</p><ul><li><code>php</code> å¼€å¯ <code>pdo_pgsql.so</code> <code>extension php.ini</code><ul><li>ä¸‹è½½æºç -è§£å‹-CDâ€¦</li><li><code>phpize</code></li><li>æ‰§è¡Œ <code>./configuration with-php-config=php-config</code></li><li><code>make &amp;&amp; make install</code></li><li><code>vim php.ini extensions pdo_pgsql</code></li></ul></li><li>æ—¶åŒºé—®é¢˜<ul><li>ä½¿ç”¨ å·¥å…·ä» <code>mysql</code> å¯¼å…¥åˆ° <code>pgsql</code> çš„æ•°æ®å­˜åœ¨æ—¶åŒº ä¾‹å¦‚: <code>2020-08-19 19:00:12+08</code></li><li>éœ€è¦ä¿®æ”¹æ‰€æœ‰ <code>Model</code> çš„ <code>dateFormat</code></li><li><code>protected $dateFormat = &#39;Y-m-d H:i:sP&#39;;</code></li><li><code>model-&gt;save()</code>: è‡ªåŠ¨æ›´æ–°æ—¶é—´é€»è¾‘ <code>freshTimestamp()</code></li><li>æ•°æ®æŸ¥è¯¢æ¸²æŸ“  <code>serializeDate()</code></li><li><code>Carbon</code> ç±»çš„ä½¿ç”¨ &amp;&amp; <span class="exturl"><a class="exturl__link"   href="https://www.php.net/manual/en/datetime.construct.php" >Datetime</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li>æ‰©å±•phpä¸­çš„å…¶ä»–æ—¶åŒºæ ¼å¼: <a href="https://www.php.net/manual/zh/function.date.php"><code>e</code>/<code>O</code>/<code>P</code>/<code>T</code>/<code>Z</code></a> ç­‰å«ä¹‰</li><li>ç›¸å…³ä»£ç <span id="more"></span><figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$timestamps</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$dateFormat</span> = <span class="string">&quot;Y-m-d H:i:sP&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$dates</span> = [<span class="string">&#x27;deleted_at&#x27;</span>,<span class="string">&quot;updated_at&quot;</span>,<span class="string">&quot;created_at&quot;</span>];</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">freshTimestamp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> date(<span class="keyword">$this</span>-&gt;dateFormat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸ºæ•°ç»„ / JSON åºåˆ—åŒ–å‡†å¤‡æ—¥æœŸã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> DateTimeInterface $date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serializeDate</span>(<span class="params">DateTimeInterface <span class="variable">$date</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// é»˜è®¤æ—¶åŒº</span></span><br><span class="line">        <span class="comment">// $timezone = new DateTimeZone(date_default_timezone_get());</span></span><br><span class="line">        <span class="comment">// $val-&gt;setTimezone($timezone);</span></span><br><span class="line">        <span class="comment">// return $val-&gt;format(&#x27;Y-m-d H:i:s&#x27;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$date</span>-&gt;format(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// - **èµ°è¿‡çš„å¼¯è·¯**</span></span><br><span class="line"><span class="comment">// - è‡ªå®šä¹‰ `Model` çš„ `asDatetime()` / `get-DATEFIELD-Attribute()`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    protected function getCreatedAtAttribute($value)&#123;</span></span><br><span class="line"><span class="comment">//        return  &quot;2020-04-15 08:30:04+08:00&quot;;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    protected function getUpdatedAtAttribute($value)&#123;</span></span><br><span class="line"><span class="comment">//        return &quot;2020-04-15 08:30:04+08:00&quot;;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    protected function asDateTime($value)</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        $ts = explode(&quot;+&quot;, $value);</span></span><br><span class="line"><span class="comment">//        var_dump($ts);</span></span><br><span class="line"><span class="comment">//        if (count($ts) &gt; 1) &#123;</span></span><br><span class="line"><span class="comment">//            return \Carbon\Carbon::rawCreateFromFormat(&#x27;Y-m-d H:i:sP&#x27;, &quot;2020-04-15 08:30:04+08:00&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return \Carbon\Carbon::rawCreateFromFormat(&#x27;Y-m-d H:i:sP&#x27;, &quot;2020-04-15 08:30:04+08:00&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    public function toArray()</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        return [];</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li></ul></li></ul><p>æ“ä½œæ–¹æ¡ˆ: ç»¼åˆè€ƒè™‘åä½¿ç”¨ä¸¤æ­¥èµ°çš„æ–¹æ¡ˆ</p><ol><li><p>å…ˆè½¬æ¢ <code>dbschame.sql</code> :ä½¿ç”¨ <code>py-mysql2pgsql</code> å·¥å…·åŒ…</p> <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">oomcc:py-mysql2pgsql oom$ py-mysql2pgsql -h</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;philipsoutham&#x2F;py-mysql2pgsql</span><br><span class="line">oomcc:py-mysql2pgsql oom$ py-mysql2pgsql -f mysql2pgsql.yml</span><br></pre></td></tr></table></div></figure><p> <code>mysql2pgsql.yml</code> æ–‡ä»¶:</p> <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># a socket connection will be selected if a &#39;socket&#39; is specified</span><br><span class="line"># also &#39;localhost&#39; is a special &#39;hostname&#39; for MySQL that overrides the &#39;port&#39; option</span><br><span class="line"># and forces it to use a local socket connection</span><br><span class="line"># if tcp is chosen, you can use compression</span><br><span class="line"></span><br><span class="line">mysql:</span><br><span class="line">hostname: 127.0.0.1</span><br><span class="line">port: 33036</span><br><span class="line">username: root</span><br><span class="line">password: 123456</span><br><span class="line">database: eerrrr</span><br><span class="line">compress: false</span><br><span class="line">destination:</span><br><span class="line"># if file is given, output goes to file, else postgres</span><br><span class="line">file: .&#x2F;td.sql</span><br><span class="line">postgres:</span><br><span class="line">hostname: localhost</span><br><span class="line">port: 5432</span><br><span class="line">username: mysql2psql</span><br><span class="line">password: </span><br><span class="line">database: mysql2psql_test</span><br><span class="line"></span><br><span class="line"># if tables is given, only the listed tables will be converted.  leave empty to convert all tables.</span><br><span class="line">#only_tables:</span><br><span class="line">#- table1</span><br><span class="line">#- table2</span><br><span class="line"># if exclude_tables is given, exclude the listed tables from the conversion.</span><br><span class="line">#exclude_tables:</span><br><span class="line">#- table3</span><br><span class="line">#- table4</span><br><span class="line"></span><br><span class="line"># if supress_data is true, only the schema definition will be exported&#x2F;migrated, and not the data</span><br><span class="line">supress_data: true</span><br><span class="line"></span><br><span class="line"># if supress_ddl is true, only the data will be exported&#x2F;imported, and not the schema</span><br><span class="line">supress_ddl: false</span><br><span class="line"></span><br><span class="line"># if force_truncate is true, forces a table truncate before table loading</span><br><span class="line">force_truncate: false</span><br><span class="line"></span><br><span class="line"># if timezone is true, forces to append&#x2F;convert to UTC tzinfo mysql data</span><br><span class="line">timezone: false</span><br><span class="line"></span><br><span class="line"># if index_prefix is given, indexes will be created whith a name prefixed with index_prefix</span><br><span class="line">index_pre**fix:** idx_</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li></ol><ol start="2"><li><p>å†å¯¼å…¥æ•°æ®: ä½¿ç”¨ <strong>pgloader/navicate</strong>:</p><p> a): <code>navicate</code> -&gt; å·¥å…·-&gt; æ•°æ®ä¼ è¾“: å…³é—­è®¾ç½®ä¸­çš„ <code>DDLç›¸å…³é€‰é¡¹</code></p><p> b): <code>pgloader</code>: è‡ªå®šä¹‰ä¼ è¾“æ¨¡ç‰ˆ <code>pg.load</code></p><p> <code>pg.load</code> æ–‡ä»¶:</p> <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATABASE</span><br><span class="line">    FROM mysql:&#x2F;&#x2F;www:wwww@12wwww1:33036&#x2F;aaa</span><br><span class="line">    INTO pgsql:&#x2F;&#x2F;www:wwww@10wwww87:31139&#x2F;ffff</span><br><span class="line"></span><br><span class="line">    WITH include drop, create tables, create indexes, workers &#x3D; 8, concurrency &#x3D; 1</span><br><span class="line"></span><br><span class="line">ALTER SCHEMA &#39;wwwww&#39; RENAME TO &#39;public&#39;</span><br><span class="line">;</span><br></pre></td></tr></table></div></figure><p> <strong>æ‰§è¡Œæ—¥å¿—</strong>:</p> <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">oomcc:py-mysql2pgsql oom$ vim pg.load </span><br><span class="line">oomcc:py-mysql2pgsql oom$ pgloader pg.load</span><br><span class="line">2020-09-15T11:31:53.011646+01:00 LOG pgloader version &quot;3.6.2&quot;</span><br><span class="line">2020-09-15T11:31:53.013707+01:00 LOG Data errors in &#39;&#x2F;private&#x2F;tmp&#x2F;pgloader&#x2F;&#39;</span><br><span class="line">2020-09-15T11:31:53.013761+01:00 LOG Parsing commands from file #P&quot;&#x2F;Users&#x2F;oom&#x2F;Desktop&#x2F;py-mysql2pgsql&#x2F;pg.load&quot;</span><br><span class="line">2020-09-15T11:31:53.258908+01:00 LOG Migrating from #&lt;MYSQL-CONNECTION mysql:&#x2F;&#x2F;root@127.0.0.1:33036&#x2F;dns_cache_new &#123;1005ABE6E3&#125;&gt;</span><br><span class="line">2020-09-15T11:31:53.259212+01:00 LOG Migrating into #&lt;PGSQL-CONNECTION pgsql:&#x2F;&#x2F;light@10.220.171.187:31139&#x2F;cache_ms_s &#123;1005ABF393&#125;&gt;</span><br><span class="line">2020-09-15T11:32:37.324643+01:00 LOG report summary reset</span><br><span class="line">                table name     errors       rows      bytes      total time</span><br><span class="line">-----------------------------  ---------  ---------  ---------  --------------</span><br><span class="line">             fetch meta data          0         60                     0.406s</span><br><span class="line">              Create Schemas          0          0                     0.029s</span><br><span class="line">            Create SQL Types          0          0                     0.034s</span><br><span class="line">               Create tables          0         48                     2.472s</span><br><span class="line">              Set Table OIDs          0         24                     0.024s</span><br><span class="line">-----------------------------  ---------  ---------  ---------  --------------</span><br><span class="line">    public.admin_permissions          0         10     0.8 kB          0.362s</span><br><span class="line">  public.admin_operation_log          0      27832     3.8 MB          2.596s</span><br><span class="line">     public.admin_role_users          0          3     0.0 kB          0.569s</span><br><span class="line">           ... ...</span><br><span class="line">-----------------------------  ---------  ---------  ---------  --------------</span><br><span class="line">     COPY Threads Completion          0          8                    31.225s</span><br><span class="line">              Create Indexes          0         36                    35.220s</span><br><span class="line">      Index Build Completion          0         36                     2.508s</span><br><span class="line">             Reset Sequences          0         22                     0.568s</span><br><span class="line">                Primary Keys          0         24                     1.041s</span><br><span class="line">         Create Foreign Keys          0          0                     0.000s</span><br><span class="line">             Create Triggers          0         20                     0.997s</span><br><span class="line">            Install Comments          0         90                     4.185s</span><br><span class="line">-----------------------------  ---------  ---------  ---------  --------------</span><br><span class="line">           Total import time          âœ“     762609   130.7 MB       1m15.744s</span><br><span class="line">oomcc:py-mysql2pgsql oom$ </span><br></pre></td></tr></table></div></figure></li></ol>        <h2 id="Error-and-fix"   >          <a href="#Error-and-fix" class="heading-link"><i class="fas fa-link"></i></a><a href="#Error-and-fix" class="headerlink" title="Error and fix:"></a>Error and <strong>fix:</strong></h2>      <ol><li><p>message: â€œSQLSTATE[23502]: Not null violation: 7 ERROR:  null value in column &quot;id&quot; violates not-null constraint\nDETAIL:  Failing row contains (null, 12, 57, null, null, null, null). (SQL: insert into &quot;dc_view_recursion&quot; (&quot;device_id&quot;, &quot;view_id&quot;) values (57, 12), (90, 12), (91, 12), (92, 12))â€</p><p> <strong>fix:</strong> <code>è½¬æ¢å»ºè¡¨è¯­å¥ py-mysql2pgsql</code></p></li><li><p>è§£å†³mac _mysql.c:44:10: fatal error: â€˜my_config.hâ€˜ file not found</p><p> <strong>fix:</strong> <code>/usr/local/include/mysql ä¸‹æœ‰ä¸ª mysql.h æ–‡ä»¶ï¼Œè¿™ä¸ªå°±åº”è¯¥æ˜¯æˆ‘ä»¬è¦æ‰¾çš„my_config.h æ–‡ä»¶äº†å§ï¼Œcp mysql.h my_config.h ï¼Œå†æ¬¡ pip install MySQL-python</code></p></li><li><p><span class="exturl"><a class="exturl__link"   href="https://stackoverflow.com/questions/26288042/error-installing-psycopg2-library-not-found-for-lssl" >ld: library not found for -lssl</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p><p> <strong>fix:</strong> <code>env LDFLAGS=&quot;-I/usr/local/opt/openssl/include -L/usr/local/opt/openssl/lib&quot; pip install mysql-python | psycopg2</code></p></li><li><p>ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.</p><p> <strong>fix:</strong> <code>pip install -U setuptools</code></p></li><li><p>UnicodeEncodeError: â€˜latin-1â€™ codec canâ€™t encode characters in position 0-6: ordinal not in range(256)</p><p> <strong>fix:</strong> â¬‡ï¸</p></li><li><p>UnicodeDecodeError: â€˜asciiâ€™ codec canâ€™t decode byte 0xe7 in position 1: ordinal not in range(128)</p><p> <strong>fix:</strong>  <code>æ³¨é”€ç¬¬ä¸‰æ–¹åº“çš„è¡¨æ³¨é‡Šç”Ÿæˆä»£ç :/Library/Python/2.7/site-packages/py_mysql2pgsql-0.1.6-py2.7.egg/mysql2pgsql/lib/postgres_writer.py:Line 144-148</code></p></li><li><p><span class="exturl"><a class="exturl__link"   href="https://github.com/yaml/pyyaml/wiki/PyYAML-yaml.load(input)-Deprecation" >yaml.load(input) Deprecation Warning!</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p><p> <strong>fix:</strong>.  <code>æ‰‹åŠ¨ä¿®æ”¹ py-mysql2pgsql æºç ,æ·»åŠ Loader:</code></p><p> <code>self.options = load(open(config_file_path),Loader=FullLoader)</code></p><p> <code>/Library/Python/2.7/site-packages/py_mysql2pgsql-0.1.6-py2.7.egg/mysql2pgsql/lib/config.py:Line 18</code></p></li></ol><p>å…¶ä»–</p><ul><li>pgloader : å­˜åœ¨è‡ªå¢ç´¢å¼•åˆå§‹å€¼ä¸å¯¹çš„é—®é¢˜</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> laravel </tag>
            
            <tag> pgsql </tag>
            
            <tag> mysql </tag>
            
            <tag> datetime </tag>
            
            <tag> dateformat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS è§£ækeywords</title>
      <link href="2020/09/15/DNS-%E8%A7%A3%E6%9E%90keywords/"/>
      <url>2020/09/15/DNS-%E8%A7%A3%E6%9E%90keywords/</url>
      
        <content type="html"><![CDATA[        <h1 id="DNS-è§£ækeywords"   >          <a href="#DNS-è§£ækeywords" class="heading-link"><i class="fas fa-link"></i></a><a href="#DNS-è§£ækeywords" class="headerlink" title="DNS è§£ækeywords"></a>DNS è§£ækeywords</h1>      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A(Client)--&gt;B(Local DNS)</span><br></pre></td></tr></table></div></figure><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Client --&gt; hostsæ–‡ä»¶ </span><br><span class="line">--&gt; DNS Service Local Cache --&gt; DNS Server (recursioné€’å½’æŸ¥çœ‹æœ¬åœ°é…ç½®çš„è§£ææ–‡ä»¶) </span><br><span class="line">--&gt; Server Cache </span><br><span class="line">--&gt; iteration(è¿­ä»£) --&gt; æ ¹ --&gt; é¡¶çº§åŸŸåDNS --&gt; äºŒçº§åŸŸåDNSâ€¦</span><br><span class="line">æœ€ç»ˆæœ¬åœ°dnsæŸ¥çœ‹ç»“æœåè¿”å›ç»™å®¢æˆ·ç«¯</span><br></pre></td></tr></table></div></figure><blockquote><ul><li>DNS è§£æï¼Œè‹¥ç¼“å­˜å‘½ä¸­å°±ä¼šç›´æ¥è¿”å›ç¼“å­˜ç»“æœï¼Œä¸å†è¿›è¡Œé€’å½’DNSæŸ¥è¯¢</li></ul></blockquote><span id="more"></span><p><strong>ç¼“å­˜</strong></p><ul><li>DNSè§£æç¼“å­˜æ•°æ®ï¼Œåœ¨é€’å½’è·å–çœŸå® è®¿é—®IPä¹‹åæ›´æ–°</li></ul><p><strong>é€’å½’</strong></p><ul><li>ä»ç¼“å­˜æ•°æ®ä¸­æ— æ³•è·å–ç›®çš„åœ°IPï¼Œåˆ™å¼€å§‹é€’å½’æŸ¥è¯¢å„çº§åŸŸåæœåŠ¡å™¨ï¼Œè·å–æœ€ç»ˆIP<ul><li>æ ¹åŸŸåæœåŠ¡å™¨</li><li>é¡¶çº§åŸŸåæœåŠ¡å™¨</li><li><strong>æƒå¨</strong> åŸŸåæœåŠ¡å™¨</li></ul></li></ul><p><strong>æƒå¨</strong></p><ul><li>åŸŸåå¯¹åº”çš„çœŸå®IPå­˜å‚¨èŠ‚ç‚¹ï¼Œç”±æƒå¨æœåŠ¡å™¨é€‰æ‹©è¿”å›åŸŸåå¯¹åº”çš„çœŸå®ä¸”æœ€åˆé€‚çš„IP</li></ul><p><strong>Q.åŸŸååŠ«æŒ</strong></p><ul><li>å¹¶å¯¹ç»ˆç«¯ç”¨æˆ·çš„ Local DNS è¿›è¡Œç¯¡æ”¹ï¼ŒæŒ‡å‘ä¼ªé€ çš„ Local DNS ï¼Œè¿”å›é”™è¯¯çš„ IP ä¿¡æ¯</li><li>ç›‘å¬ç”¨æˆ·çš„åŸŸåè§£æè¯·æ±‚ï¼Œä¼ªé€ çš„ DNS è§£æå“åº”ä¼ é€’ç»™ç”¨æˆ·</li><li><strong>DNSç¼“å­˜æ±¡æŸ“</strong> ï¼ŒLocal DNSç¼“å­˜æ•°æ®è¢«ä¿®æ”¹äº†</li></ul><p><strong>Q.ç²¾å‡†è°ƒåº¦</strong></p><ul><li>åŒºåŸŸ</li><li>è¿è¥å•†</li></ul><blockquote><p>é™¤äº†è§£æè½¬å‘å¯¹è°ƒåº¦ç²¾å‡†æ€§å¸¦æ¥çš„å½±å“å¤–ï¼ŒLocal DNSçš„å¸ƒç½²æƒ…å†µåŒæ ·å½±å“ç€åŸŸåæ™ºèƒ½è§£æçš„ç²¾å‡†æ€§ã€‚</p></blockquote><p><strong>Q.DNSè§£ææœåŠ¡è€—æ—¶</strong></p><ul><li>DNSæœåŠ¡éƒ¨ç½²ä¸åˆç†å¯¼è‡´çš„è§£æåŸŸåè€—æ—¶</li></ul><p><strong>Q.æƒå¨æœåŠ¡æ•°æ®æ›´æ–°æ»å</strong></p><ul><li>åŸŸåIPå˜æ›´ï¼Œä¸»è¦å‘ç”Ÿåœ¨æƒå¨æœåŠ¡ä¸Šï¼ŒåŒæ­¥åˆ°å…¨ç½‘DNSç¼“å­˜å»¶è¿Ÿä¸¥é‡</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> dns </tag>
            
            <tag> ç¼“å­˜ </tag>
            
            <tag> é€’å½’ </tag>
            
            <tag> æƒå¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆè¯†å›¾æ•°æ®åº“:neo4j</title>
      <link href="2020/03/25/%E5%88%9D%E8%AF%86%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93-neo4j/"/>
      <url>2020/03/25/%E5%88%9D%E8%AF%86%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93-neo4j/</url>
      
        <content type="html"><![CDATA[        <h2 id="å›¾æ•°æ®åº“æ˜¯ä»€ä¹ˆ"   >          <a href="#å›¾æ•°æ®åº“æ˜¯ä»€ä¹ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å›¾æ•°æ®åº“æ˜¯ä»€ä¹ˆ" class="headerlink" title="å›¾æ•°æ®åº“æ˜¯ä»€ä¹ˆ"></a>å›¾æ•°æ®åº“æ˜¯ä»€ä¹ˆ</h2>      <blockquote><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå›¾æ•°æ®åº“ï¼ˆè‹±è¯­ï¼šgraph databaseï¼ŒGDBï¼‰æ˜¯ä¸€ä¸ªä½¿ç”¨å›¾ç»“æ„è¿›è¡Œè¯­ä¹‰æŸ¥è¯¢çš„æ•°æ®åº“ï¼Œå®ƒä½¿ç”¨èŠ‚ç‚¹ã€è¾¹å’Œå±æ€§æ¥è¡¨ç¤ºå’Œå­˜å‚¨æ•°æ®ã€‚</p></blockquote><blockquote><p>å›¾æ•°æ®åº“æ˜¯ä¸€ç§éå…³ç³»å‹æ•°æ®åº“ï¼Œä»¥è§£å†³ç°æœ‰å…³ç³»æ•°æ®åº“çš„å±€é™æ€§ã€‚å›¾æ¨¡å‹æ˜ç¡®åœ°åˆ—å‡ºäº†æ•°æ®èŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè€Œå…³ç³»æ¨¡å‹å’Œå…¶ä»–NoSQLæ•°æ®åº“æ¨¡å‹åˆ™é€šè¿‡éšå¼è¿æ¥æ¥é“¾æ¥æ•°æ®ã€‚å›¾æ•°æ®åº“ä»è®¾è®¡ä¸Šï¼Œå°±æ˜¯å¯ä»¥ç®€å•å¿«é€Ÿåœ°æ£€ç´¢éš¾ä»¥åœ¨å…³ç³»ç³»ç»Ÿä¸­å»ºæ¨¡çš„å¤æ‚å±‚æ¬¡ç»“æ„çš„ã€‚<br>â€“ <span class="exturl"><a class="exturl__link"   href="https://zh.wikipedia.org/wiki/%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93" >å›¾æ•°æ®åº“wiki</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p></blockquote><span id="more"></span>        <h2 id="åº”ç”¨"   >          <a href="#åº”ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2>      <ul><li>ç™¾åº¦è‡ªä¸»ç ”å‘çš„åŸç”Ÿå›¾æ•°æ®ç³»ç»Ÿï¼ˆ<span class="exturl"><a class="exturl__link"   href="https://ai.baidu.com/tech/kg/bgraph" >BGraph</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼‰ï¼Œåœ¨ç™¾åº¦çš„çŸ¥è¯†å›¾è°±ç³»ç»Ÿä¸­åº”ç”¨å’Œå®è·µå¤šå¹´ï¼Œæ”¯æ’‘æ•°ä»¥äº¿è®¡çš„å®ä½“å¹¶æ”¯æ’‘æ•°ä»¥ä¸‡è®¡çš„æŸ¥è¯¢ QPSï¼Œç”¨äºçŸ¥è¯†é—®ç­”ã€æœç´¢æ¨èå’ŒçŸ¥è¯†æ¨ç†ç­‰ã€‚</li><li><span class="exturl"><a class="exturl__link"   href="https://www.allhistory.com/relation?id=580716f70bd1be8d718b4567" >å…¨å†å²</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æŸ¥è¯¢å†å²äººç‰©çš„å…³ç³»å›¾è°±,åˆ†æä¸¤ä¸ªå†å²æ–‡åŒ–åè¯ä¹‹é—´çš„<span class="exturl"><a class="exturl__link"   href="https://www.allhistory.com/relation/atobPath?id=580716f70bd1be8d718b4567&to=590c4030977fd58037202fe8" >è”ç³»é€”å¾„</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>  <img   src="https://note.youdao.com/yws/api/personal/file/WEB922d619dc8420570c7fc57781c2db539?method=download&shareKey=2979777244337c648359ad8257d6e36a" style=""  alt=""></li></ul>        <h2 id="å¼€æºæ•°æ®åº“"   >          <a href="#å¼€æºæ•°æ®åº“" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¼€æºæ•°æ®åº“" class="headerlink" title="å¼€æºæ•°æ®åº“"></a>å¼€æºæ•°æ®åº“</h2>      <ul><li><span class="exturl"><a class="exturl__link"   href="https://hugegraph.github.io/hugegraph-doc/" >HugeGraph</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li><span class="exturl"><a class="exturl__link"   href="https://sandbox.neo4j.com/?ref=web-product-database" >Neo4j</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li>â€¦ â€¦</li></ul>        <h2 id="Neo4J"   >          <a href="#Neo4J" class="heading-link"><i class="fas fa-link"></i></a><a href="#Neo4J" class="headerlink" title="Neo4J"></a>Neo4J</h2>      <p>å¼€æºï¼Œæ”¯æŒACIDï¼Œå…·æœ‰ç”¨äºä¼ä¸šéƒ¨ç½²çš„é«˜å¯ç”¨æ€§é›†ç¾¤ï¼Œå¹¶é™„å¸¦åŸºäºWebçš„ç®¡ç†å·¥å…·ï¼ŒåŒ…æ‹¬å®Œæ•´äº‹åŠ¡æ”¯æŒå’Œå¯è§†èŠ‚ç‚¹é“¾æ¥å›¾æµè§ˆå™¨ï¼›å¯ä»¥ä½¿ç”¨å…¶å†…ç½®çš„REST Web APIæ¥å£ä»å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€è®¿é—®ï¼Œä»¥åŠä½¿ç”¨å®˜æ–¹é©±åŠ¨ç¨‹åºçš„ä¸“æœ‰Boltåè®®ï¼›æˆªè‡³2019å¹´1æœˆæœ€å—æ¬¢è¿çš„å›¾æ•°æ®åº“</p>        <h2 id="Cypher"   >          <a href="#Cypher" class="heading-link"><i class="fas fa-link"></i></a><a href="#Cypher" class="headerlink" title="Cypher"></a>Cypher</h2>      <ul><li><span class="exturl"><a class="exturl__link"   href="https://neo4j.com/docs/cypher-manual/4.0/" >Cypher4.0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> is a graph query language that is used to query the Neo4j Database. Just like you use SQL to query a MySQL database, you would use Cypher to query the Neo4j Database. </li></ul>        <h2 id="æŸ¥è¯¢ç¤ºä¾‹"   >          <a href="#æŸ¥è¯¢ç¤ºä¾‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#æŸ¥è¯¢ç¤ºä¾‹" class="headerlink" title="æŸ¥è¯¢ç¤ºä¾‹"></a>æŸ¥è¯¢ç¤ºä¾‹</h2>      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥è¯¢â€œå‘è¡Œæ—¶é—´åœ¨2010åçš„å½±ç‰‡åŠä¸å…¶å…³ç³»ä¸ºæ‰§å¯¼çš„äººç‰©ä¿¡æ¯â€</span><br><span class="line">p äººç‰©</span><br><span class="line">d å…³ç³»</span><br><span class="line">m å½±ç‰‡</span><br><span class="line"></span><br><span class="line">neo4j$ MATCH (p:Person)-[d:DIRECTED]-(m:Movie) where m.released &gt; 2010 RETURN p,d,m</span><br></pre></td></tr></table></div></figure><html><h4></h4><img style="width:auto;height:300px;" src="http://guides.neo4j.com/sandbox/movies/img/movies-after-2010.svg"/></html><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># å‰äºŒåä¸ª äººç‰©èŠ‚ç‚¹</span><br><span class="line">MATCH (p:Person) RETURN p limit 20</span><br><span class="line"># å‰äºŒåä¸ªä»»æ„ç±»å‹èŠ‚ç‚¹åŠå…¶å…³ç³»</span><br><span class="line">MATCH (n) RETURN n limit 20</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºäººç‰©é¡¶ç‚¹</span><br><span class="line">Create (p:Person &#123;name: &#39;xxx&#39;&#125;) RETURN p</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºå…³ç³»</span><br><span class="line">MATCH (p:Person), (m:Movie)</span><br><span class="line">WHERE p.name &#x3D; &quot;xxx&quot; and m.title &#x3D; &quot;Cloud Atlas&quot;</span><br><span class="line">CREATE (p)-[w:WATCHED]-&gt;(m)</span><br><span class="line">RETURN type(w)</span><br><span class="line"></span><br><span class="line"># å…³ç³»æŸ¥è¯¢</span><br><span class="line">MATCH (p:Person)-[r:REVIEWED]-(m:Movie)  return p,r,m;</span><br><span class="line">MATCH (p:Person)-[w:WATCHED]-(m:Movie) where p.name&#x3D;&quot;xxx&quot; RETURN p,w,m</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br></pre></td></tr></table></div></figure><p>æ›´å¤šæŸ¥è¯¢è¯­å¥è§ <span class="exturl"><a class="exturl__link"   href="https://neo4j.com/docs/cypher-manual/4.0/" >Cypher4.0 æ–‡æ¡£</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>]]></content>
      
      
      
        <tags>
            
            <tag> å›¾æ•°æ®åº“ </tag>
            
            <tag> neo4j </tag>
            
            <tag> Graph </tag>
            
            <tag> cyper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELK:Nginxæ—¥å¿—è®°å½•</title>
      <link href="2019/11/15/ELK-Nginx%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/"/>
      <url>2019/11/15/ELK-Nginx%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[        <h1 id="ç›®çš„"   >          <a href="#ç›®çš„" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h1>      <ul><li>ç›®çš„ï¼šéœ€è¦ç»Ÿè®¡æ¨å¹¿å¸¦æ¥çš„è½¬åŒ–æ•ˆæœ</li><li>æ€è·¯ï¼šé€šè¿‡ç»Ÿè®¡ Nginx æ—¥å¿—ï¼Œæ¥åˆ†æä¸åŒæ¸ é“å¸¦æ¥çš„è®¿é—®é‡çš„å˜åŒ–ã€‚ï¼ˆå¯èƒ½å†é€šè¿‡æ–°å¢ç”¨æˆ·æ¯”å»è®¡ç®—ä¸‹è½¬åŒ–ç‡ï¼Œä¸ç¡®å®šæ˜¯ä¸æ˜¯éœ€è¦è¿™ä¸ªå€¼ï¼‰</li></ul>        <h1 id="æŠ€æœ¯æ–¹æ¡ˆ"   >          <a href="#æŠ€æœ¯æ–¹æ¡ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#æŠ€æœ¯æ–¹æ¡ˆ" class="headerlink" title="æŠ€æœ¯æ–¹æ¡ˆ"></a>æŠ€æœ¯æ–¹æ¡ˆ</h1>      <ul><li>ä¿®æ”¹ Nginx æ—¥å¿—æ ¼å¼ä¸ºJSON ï¼Œé€šè¿‡ Qbus æ”¶é›† Nginx çš„è®¿é—®æ—¥å¿—åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚å†ä½¿ç”¨ Logstash åŒæ­¥åˆ° ES ä¸­ï¼›æ¥ç€åˆ›å»º Kibana ç´¢å¼•æŸ¥è¯¢æ¨¡æ¿ï¼Œç­›é€‰å±•ç¤ºæ•°æ®<ul><li>Qbus</li><li>Elasticsearch</li><li>Kibana</li><li>Logstash</li><li>Nginx æ—¥å¿—</li></ul></li></ul><span id="more"></span>        <h2 id="ä¿®æ”¹-Nginx-æ—¥å¿—æ ¼å¼"   >          <a href="#ä¿®æ”¹-Nginx-æ—¥å¿—æ ¼å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹-Nginx-æ—¥å¿—æ ¼å¼" class="headerlink" title="ä¿®æ”¹ Nginx æ—¥å¿—æ ¼å¼"></a>ä¿®æ”¹ Nginx æ—¥å¿—æ ¼å¼</h2>      <blockquote><p>æ—¥å¿—æ ¼å¼ä¿®æ”¹ æ˜¯ä¸ºäº† Logstash åŒæ­¥æ–¹ä¾¿ï¼Œå¯ä»¥è‡ªåŠ¨åˆ›å»ºç´¢å¼• mapping ã€‚ åœ¨Hulk å¹³å°ä¿®æ”¹é…ç½®ã€‚</p></blockquote><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">log_format logstash &#39;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#39;</span><br><span class="line">               &#39;&quot;@version&quot;:&quot;1&quot;,&#39;</span><br><span class="line">               &#39;&quot;request_id&quot;:&quot;$request_id&quot;,&#39;</span><br><span class="line">               &#39;&quot;client&quot;:&quot;$remote_addr&quot;,&#39;</span><br><span class="line">               &#39;&quot;url&quot;:&quot;$uri&quot;,&#39;</span><br><span class="line">               &#39;&quot;status&quot;:&quot;$status&quot;,&#39;</span><br><span class="line">               &#39;&quot;domain&quot;:&quot;$host&quot;,&#39;</span><br><span class="line">               &#39;&quot;host&quot;:&quot;$server_addr&quot;,&#39;</span><br><span class="line">               &#39;&quot;server_name&quot;:&quot;$server_name&quot;,&#39;</span><br><span class="line">               &#39;&quot;request&quot;:&quot;$request&quot;,&#39;</span><br><span class="line">               &#39;&quot;request_length&quot;:&quot;$request_length&quot;,&#39;</span><br><span class="line">               &#39;&quot;http_x_forwarded_for&quot;:&quot;$http_x_forwarded_for&quot;,&#39;</span><br><span class="line">               &#39;&quot;http_x_real_ip&quot;:&quot;$http_x_real_ip&quot;,&#39;</span><br><span class="line">               &#39;&quot;size&quot;:$body_bytes_sent,&#39;</span><br><span class="line">               &#39;&quot;rsp_time&quot;:$request_time,&#39;</span><br><span class="line">               &#39;&quot;referer&quot;: &quot;$http_referer&quot;,&#39;</span><br><span class="line">               &#39;&quot;ua&quot;: &quot;$http_user_agent&quot;&#39;</span><br><span class="line">&#39;&#125;&#39;;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># æ—¥å¿—å†…å®¹</span><br><span class="line"></span><br><span class="line">  $request_length       è¯·æ±‚é•¿åº¦ï¼ˆåŒ…æ‹¬è¯·æ±‚è¡Œï¼Œæ ‡é¢˜å’Œè¯·æ±‚æ­£æ–‡ï¼‰</span><br><span class="line">  $request_method       è¯·æ±‚çš„åŠ¨ä½œï¼ˆgetæˆ–è€…postï¼‰</span><br><span class="line">  $request_time         è¯·æ±‚æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½çš„è¯·æ±‚å¤„ç†æ—¶é—´ï¼ˆ1.3.9,1.2.6ï¼‰; ä»å®¢æˆ·ç«¯è¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚åç»è¿‡çš„æ—¶é—´)</span><br><span class="line">  $request_url          å®Œæ•´çš„åŸå§‹è¯·æ±‚URLï¼ˆå¸¦å‚æ•°ï¼‰  </span><br><span class="line">  $scheme               è¿”å›ç”¨çš„åè®®ï¼Œæ˜¯httpè¿˜æ˜¯https</span><br><span class="line">  $remote_addr          å®¢æˆ·ç«¯çš„åœ°å€</span><br><span class="line">  $remote_port          client port</span><br><span class="line">  $remote_user          åŸºæœ¬è®¤è¯çš„èº«ä»½</span><br><span class="line">  $server_addr          æœåŠ¡ç«¯çš„åœ°å€</span><br><span class="line">  $server_port          server port</span><br><span class="line">  $server_protocol      ä½¿ç”¨çš„httpçš„ç‰ˆæœ¬â€œHTTP&#x2F;1.0â€, â€œHTTP&#x2F;1.1â€, or â€œHTTP&#x2F;2.0â€</span><br><span class="line">  $status               å›åº”çŠ¶æ€</span><br><span class="line">  $body_bytes_sent      ç»™ä½ ä¸»ä½“å‘é€çš„å­—èŠ‚</span><br><span class="line">  $http_refrere         è¯·æ±‚çš„ä¸Šä¸ªé¡µé¢æ¥è‡³äºå“ªé‡Œ</span><br><span class="line">  $http_x_forwarded_for ä»£ç†æœåŠ¡å™¨çš„IPåœ°å€</span><br><span class="line">  $http_user_agent      æµè§ˆå™¨çš„å‹å·</span><br><span class="line">  $uri                  é™¤å»åŸŸåå’Œåè®®çš„URL</span><br><span class="line"></span><br><span class="line">  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;upstream æ¨¡å—æ‰€æ”¯æŒçš„å˜é‡&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">  $upstream_addr            å¤„ç†è¯·æ±‚çš„ä¸Šæ¸¸æœåŠ¡å™¨çš„åœ°å€</span><br><span class="line">  $upstream_cache_status    è¡¨ç¤ºæ˜¯å¦å‘½ä¸­ç¼“å­˜</span><br><span class="line">  $upstream_status          ä¸Šæ¸¸æœåŠ¡å™¨çš„å“åº”çŠ¶æ€ç </span><br><span class="line">  $upstream_response_time   ä¸Šæ¸¸æœåŠ¡å™¨çš„å“åº”æ—¶é—´ï¼Œç²¾åº¦åˆ°æ¯«ç§’</span><br><span class="line">  $upstream_http_$HEADER    HTTPçš„å¤´éƒ¨ï¼Œå¦‚upstream_http_host</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="æ—¥å¿—æ”¶é›†"   >          <a href="#æ—¥å¿—æ”¶é›†" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ—¥å¿—æ”¶é›†" class="headerlink" title="æ—¥å¿—æ”¶é›†"></a>æ—¥å¿—æ”¶é›†</h3>      <blockquote><p>Qbus æ—¥å¿—æ”¶é›†æœåŠ¡ï¼šæœ¬è´¨ä¸Šè¿˜æ˜¯ä½¿ç”¨ Logstash æ”¶é›† Nginx æ—¥å¿—æ–‡ä»¶ï¼Œå¯¼å…¥åˆ° kafka</p></blockquote><ul><li>æŒ‡å®šæ”¶é›†è·¯å¾„ï¼Œæ—¥å¿—é‡ï¼Œä¿ç•™æœŸé™</li><li>æŒ‡å®šç”Ÿäº§æœº</li><li>æŒ‡å®šæ¶ˆè´¹æœº</li></ul>        <h3 id="æ—¥å¿—åŒæ­¥åˆ°ES"   >          <a href="#æ—¥å¿—åŒæ­¥åˆ°ES" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ—¥å¿—åŒæ­¥åˆ°ES" class="headerlink" title="æ—¥å¿—åŒæ­¥åˆ°ES"></a>æ—¥å¿—åŒæ­¥åˆ°ES</h3>      <blockquote><p>ä½¿ç”¨ Logstash åŒæ­¥ï¼›kafka åš Input , ES åš Output;</p></blockquote><ul><li>logstash 2.4 -&gt; logstash 5.0 + ; é…ç½®é¡¹æœ‰ä¿®æ”¹ï¼š<span class="exturl"><a class="exturl__link"   href="https://www.elastic.co/guide/en/logstash/5.2/plugins-inputs-kafka.html" >æ–‡æ¡£</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li></ul><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@p34108v baqianxin]# cat &#x2F;home&#x2F;logstash&#x2F;jiagu_nginx_log.conf </span><br><span class="line">input &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        bootstrap_servers &#x3D;&gt; &quot;10.209.xxx.xxx:xxxxx&quot;</span><br><span class="line">        group_id &#x3D;&gt; &quot;jiagu_web_log_es&quot;</span><br><span class="line">        topics &#x3D;&gt; [&quot;jiagu-web-nginx&quot;]</span><br><span class="line">        codec &#x3D;&gt; json &#123;  charset &#x3D;&gt; &quot;GB2312&quot;&#125;</span><br><span class="line">        consumer_threads &#x3D;&gt; 6  # number (optional)ï¼Œ default: 1</span><br><span class="line">        decorate_events &#x3D;&gt; false # boolean (optional)ï¼Œ default: false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">      convert &#x3D;&gt; [ &quot;status&quot;,&quot;integer&quot; ]</span><br><span class="line">      convert &#x3D;&gt; [ &quot;size&quot;,&quot;integer&quot; ]</span><br><span class="line">      convert &#x3D;&gt; [ &quot;rsp_time&quot;,&quot;float&quot;]</span><br><span class="line">      convert &#x3D;&gt; [ &quot;upstreatime&quot;,&quot;float&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if [client] !&#x3D; &quot;-&quot; &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            source &#x3D;&gt; &quot;client&quot;</span><br><span class="line">            target &#x3D;&gt; &quot;geoip&quot;</span><br><span class="line">            add_field &#x3D;&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][longitude]&#125;&quot; ]</span><br><span class="line">            add_field &#x3D;&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][latitude]&#125;&quot;  ]</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            convert &#x3D;&gt; [ &quot;[geoip][coordinates]&quot;, &quot;float&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts &#x3D;&gt; [&quot;10.216.xxx.xxx:xxxxx&quot;]</span><br><span class="line">        index &#x3D;&gt; &quot;jiagu_nginx_log_%&#123;+YYYY.MM&#125;&quot;</span><br><span class="line">        document_type &#x3D;&gt; &quot;nginx_log&quot;</span><br><span class="line">        user &#x3D;&gt; &quot;pxxxmgdxxcxxxxx_w&quot;</span><br><span class="line">        password &#x3D;&gt; &quot;xxxxxxxxxxxx&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="Kibana-ç­›é€‰å±•ç¤º"   >          <a href="#Kibana-ç­›é€‰å±•ç¤º" class="heading-link"><i class="fas fa-link"></i></a><a href="#Kibana-ç­›é€‰å±•ç¤º" class="headerlink" title="Kibana ç­›é€‰å±•ç¤º"></a>Kibana ç­›é€‰å±•ç¤º</h3>      <ul><li>æŒ‰ç…§æ¥æºIP è½¬æ¢ä¸ºåæ ‡ä¿¡æ¯ç»Ÿè®¡åŒºåŸŸçƒ­åŠ›å›¾</li><li>æŒ‰ç…§è®¿é—®åœ°å€ ç»Ÿè®¡è®¿é—®é‡æœ€å¤§çš„æ¥å£æˆ–é¡µé¢</li><li>æŒ‰ç…§æ¯å°æ—¶æ—¥å¿—é‡æ¥åˆ¤æ–­é«˜å³°æœŸå‡ºç°æƒ…å†µ</li><li>â€¦â€¦.</li></ul><blockquote><p>åˆ›å»ºæŸ¥è¯¢ç´¢å¼•ï¼›å…·ä½“ä½¿ç”¨æŸ¥é˜… (kibana å®˜æ–¹æ–‡æ¡£)[<span class="exturl"><a class="exturl__link"   href="https://www.elastic.co/guide/en/kibana/index.html]" >https://www.elastic.co/guide/en/kibana/index.html]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p></blockquote>        <h2 id="é—®é¢˜è®°å½•"   >          <a href="#é—®é¢˜è®°å½•" class="heading-link"><i class="fas fa-link"></i></a><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2>      <p>é—®é¢˜1ï¼šinput-kafka é…ç½®é¡¹é”™è¯¯</p><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[baqianxin@p34108v ~]$ &#x2F;usr&#x2F;share&#x2F;logstash&#x2F;bin&#x2F;logstash -f ~&#x2F;jiagu_nginx_log.conf </span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME&#x2F;config or &#x2F;etc&#x2F;logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path &#x2F;usr&#x2F;share&#x2F;logstash&#x2F;config&#x2F;log4j2.properties. Using default config which logs to console</span><br><span class="line">14:46:04.961 [main] FATAL logstash.runner - An unexpected error occurred! &#123;:error&#x3D;&gt;#&lt;ArgumentError:</span><br><span class="line"> Path &quot;&#x2F;usr&#x2F;share&#x2F;logstash&#x2F;data&quot; must be a writable directory. </span><br><span class="line"> It is not writable.&gt;,</span><br><span class="line"> ....</span><br><span class="line"></span><br><span class="line">[logstash@p34108v baqianxin]$ &#x2F;usr&#x2F;share&#x2F;logstash&#x2F;bin&#x2F;logstash -f  &#x2F;home&#x2F;baqianxin&#x2F;jiagu_nginx_log.conf </span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME&#x2F;config or &#x2F;etc&#x2F;logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path &#x2F;usr&#x2F;share&#x2F;logstash&#x2F;config&#x2F;log4j2.properties. Using default config which logs to console</span><br><span class="line">14:53:39.151 [LogStash::Runner] INFO  logstash.agent - No persistent UUID file found. Generating new UUID &#123;:uuid&#x3D;&gt;&quot;72c79b50-3410-4474-bd70-a4a5d003d95e&quot;, :path&#x3D;&gt;&quot;&#x2F;usr&#x2F;share&#x2F;logstash&#x2F;data&#x2F;uuid&quot;&#125;</span><br><span class="line">14:53:39.264 [LogStash::Runner] INFO  logstash.agent - No config files found in path &#123;:path&#x3D;&gt;&quot;&#x2F;home&#x2F;baqianxin&#x2F;jiagu_nginx_log.conf&quot;&#125;</span><br><span class="line">14:53:39.269 [LogStash::Runner] ERROR logstash.agent - failed to fetch pipeline configuration &#123;:message&#x3D;&gt;&quot;No config files found: &#x2F;home&#x2F;baqianxin&#x2F;jiagu_nginx_log.conf. Can you make sure this path is a logstash config file?&quot;&#125;</span><br><span class="line"></span><br><span class="line">è§£å†³ï¼šlogstash5.0å‡çº§ä¹‹åé…ç½®é¡¹ä¿®æ”¹äº†</span><br><span class="line"></span><br></pre></td></tr></table></div></figure><p>é—®é¢˜2ï¼šlogstash å¸¸è§è‡ªå®šä¹‰ç´¢å¼•æ¨¡æ¿ï¼Œéœ€è¦æ ¹æ®ç‰ˆæœ¬ä¿®æ”¹æ¨¡æ¿å†…å®¹</p><figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;template&quot;</span> <span class="string">:</span> <span class="string">&quot;jiagu_nginx_log-*&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> <span class="string">:</span> <span class="number">50001</span>,</span><br><span class="line">  <span class="string">&quot;settings&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">    <span class="string">&quot;index.refresh_interval&quot;</span> <span class="string">:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">    <span class="string">&quot;_default_&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">      <span class="string">/*</span> <span class="string">***_all</span> <span class="string">å†6.0è¢«åºŸå¼ƒ***</span> <span class="string">*/</span></span><br><span class="line">      <span class="string">&quot;_all&quot;</span> <span class="string">:</span> &#123;<span class="string">&quot;enabled&quot;</span> <span class="string">:</span> <span class="literal">true</span>, <span class="string">&quot;norms&quot;</span> <span class="string">:</span> <span class="literal">false</span>&#125;,</span><br><span class="line">      <span class="string">&quot;dynamic_templates&quot;</span> <span class="string">:</span> [ &#123;</span><br><span class="line">        <span class="string">&quot;message_field&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">          <span class="string">&quot;path_match&quot;</span> <span class="string">:</span> <span class="string">&quot;message&quot;</span>,</span><br><span class="line">          <span class="string">&quot;match_mapping_type&quot;</span> <span class="string">:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">          <span class="string">&quot;mapping&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span> <span class="string">:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="string">&quot;norms&quot;</span> <span class="string">:</span> <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;string_fields&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span> <span class="string">:</span> <span class="string">&quot;*&quot;</span>,</span><br><span class="line">          <span class="string">&quot;match_mapping_type&quot;</span> <span class="string">:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">          <span class="string">&quot;mapping&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span> <span class="string">:</span> <span class="string">&quot;text&quot;</span>, <span class="string">&quot;norms&quot;</span> <span class="string">:</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;fields&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">              <span class="string">&quot;keyword&quot;</span> <span class="string">:</span> &#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; ],</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">         <span class="string">/*</span> <span class="string">***include_in_all</span> <span class="string">å†6.0è¢«åºŸå¼ƒ***</span> <span class="string">*/</span></span><br><span class="line">        <span class="string">&quot;@timestamp&quot;</span><span class="string">:</span> &#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;date&quot;</span>, <span class="attr">&quot;include_in_all&quot;:</span> <span class="literal">false</span> &#125;,</span><br><span class="line">        <span class="string">&quot;@version&quot;</span><span class="string">:</span> &#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;include_in_all&quot;:</span> <span class="literal">false</span> &#125;,</span><br><span class="line">        <span class="string">&quot;geoip&quot;</span>  <span class="string">:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;dynamic&quot;:</span> <span class="literal">true</span>,</span><br><span class="line">          <span class="string">&quot;properties&quot;</span> <span class="string">:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;ip&quot;:</span> &#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;ip&quot;</span> &#125;,</span><br><span class="line">            <span class="string">&quot;location&quot;</span> <span class="string">:</span> &#123; <span class="string">&quot;type&quot;</span> <span class="string">:</span> <span class="string">&quot;geo_point&quot;</span> &#125;,</span><br><span class="line">            <span class="string">&quot;latitude&quot;</span> <span class="string">:</span> &#123; <span class="string">&quot;type&quot;</span> <span class="string">:</span> <span class="string">&quot;half_float&quot;</span> &#125;,</span><br><span class="line">            <span class="string">&quot;longitude&quot;</span> <span class="string">:</span> &#123; <span class="string">&quot;type&quot;</span> <span class="string">:</span> <span class="string">&quot;half_float&quot;</span> &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>]]></content>
      
      
      
        <tags>
            
            <tag> es </tag>
            
            <tag> nginx </tag>
            
            <tag> log </tag>
            
            <tag> logstash </tag>
            
            <tag> kafka </tag>
            
            <tag> kibana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker ä½¿ç”¨gosuåˆ‡æ¢ç”¨æˆ·</title>
      <link href="2019/11/15/Docker-%E4%BD%BF%E7%94%A8gosu%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7/"/>
      <url>2019/11/15/Docker-%E4%BD%BF%E7%94%A8gosu%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7/</url>
      
        <content type="html"><![CDATA[        <h1 id="å®¹å™¨å¯åŠ¨æ—¶åˆ‡æ¢ç”¨æˆ·gosuæ‰§è¡Œè„šæœ¬"   >          <a href="#å®¹å™¨å¯åŠ¨æ—¶åˆ‡æ¢ç”¨æˆ·gosuæ‰§è¡Œè„šæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®¹å™¨å¯åŠ¨æ—¶åˆ‡æ¢ç”¨æˆ·gosuæ‰§è¡Œè„šæœ¬" class="headerlink" title="å®¹å™¨å¯åŠ¨æ—¶åˆ‡æ¢ç”¨æˆ·gosuæ‰§è¡Œè„šæœ¬"></a>å®¹å™¨å¯åŠ¨æ—¶åˆ‡æ¢ç”¨æˆ·gosuæ‰§è¡Œè„šæœ¬</h1>              <h2 id="é—®é¢˜"   >          <a href="#é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2>      <p>æƒ³åœ¨å°ç»„å†…éƒ¨æ¨ä¸€ä¸‹ä»£ç æ£€æŸ¥å·¥å…·Sonarï¼Œç”³è¯·äº†å®¹å™¨ç©ºé—´ç”¨äºéƒ¨ç½²ã€‚åœ¨è‡ªå·±æœ¬åœ°ç¼–è¯‘é•œåƒä¹‹åæ¨é€åˆ°å…¬å¸é•œåƒæºä¹‹åï¼Œå‘ç°æ‹‰å–åå¯åŠ¨å®¹å™¨å¤±è´¥äº†ï¼šæ£€æŸ¥è¾“å‡ºæ—¥å¿—</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: don<span class="string">&#x27;t run elasticsearch as root.</span></span><br><span class="line"><span class="string">        at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:94)</span></span><br><span class="line"><span class="string">        at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:160)</span></span><br><span class="line"><span class="string">        at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:286)</span></span><br><span class="line"><span class="string">        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:35)</span></span><br></pre></td></tr></table></div></figure><p>è¿™å°±å¥‡æ€ªäº†ï¼Œæœ¬åœ°æ„å»ºçš„é•œåƒï¼Œè¿è¡Œéƒ½æ˜¯æ­£å¸¸çš„å•Šï¼›éš¾é“å…¬å¸å®¹å™¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™ä¼šå¼ºåˆ¶ä»¥rootè´¦æˆ·è¿è¡Œï¼Ÿ</p>        <h2 id="æ’æŸ¥"   >          <a href="#æ’æŸ¥" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2>      <blockquote><p>æœ¬åœ°æ„å»ºé•œåƒçš„æ—¶å€™ä¿®æ”¹ ENDPOINT è„šæœ¬ <code>run.sh</code> ï¼›è¾“å‡ºå½“å‰æ‰§è¡Œç”¨æˆ· whoami ;ç¡®å®æ˜¯  <code>root</code></p></blockquote>        <h3 id="å°è¯•1"   >          <a href="#å°è¯•1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å°è¯•1" class="headerlink" title="å°è¯•1"></a>å°è¯•1</h3>      <figure class="highlight dockerfile"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‰ç½®åˆ‡æ¢ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">USER</span> sonarqube</span><br><span class="line">ENDPOINT [<span class="string">&quot;run.sh&quot;</span>]</span><br><span class="line"><span class="comment"># æ¨é€ï¼Œéƒ¨ç½²è¿˜æ˜¯æŠ¥é”™ ES æ— æ³•ä½¿ç”¨ root è´¦æˆ·å¯åŠ¨</span></span><br></pre></td></tr></table></div></figure>        <h3 id="å°è¯•2"   >          <a href="#å°è¯•2" class="heading-link"><i class="fas fa-link"></i></a><a href="#å°è¯•2" class="headerlink" title="å°è¯•2"></a>å°è¯•2</h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ENDPOINT</span></span><br><span class="line"></span><br><span class="line">ENDPOINT su - sonarqube -s <span class="string">&quot;./run.sh&quot;</span></span><br><span class="line"><span class="comment"># æ¨é€ éƒ¨ç½²è¿˜æ˜¯é”™è¯¯ï¼š ç¯å¢ƒå˜é‡ï¼Œè´¦æˆ·ç›®å½•/home/sonarqube(æœ¬æ¥å°±æ²¡åˆ›å»ºè´¦æˆ·ç›®å½•)éƒ½æ‰¾ä¸åˆ°äº†</span></span><br><span class="line"> </span><br></pre></td></tr></table></div></figure>        <h3 id="å°è¯•3ã€âˆšã€‘"   >          <a href="#å°è¯•3ã€âˆšã€‘" class="heading-link"><i class="fas fa-link"></i></a><a href="#å°è¯•3ã€âˆšã€‘" class="headerlink" title="å°è¯•3ã€âˆšã€‘"></a>å°è¯•3ã€âˆšã€‘</h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹é•œåƒ æ·»åŠ  gosu / su-exec (sonarqube å®˜æ–¹è„šæœ¬æœ‰è¿™ä¸ª)</span></span><br><span class="line">RUN apt update &amp;&amp; apt install gosu -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ—¶ä¿®æ”¹ run.sh è„šæœ¬</span></span><br><span class="line"><span class="built_in">exec</span> gosu sonarqube <span class="string">&quot;<span class="variable">$cmd</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨é€&amp;å¯åŠ¨ï¼ŒOK</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>]]></content>
      
      
      
        <tags>
            
            <tag> es </tag>
            
            <tag> docker </tag>
            
            <tag> gosu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go:Webæ¥å£å®æ—¶é™æµ</title>
      <link href="2019/09/15/Go-Web%E6%8E%A5%E5%8F%A3%E5%AE%9E%E6%97%B6%E9%99%90%E6%B5%81/"/>
      <url>2019/09/15/Go-Web%E6%8E%A5%E5%8F%A3%E5%AE%9E%E6%97%B6%E9%99%90%E6%B5%81/</url>
      
        <content type="html"><![CDATA[        <h1 id="Golang-æ¥å£å®æ—¶é™æµåŠŸèƒ½"   >          <a href="#Golang-æ¥å£å®æ—¶é™æµåŠŸèƒ½" class="heading-link"><i class="fas fa-link"></i></a><a href="#Golang-æ¥å£å®æ—¶é™æµåŠŸèƒ½" class="headerlink" title="Golang æ¥å£å®æ—¶é™æµåŠŸèƒ½"></a>Golang æ¥å£å®æ—¶é™æµåŠŸèƒ½</h1>              <h2 id="å®ç°éœ€æ±‚"   >          <a href="#å®ç°éœ€æ±‚" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°éœ€æ±‚" class="headerlink" title="å®ç°éœ€æ±‚"></a>å®ç°éœ€æ±‚</h2>      <p> å¯¹äºåŒä¸€IPï¼ŒåŒä¸€APPåŒ…åçš„è¯·æ±‚ï¼Œæ¯å°æ—¶åªå…è®¸100æ¬¡</p>        <h2 id="æ–¹æ¡ˆé€»è¾‘"   >          <a href="#æ–¹æ¡ˆé€»è¾‘" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ¡ˆé€»è¾‘" class="headerlink" title="æ–¹æ¡ˆé€»è¾‘"></a>æ–¹æ¡ˆé€»è¾‘</h2>      <p> 1.è‡ªå®šä¹‰é™æµä¸­é—´ä»¶ï¼Œå¯¹éœ€è¦é™æµçš„æ¥å£åšç›‘å¬ </p><p> 2.ä½¿ç”¨æŒ‡å®šå‚æ•°ç”Ÿæˆå”¯ä¸€Key,è®°å½•è¯·æ±‚é¢‘ç‡</p><p> 3.è‹¥è¯·æ±‚æ—¶é—´è¶…è¿‡keyçš„æœ‰æ•ˆæ—¶é—´åˆ™é‡æ–°è®¡æ•°ï¼ˆï¼æ˜¯å¦è§¦å‘æƒ©ç½šæ“ä½œï¼Œæ›´æ–°æœ‰æ•ˆæ—¶é—´ä¸º2å°æ—¶ï¼‰</p><p> 4.å¤æ‚é€»è¾‘-ç»“åˆä¸šåŠ¡æ•°æ®é™æµ-æŒ‡å®šè®¾å¤‡ID|æŒ‡å®šâ€¦</p>        <h3 id="ä»£ç "   >          <a href="#ä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3>      <span id="more"></span><figure class="highlight golang"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨</span></span><br><span class="line">mux.Use(middleware.LimitRate)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æµä¸­é—´ä»¶</span></span><br><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto/md5&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/garyburd/redigo/redis&quot;</span></span><br><span class="line"><span class="string">&quot;jiagu-user-service/internal/captcha/common&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestLimitService <span class="keyword">struct</span> &#123;</span><br><span class="line">Interval <span class="keyword">int</span></span><br><span class="line">MaxCount <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è¿‡æœŸæ—¶é—´ è®¾ç½®é¢‘ç‡æ•°å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRequestLimitService</span><span class="params">(interval <span class="keyword">int</span>, maxCnt <span class="keyword">int</span>)</span> *<span class="title">RequestLimitService</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> common.IsDev() &#123;</span><br><span class="line">interval = interval / <span class="number">10</span></span><br><span class="line">maxCnt = maxCnt / <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line">reqLimit := &amp;RequestLimitService&#123;</span><br><span class="line">Interval: interval,</span><br><span class="line">MaxCount: maxCnt,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> reqLimit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(reqLimit *RequestLimitService)</span> <span class="title">IsAvailable</span><span class="params">(r *http.Request)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="comment">// è·å–å¿…è¦çš„éªŒè¯å‚æ•°// IP  // pn  // path /api/v1/auth</span></span><br><span class="line">_ = r.ParseForm()</span><br><span class="line">ip := r.RemoteAddr</span><br><span class="line">pn := r.Form.Get(<span class="string">&quot;pn&quot;</span>)</span><br><span class="line">path := r.RequestURI</span><br><span class="line"><span class="keyword">if</span> path == common.API_PATH_V1_AUTH &#123;</span><br><span class="line">limitRateKey := Md5V(ip + pn)</span><br><span class="line">c := reqLimit.GetLimitCountCache(common.REDIS_LIMIT_RATE_PREFIX + limitRateKey)</span><br><span class="line"><span class="keyword">return</span> c &lt; reqLimit.MaxCount</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(reqLimit *RequestLimitService)</span> <span class="title">GetLimitCountCache</span><span class="params">(limitRateKeyCount <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">redisCw := RedisW.Get()</span><br><span class="line">redisCr := RedisW.Get()</span><br><span class="line"><span class="keyword">defer</span> redisCr.Close()</span><br><span class="line"><span class="keyword">defer</span> redisCw.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = <span class="number">1</span></span><br><span class="line"><span class="comment">//æ£€æŸ¥Key å­˜åœ¨ä¸å¦</span></span><br><span class="line">isKeyEx, err := redis.Bool(redisCr.Do(<span class="string">&quot;EXISTS&quot;</span>, limitRateKeyCount))</span><br><span class="line"></span><br><span class="line">CheckErr(err, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> isKeyEx &#123;</span><br><span class="line">_, _ = redisCw.Do(<span class="string">&quot;INCR&quot;</span>, limitRateKeyCount)</span><br><span class="line">c, _ = redis.Int(redisCr.Do(<span class="string">&quot;GET&quot;</span>, limitRateKeyCount))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">_, err = redisCw.Do(<span class="string">&quot;SET&quot;</span>, limitRateKeyCount, <span class="number">1</span>, <span class="string">&quot;EX&quot;</span>, reqLimit.Interval)</span><br><span class="line">CheckErr(err, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> RequestLimit = NewRequestLimitService(common.REDIS_LIMIT_RATE_EXPIRE, common.API_LIMIT_RATE_NUM)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Md5V</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">h := md5.New()</span><br><span class="line">h.Write([]<span class="keyword">byte</span>(str))</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(h.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LimitRate</span><span class="params">(next http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> RequestLimit.IsAvailable(r) &#123;</span><br><span class="line">next.ServeHTTP(w, r)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">http.Error(w, http.StatusText(http.StatusTooManyRequests), http.StatusTooManyRequests)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> API </tag>
            
            <tag> LimitRate </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TensorFlow:é¸¢å°¾èŠ±å“ç§åˆ†ædemo</title>
      <link href="2019/09/15/TensorFlow-%E9%B8%A2%E5%B0%BE%E8%8A%B1%E5%93%81%E7%A7%8D%E5%88%86%E6%9E%90demo/"/>
      <url>2019/09/15/TensorFlow-%E9%B8%A2%E5%B0%BE%E8%8A%B1%E5%93%81%E7%A7%8D%E5%88%86%E6%9E%90demo/</url>
      
        <content type="html"><![CDATA[        <h2 id="è¿è¡Œæ•ˆæœ"   >          <a href="#è¿è¡Œæ•ˆæœ" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¿è¡Œæ•ˆæœ" class="headerlink" title="è¿è¡Œæ•ˆæœ"></a>è¿è¡Œæ•ˆæœ</h2>      <p><img src="https://note.youdao.com/yws/public/resource/1f52c84118d87ca95bb96cf11951ce88/xmlnote/DEE9C090352A4BBF8281CA269958696D/8343" alt=""></p><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@433ad0b9b2e7:&#x2F;usr&#x2F;src&#x2F;app# python train2.py </span><br><span class="line">Loss test: 1.3583741188049316</span><br><span class="line">Step: 0, Initial Loss: 1.3583741188049316</span><br><span class="line">Step: 1,         Loss: 1.2449184656143188</span><br><span class="line">Epoch 000: Loss: 1.061, Accuracy: 46.667%</span><br><span class="line">Epoch 050: Loss: 0.418, Accuracy: 82.500%</span><br><span class="line">Epoch 100: Loss: 0.307, Accuracy: 94.167%</span><br><span class="line">Epoch 150: Loss: 0.221, Accuracy: 97.500%</span><br><span class="line">Epoch 200: Loss: 0.162, Accuracy: 96.667%</span><br><span class="line">Test set accuracy: 96.667%</span><br><span class="line">root@433ad0b9b2e7:&#x2F;usr&#x2F;src&#x2F;app# </span><br><span class="line">root@433ad0b9b2e7:&#x2F;usr&#x2F;src&#x2F;app# python train2_test.py </span><br><span class="line">Example 0 prediction: Iris setosa (98.3%)</span><br><span class="line">Example 1 prediction: Iris versicolor (82.5%)</span><br><span class="line">Example 2 prediction: Iris virginica (75.2%)</span><br><span class="line">root@433ad0b9b2e7:&#x2F;usr&#x2F;src&#x2F;app# </span><br></pre></td></tr></table></div></figure>        <h2 id="è¿è¡Œç¯å¢ƒ"   >          <a href="#è¿è¡Œç¯å¢ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¿è¡Œç¯å¢ƒ" class="headerlink" title="è¿è¡Œç¯å¢ƒ"></a>è¿è¡Œç¯å¢ƒ</h2>      <ul><li>Python:3.7.4</li><li>TensorFlow:1.14.0</li><li>Matplotlib</li><li>æ•°æ®æ¥æºï¼š<ul><li>è®­ç»ƒ  <span class="exturl"><a class="exturl__link"   href="http://download.tensorflow.org/data/iris_training.csv" >http://download.tensorflow.org/data/iris_training.csv</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li>æµ‹è¯•  <span class="exturl"><a class="exturl__link"   href="http://download.tensorflow.org/data/iris_test.csv" >http://download.tensorflow.org/data/iris_test.csv</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li>æ£€æµ‹  <code>è‡ªå®šä¹‰</code></li></ul></li></ul>        <h2 id="å®ç°æ­¥éª¤"   >          <a href="#å®ç°æ­¥éª¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°æ­¥éª¤" class="headerlink" title="å®ç°æ­¥éª¤"></a>å®ç°æ­¥éª¤</h2>      <span id="more"></span>        <h3 id="åˆ›å»ºæ¨¡å‹"   >          <a href="#åˆ›å»ºæ¨¡å‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ›å»ºæ¨¡å‹" class="headerlink" title="åˆ›å»ºæ¨¡å‹"></a>åˆ›å»ºæ¨¡å‹</h3>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, division, print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow.contrib.eager <span class="keyword">as</span> tfe</span><br><span class="line">os.environ[<span class="string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="string">&#x27;2&#x27;</span></span><br><span class="line">tf.compat.v1.enable_eager_execution()</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;TensorFlow version: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(tf.version.VERSION))</span><br><span class="line">print(<span class="string">&quot;Eager execution: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(tf.executing_eagerly()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ç”¨äºè®­ç»ƒç”Ÿæˆé¸¢å°¾èŠ±irisè¯†åˆ«æ¨¡å‹</span></span><br><span class="line"><span class="string">@è®­ç»ƒå›¾è¡¨ï¼š./data/images/iris_*.png</span></span><br><span class="line"><span class="string">@æ¨¡å‹æ–‡ä»¶ï¼š./data/model/iris-model</span></span><br><span class="line"><span class="string">@ä½¿ç”¨ç¯å¢ƒï¼š</span></span><br><span class="line"><span class="string">    Python: 3.7.4</span></span><br><span class="line"><span class="string">    TensorFlow version: 1.14.0</span></span><br><span class="line"><span class="string">    Eager execution: True</span></span><br><span class="line"><span class="string">@ä½œè€…ï¼šbaqianxin@163.com</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># åˆ›å»ºmodel</span></span><br><span class="line"></span><br><span class="line">model = tf.keras.Sequential([</span><br><span class="line">    tf.keras.layers.Dense(<span class="number">10</span>, activation=tf.nn.relu, input_shape=(<span class="number">4</span>,)), </span><br><span class="line">    tf.keras.layers.Dense(<span class="number">10</span>, activation=tf.nn.relu),</span><br><span class="line">    tf.keras.layers.Dense(<span class="number">3</span>)</span><br><span class="line">])</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="åŠ è½½æ•°æ®"   >          <a href="#åŠ è½½æ•°æ®" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŠ è½½æ•°æ®" class="headerlink" title="åŠ è½½æ•°æ®"></a>åŠ è½½æ•°æ®</h3>      <blockquote><p>åŠ è½½çš„è¿œç«¯CSVæ•°æ®ï¼Œä½¿ç”¨tf.data.experimental.make_csv_datasetè½¬åŒ–ä¸ºDataset</p></blockquote><figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">train_dataset_url = <span class="string">&quot;http://download.tensorflow.org/data/iris_training.csv&quot;</span></span><br><span class="line"></span><br><span class="line">train_dataset_fp = tf.keras.utils.get_file(fname=os.path.basename(train_dataset_url),</span><br><span class="line">                                           origin=train_dataset_url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;Local copy of the dataset file: &#123;&#125;&quot;.format(train_dataset_fp))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># column order in CSV file</span></span><br><span class="line">column_names = [<span class="string">&#x27;sepal_length&#x27;</span>, <span class="string">&#x27;sepal_width&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;petal_length&#x27;</span>, <span class="string">&#x27;petal_width&#x27;</span>, <span class="string">&#x27;species&#x27;</span>]</span><br><span class="line"></span><br><span class="line">feature_names = column_names[:-<span class="number">1</span>]</span><br><span class="line">label_name = column_names[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;Features: &#123;&#125;&quot;.format(feature_names))</span></span><br><span class="line"><span class="comment"># print(&quot;Label: &#123;&#125;&quot;.format(label_name))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ ‡ç­¾</span></span><br><span class="line">class_names = [<span class="string">&#x27;Iris setosa&#x27;</span>, <span class="string">&#x27;Iris versicolor&#x27;</span>, <span class="string">&#x27;Iris virginica&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª tf.data.Dataset</span></span><br><span class="line">batch_size = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">train_dataset = tf.data.experimental.make_csv_dataset(</span><br><span class="line">    train_dataset_fp,</span><br><span class="line">    batch_size,</span><br><span class="line">    column_names=column_names,</span><br><span class="line">    label_name=label_name,</span><br><span class="line">    num_epochs=<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>        <h3 id="å®šä¹‰æŸå¤±å’Œæ¢¯åº¦å‡½æ•°"   >          <a href="#å®šä¹‰æŸå¤±å’Œæ¢¯åº¦å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®šä¹‰æŸå¤±å’Œæ¢¯åº¦å‡½æ•°" class="headerlink" title="å®šä¹‰æŸå¤±å’Œæ¢¯åº¦å‡½æ•°"></a>å®šä¹‰æŸå¤±å’Œæ¢¯åº¦å‡½æ•°</h3>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å®šä¹‰æŸå¤± å’Œæ¢¯åº¦å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loss</span>(<span class="params">model, x, y</span>):</span></span><br><span class="line">    y_ = model(x)</span><br><span class="line">    <span class="keyword">return</span> tf.compat.v1.losses.sparse_softmax_cross_entropy(labels=y, logits=y_)</span><br><span class="line"></span><br><span class="line">l = loss(model, features, labels)</span><br><span class="line">print(<span class="string">&quot;Loss test: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(l))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.å®šä¹‰ç”¨äºä¼˜åŒ–æ¨¡å‹çš„æ¢¯åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">grad</span>(<span class="params">model, inputs, targets</span>):</span></span><br><span class="line">    <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">        loss_value = loss(model, inputs, targets)</span><br><span class="line">    <span class="keyword">return</span> loss_value, tape.gradient(loss_value, model.trainable_variables)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="è®¾ç½®ä¼˜åŒ–å™¨ï¼Œè®¡æ•°å™¨"   >          <a href="#è®¾ç½®ä¼˜åŒ–å™¨ï¼Œè®¡æ•°å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#è®¾ç½®ä¼˜åŒ–å™¨ï¼Œè®¡æ•°å™¨" class="headerlink" title="è®¾ç½®ä¼˜åŒ–å™¨ï¼Œè®¡æ•°å™¨"></a>è®¾ç½®ä¼˜åŒ–å™¨ï¼Œè®¡æ•°å™¨</h3>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®ä¼˜åŒ–å™¨ï¼Œè®¡æ•°å™¨</span></span><br><span class="line">optimizer = tf.compat.v1.train.GradientDescentOptimizer(learning_rate=<span class="number">0.01</span>)</span><br></pre></td></tr></table></div></figure>        <h3 id="è‡ªå®šä¹‰è®­ç»ƒ"   >          <a href="#è‡ªå®šä¹‰è®­ç»ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#è‡ªå®šä¹‰è®­ç»ƒ" class="headerlink" title="è‡ªå®šä¹‰è®­ç»ƒ"></a>è‡ªå®šä¹‰è®­ç»ƒ</h3>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">train_loss_results = []</span><br><span class="line">train_accuracy_results = []</span><br><span class="line"></span><br><span class="line">num_epochs = <span class="number">201</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    epoch_loss_avg = tfe.metrics.Mean()</span><br><span class="line">    epoch_accuracy = tfe.metrics.Accuracy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Training loop - using batches of 32</span></span><br><span class="line">    <span class="keyword">for</span> x, y <span class="keyword">in</span> train_dataset:</span><br><span class="line">        <span class="comment"># Optimize the model</span></span><br><span class="line">        loss_value, grads = grad(model, x, y)</span><br><span class="line">        optimizer.apply_gradients(<span class="built_in">zip</span>(grads, model.variables),</span><br><span class="line">                                  global_step)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Track progress</span></span><br><span class="line">        epoch_loss_avg(loss_value)  <span class="comment"># add current batch loss</span></span><br><span class="line">        <span class="comment"># compare predicted label to actual label</span></span><br><span class="line">        epoch_accuracy(tf.argmax(model(x), axis=<span class="number">1</span>, output_type=tf.int32), y)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># end epoch</span></span><br><span class="line">    train_loss_results.append(epoch_loss_avg.result())</span><br><span class="line">    train_accuracy_results.append(epoch_accuracy.result())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> epoch % <span class="number">50</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">&quot;Epoch &#123;:03d&#125;: Loss: &#123;:.3f&#125;, Accuracy: &#123;:.3%&#125;&quot;</span>.<span class="built_in">format</span>(epoch,</span><br><span class="line">                                                                    epoch_loss_avg.result(),</span><br><span class="line">                                                                    epoch_accuracy.result()))</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="è®°å½•"   >          <a href="#è®°å½•" class="heading-link"><i class="fas fa-link"></i></a><a href="#è®°å½•" class="headerlink" title="è®°å½•"></a>è®°å½•</h3>      <blockquote><p>æŠŠè®­ç»ƒè¿‡ç¨‹ä¸­çš„æŸå¤±ä¸æ­£ç¡®ç‡éƒ½è®°å½•åˆ°<code>train_loss_results</code>,<code>train_accuracy_results</code>æ•°ç»„ä¸­äº†ï¼Œåœ¨é€šè¿‡pyplotè¾“å‡ºåˆ°å¯è§†åŒ–å›¾è¡¨æ–‡ä»¶</p></blockquote><figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fig, axes = plt.subplots(<span class="number">2</span>, sharex=<span class="literal">True</span>, figsize=(<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">fig.suptitle(<span class="string">&#x27;Training Metrics&#x27;</span>)</span><br><span class="line"></span><br><span class="line">axes[<span class="number">0</span>].set_ylabel(<span class="string">&quot;Loss&quot;</span>, fontsize=<span class="number">14</span>)</span><br><span class="line">axes[<span class="number">0</span>].plot(train_loss_results)</span><br><span class="line"></span><br><span class="line">axes[<span class="number">1</span>].set_ylabel(<span class="string">&quot;Accuracy&quot;</span>, fontsize=<span class="number">14</span>)</span><br><span class="line">axes[<span class="number">1</span>].set_xlabel(<span class="string">&quot;Epoch&quot;</span>, fontsize=<span class="number">14</span>)</span><br><span class="line">axes[<span class="number">1</span>].plot(train_accuracy_results)</span><br><span class="line">plt.savefig(<span class="string">&quot;./data/images/iris_loss.png&quot;</span>)</span><br></pre></td></tr></table></div></figure>        <h3 id="è·å–æµ‹è¯•æ•°æ®å¹¶æ£€æµ‹"   >          <a href="#è·å–æµ‹è¯•æ•°æ®å¹¶æ£€æµ‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#è·å–æµ‹è¯•æ•°æ®å¹¶æ£€æµ‹" class="headerlink" title="è·å–æµ‹è¯•æ•°æ®å¹¶æ£€æµ‹"></a>è·å–æµ‹è¯•æ•°æ®å¹¶æ£€æµ‹</h3>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–æ£€æµ‹æ•°æ®</span></span><br><span class="line">test_url = <span class="string">&quot;http://download.tensorflow.org/data/iris_test.csv&quot;</span></span><br><span class="line"></span><br><span class="line">test_fp = tf.keras.utils.get_file(fname=os.path.basename(test_url),</span><br><span class="line">                                  origin=test_url)</span><br><span class="line"></span><br><span class="line">test_dataset = tf.data.experimental.make_csv_dataset(</span><br><span class="line">    test_fp,</span><br><span class="line">    batch_size,</span><br><span class="line">    column_names=column_names,</span><br><span class="line">    label_name=<span class="string">&#x27;species&#x27;</span>,</span><br><span class="line">    num_epochs=<span class="number">1</span>,</span><br><span class="line">    shuffle=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># å…¶ä»–æ–¹å¼æ ¼å¼åŒ–æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack_features_vector</span>(<span class="params">features, labels</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Pack the features into a single array.&quot;&quot;&quot;</span></span><br><span class="line">    features = tf.stack(<span class="built_in">list</span>(features.values()), axis=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> features, labels</span><br><span class="line">    </span><br><span class="line">test_dataset = test_dataset.<span class="built_in">map</span>(pack_features_vector)</span><br><span class="line">test_accuracy = tfe.metrics.Accuracy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (x, y) <span class="keyword">in</span> test_dataset:</span><br><span class="line">  logits = model(x)</span><br><span class="line">  prediction = tf.argmax(logits, axis=<span class="number">1</span>, output_type=tf.int32)</span><br><span class="line">  test_accuracy(prediction, y)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Test set accuracy: &#123;:.3%&#125;&quot;</span>.<span class="built_in">format</span>(test_accuracy.result()))</span><br></pre></td></tr></table></div></figure>        <h3 id="compileå’Œä¿å­˜model"   >          <a href="#compileå’Œä¿å­˜model" class="heading-link"><i class="fas fa-link"></i></a><a href="#compileå’Œä¿å­˜model" class="headerlink" title="compileå’Œä¿å­˜model"></a>compileå’Œä¿å­˜model</h3>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># compile ç”¨äºè®¾å®šè®­ç»ƒè¿‡ç¨‹</span></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=tf.keras.optimizers.Adam(),</span><br><span class="line">                loss=tf.keras.losses.sparse_categorical_crossentropy,</span><br><span class="line">                metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line"><span class="comment"># å…¨é‡ä¿å­˜æ¨¡å‹</span></span><br><span class="line">model.save(<span class="string">&quot;./data/model/iris-model&quot;</span>)</span><br></pre></td></tr></table></div></figure>        <h3 id="ä½¿ç”¨æ¨¡å‹æ£€æµ‹æœªçŸ¥æ•°æ®train-test-py"   >          <a href="#ä½¿ç”¨æ¨¡å‹æ£€æµ‹æœªçŸ¥æ•°æ®train-test-py" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä½¿ç”¨æ¨¡å‹æ£€æµ‹æœªçŸ¥æ•°æ®train-test-py" class="headerlink" title="ä½¿ç”¨æ¨¡å‹æ£€æµ‹æœªçŸ¥æ•°æ®train_test.py"></a>ä½¿ç”¨æ¨¡å‹æ£€æµ‹æœªçŸ¥æ•°æ®<code>train_test.py</code></h3>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, division, print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow.contrib.eager <span class="keyword">as</span> tfe</span><br><span class="line">os.environ[<span class="string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="string">&#x27;2&#x27;</span></span><br><span class="line">tf.compat.v1.enable_eager_execution()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹</span></span><br><span class="line">file_path = <span class="string">&#x27;./data/model&#x27;</span></span><br><span class="line">model = tf.keras.models.load_model(file_path + <span class="string">&quot;/iris-model&quot;</span>)</span><br><span class="line"><span class="comment"># model.summary()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ ‡ç­¾</span></span><br><span class="line">class_names = [<span class="string">&#x27;Iris setosa&#x27;</span>, <span class="string">&#x27;Iris versicolor&#x27;</span>, <span class="string">&#x27;Iris virginica&#x27;</span>]</span><br><span class="line"></span><br><span class="line">predict_dataset = tf.convert_to_tensor([</span><br><span class="line">    [<span class="number">5.1</span>, <span class="number">3.3</span>, <span class="number">1.7</span>, <span class="number">0.5</span>, ],</span><br><span class="line">    [<span class="number">5.9</span>, <span class="number">3.0</span>, <span class="number">4.2</span>, <span class="number">1.5</span>, ],</span><br><span class="line">    [<span class="number">6.9</span>, <span class="number">3.1</span>, <span class="number">5.4</span>, <span class="number">2.1</span>]</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">predictions = model(predict_dataset)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, logits <span class="keyword">in</span> <span class="built_in">enumerate</span>(predictions):</span><br><span class="line">    class_idx = tf.argmax(logits).numpy()</span><br><span class="line">    p = tf.nn.softmax(logits)[class_idx]</span><br><span class="line">    name = class_names[class_idx]</span><br><span class="line">    print(<span class="string">&quot;Example &#123;&#125; prediction: &#123;&#125; (&#123;:4.1f&#125;%)&quot;</span>.<span class="built_in">format</span>(i, name, <span class="number">100</span>*p))</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h2 id="é‡åˆ°é—®é¢˜-amp-æ€è·¯"   >          <a href="#é‡åˆ°é—®é¢˜-amp-æ€è·¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#é‡åˆ°é—®é¢˜-amp-æ€è·¯" class="headerlink" title="é‡åˆ°é—®é¢˜&amp;æ€è·¯"></a>é‡åˆ°é—®é¢˜&amp;æ€è·¯</h2>      <p>ä¸å¥½æ„æ€æ²¡èƒ½åŠ›æå‡ºé—®é¢˜ï¼Œå¾ˆå¤šå‚æ•°éƒ½çœ‹ä¸æ‡‚ï¼Œåªæ˜¯æ¨¡æ‹Ÿæ“ä½œä¸€ä¸‹</p><ul><li><strong>å¤§è‡´å°±æ˜¯ç”Ÿæˆæ•°æ®é›†</strong>ï¼šå¯èƒ½æ¯”è¾ƒå¤æ‚éœ€è¦æ ¼å¼åŒ–</li><li><strong>å®šä¹‰æ ‡ç­¾</strong>ï¼šä¸€ä¸ªå¸¸é‡æ•°ç»„</li><li><strong>åˆ›å»ºæ¨¡å‹</strong>ï¼šé…ç½®å±‚æ•°åŠä¸€äº›è¾“å…¥è¾“å‡ºå‚æ•°</li><li><strong>å®šä¹‰æŸå¤±ä¸æ¢¯åº¦å‡½æ•°</strong>ï¼šç”¨æ¥æ£€æµ‹æ˜¯å¦è®­ç»ƒåˆ°ä½äº†</li><li><strong>å®šä¹‰ä¼˜åŒ–å™¨</strong>ï¼Œè®¡æ•°å™¨ï¼šåŒåæ„</li><li><strong><em>å¯ä»¥å•ä¸ªæ•°æ®æµ‹è¯•ä¸‹è¿™äº›å‚æ•°</em></strong></li><li><strong>è‡ªå®šä¹‰è®­ç»ƒæ–¹æ³•</strong>ï¼šè®°å½•ä¸‹è®­ç»ƒçš„æ¬¡æ•°ï¼Œæ¯ä¸€æ¬¡è®­ç»ƒçš„ç»“æœï¼ˆï¼‰</li><li><strong>è¾“å‡ºè®­ç»ƒæ•°æ®</strong>ï¼šå¯è§†åŒ–å¾ˆç›´ç™½è¡¨ç¤ºæ¨¡å‹å½“å‰æ•°æ®ä¸‹æ˜¯å¦è®­ç»ƒçš„åˆç†</li><li><strong><em>å†ä½¿ç”¨å‡†å¤‡å¥½çš„æµ‹è¯•æ•°æ®åœ¨è¿™ä¸ªè®­ç»ƒè¿‡çš„æ¨¡å‹ä¸Šæµ‹è¯•</em></strong></li><li><strong>ç„¶åå°±æ˜¯ä¿å­˜</strong>ï¼šæœ‰å‡ ç§ï¼Œé…ç½®ï¼Œæƒé‡ï¼Œå…¨é‡ä¿å­˜</li><li>++<strong>æœ€åå°±æ˜¯æ‹¿æœªçŸ¥æ•°æ®æ¥æ£€æµ‹ä¿å­˜çš„æ¨¡å‹æ˜¯å¦å‡†ç¡®äº†y</strong>++</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> TensorFlow </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go:WebæœåŠ¡æ—¥å¿—è®°å½•</title>
      <link href="2019/09/15/Go-Web%E6%9C%8D%E5%8A%A1%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/"/>
      <url>2019/09/15/Go-Web%E6%9C%8D%E5%8A%A1%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[        <h1 id="GoWeb-æœåŠ¡æ—¥å¿—ç®¡ç†"   >          <a href="#GoWeb-æœåŠ¡æ—¥å¿—ç®¡ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#GoWeb-æœåŠ¡æ—¥å¿—ç®¡ç†" class="headerlink" title="GoWeb æœåŠ¡æ—¥å¿—ç®¡ç†"></a>GoWeb æœåŠ¡æ—¥å¿—ç®¡ç†</h1>              <h2 id="å‰æƒ…"   >          <a href="#å‰æƒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰æƒ…" class="headerlink" title="å‰æƒ…"></a>å‰æƒ…</h2>      <p>æœ€æ–°ä½¿ç”¨ Go è¯­è¨€å¼€å‘äº†ä¸€ä¸ªæ»‘åŠ¨éªŒè¯ç  SDK çš„æœåŠ¡ç«¯ï¼Œæä¾›çš„æ¥å£éƒ½å…·å¤‡åŸºç¡€åŠŸèƒ½äº†ï¼Œä½†æ˜¯ä¸šåŠ¡é€»è¾‘æ—¥å¿—ä»¥åŠè¯·æ±‚æ—¥å¿—æ²¡æœ‰ä¸€ä¸ªå¥½çš„è®°å½•æ–¹å¼ï¼Œè€Œä¸”ä½¿ç”¨çš„å®¹å™¨æœåŠ¡ï¼Œæ¯æ¬¡å‘å¸ƒéƒ½ä¼šåˆ·æ–°å®¹å™¨ï¼Œæ–‡ä»¶ç±»çš„æ—¥å¿—éƒ½ä¼šä¸¢å¤±ã€‚å› æ­¤æŸ¥äº†ä¸€ä¸‹å¸¸è§çš„Go  Log å¤„ç†æ–¹å¼ã€‚å‘ç° logrus  åŒ…ä½¿ç”¨çš„äººä¸å°‘ï¼Œæ„Ÿè§‰ä¹Ÿå¾ˆå¥½ä½¿ç”¨æ¯•ç«Ÿå¸¦ hook ï¼ˆå¸¦é’©å­çš„éƒ½æ˜¯å·¥å…·äººâ€¦ï¼‰</p>        <h2 id="ç›®çš„"   >          <a href="#ç›®çš„" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h2>      <ul><li>è®°å½•æ‰€æœ‰è¯·æ±‚æ—¥å¿—</li><li>è®°å½•ä¸šåŠ¡é€»è¾‘å…³é”®ä¿¡æ¯</li><li>æ–¹ä¾¿æŸ¥è¯¢æ£€ç´¢åˆ†æ</li></ul>        <h2 id="å®ç°ç»†èŠ‚"   >          <a href="#å®ç°ç»†èŠ‚" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2>      <ol><li>è‡ªå®šä¹‰æ—¥å¿—æœåŠ¡ä¸­é—´ä»¶ï¼Œ</li><li>ä½¿ç”¨ ES å­˜å‚¨æ—¥å¿—æ•°æ®</li><li>è¿‡æ»¤æ¥å£æ£€æŸ¥çš„è°ƒç”¨æ—¥å¿—</li><li>ESä½¿ç”¨æ—¶é—´ç´¢å¼•</li><li>handlerè·¯ç”±ä½¿ç”¨ä¸­é—´ä»¶æ‹¦æˆªè®°å½•è¯·æ±‚æ—¥å¿—Mux.Use(m-)</li><li>é€»è¾‘æ—¥å¿—çºªå½•ä½¿ç”¨å…¨å±€Loges å¯¹è±¡</li></ol>        <h3 id="Goé¡¹ç›®-ä½¿ç”¨ES"   >          <a href="#Goé¡¹ç›®-ä½¿ç”¨ES" class="heading-link"><i class="fas fa-link"></i></a><a href="#Goé¡¹ç›®-ä½¿ç”¨ES" class="headerlink" title="Goé¡¹ç›®-ä½¿ç”¨ES"></a>Goé¡¹ç›®-ä½¿ç”¨ES</h3>              <h3 id="è‡ªå®šä¹‰æ—¥å¿—æ”¶é›†ä¸­é—´ä»¶"   >          <a href="#è‡ªå®šä¹‰æ—¥å¿—æ”¶é›†ä¸­é—´ä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#è‡ªå®šä¹‰æ—¥å¿—æ”¶é›†ä¸­é—´ä»¶" class="headerlink" title="è‡ªå®šä¹‰æ—¥å¿—æ”¶é›†ä¸­é—´ä»¶"></a>è‡ªå®šä¹‰æ—¥å¿—æ”¶é›†ä¸­é—´ä»¶</h3>      <blockquote><p> logrus    â€œgithub.com/sirupsen/logrusâ€</p></blockquote><span id="more"></span><figure class="highlight go"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Loges = logrus.New()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">InitElasticForLog()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ESæ—¥å¿—ä¸­é—´ä»¶  ç”¨äºæ”¶é›†è¯·æ±‚æ—¥å¿—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AccessLogging</span><span class="params">(f http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">_ = r.ParseForm()</span><br><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">_, _ = buf.ReadFrom(r.Body)</span><br><span class="line">logEntry := Loges.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">&quot;host&quot;</span>:         r.Host,</span><br><span class="line"><span class="string">&quot;ip&quot;</span>:           r.RemoteAddr,</span><br><span class="line"><span class="string">&quot;method&quot;</span>:       r.Method,</span><br><span class="line"><span class="string">&quot;path&quot;</span>:         r.RequestURI,</span><br><span class="line"><span class="string">&quot;query&quot;</span>:        r.URL.RawQuery,</span><br><span class="line"><span class="string">&quot;request&quot;</span>: buf.String(),</span><br><span class="line">&#125;)</span><br><span class="line">wc := &amp;ResponseWithRecorder&#123;</span><br><span class="line">ResponseWriter: w,</span><br><span class="line">statusCode:     http.StatusOK,</span><br><span class="line">body:           bytes.Buffer&#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">f.ServeHTTP(wc, r)</span><br><span class="line"><span class="keyword">if</span> !IsUnlogHost(r.Host, r.RequestURI) &#123;</span><br><span class="line"><span class="keyword">defer</span> logEntry.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>:        wc.statusCode,</span><br><span class="line"><span class="string">&quot;respone&quot;</span>: wc.body.String(),</span><br><span class="line">&#125;).Info()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure><blockquote><p>ç¬¬ä¸‰æ–¹åŒ… elastic    â€œgithub.com/olivere/elasticâ€</p></blockquote><figure class="highlight go"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">client, err := elastic.NewClient(</span><br><span class="line"></span><br><span class="line">elastic.SetURL(<span class="string">&quot;http://xx.xx.xx.xx:9029&quot;</span>),</span><br><span class="line"></span><br><span class="line">elastic.SetBasicAuth(<span class="string">&quot;writerUser&quot;</span>, <span class="string">&quot;u_pwd&quot;</span>),</span><br><span class="line"><span class="comment">// å…¶ä»–é…ç½®é¡¹</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">Loges.Panic(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="logrus-ä½¿ç”¨ES-hook"   >          <a href="#logrus-ä½¿ç”¨ES-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#logrus-ä½¿ç”¨ES-hook" class="headerlink" title="logrus ä½¿ç”¨ES-hook"></a>logrus ä½¿ç”¨ES-hook</h3>      <figure class="highlight go"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨æ—¶é—´ç´¢å¼•</span></span><br><span class="line"><span class="comment">//&quot;2006-01-02 15:04:05&quot;</span></span><br><span class="line">t := time.Now()</span><br><span class="line">date := t.Format(<span class="string">&quot;200601&quot;</span>)</span><br><span class="line">hook, err := elogrus.NewElasticHook(client, GetHost(), logrus.DebugLevel, <span class="string">&quot;YOUR_SERVER_NAME_LOG_&quot;</span>+date)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">Loges.Panic(err)</span><br><span class="line">&#125;</span><br><span class="line">Loges.AddHook(hook)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="è‡ªå®šä¹‰å“åº”æ•°æ®æ ¼å¼"   >          <a href="#è‡ªå®šä¹‰å“åº”æ•°æ®æ ¼å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#è‡ªå®šä¹‰å“åº”æ•°æ®æ ¼å¼" class="headerlink" title="è‡ªå®šä¹‰å“åº”æ•°æ®æ ¼å¼"></a>è‡ªå®šä¹‰å“åº”æ•°æ®æ ¼å¼</h3>      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type ResponseWithRecorder struct &#123;</span><br><span class="line">http.ResponseWriter</span><br><span class="line">statusCode int</span><br><span class="line">body       bytes.Buffer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (rec *ResponseWithRecorder) WriteHeader(statusCode int) &#123;</span><br><span class="line">rec.ResponseWriter.WriteHeader(statusCode)</span><br><span class="line">rec.statusCode &#x3D; statusCode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (rec *ResponseWithRecorder) Write(d []byte) (n int, err error) &#123;</span><br><span class="line">n, err &#x3D; rec.ResponseWriter.Write(d)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">rec.body.Write(d)</span><br><span class="line"></span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="æ‹¦æˆªæœåŠ¡æ£€æŸ¥çš„æ—¥å¿—è®°å½•"   >          <a href="#æ‹¦æˆªæœåŠ¡æ£€æŸ¥çš„æ—¥å¿—è®°å½•" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ‹¦æˆªæœåŠ¡æ£€æŸ¥çš„æ—¥å¿—è®°å½•" class="headerlink" title="æ‹¦æˆªæœåŠ¡æ£€æŸ¥çš„æ—¥å¿—è®°å½•"></a>æ‹¦æˆªæœåŠ¡æ£€æŸ¥çš„æ—¥å¿—è®°å½•</h3>      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if !IsUnlogHost(r.Host, r.RequestURI) &#123;</span><br><span class="line">defer logEntry.WithFields(logrus.Fields&#123;</span><br><span class="line">&quot;status&quot;:        wc.statusCode,</span><br><span class="line">&quot;respone&quot;: wc.body.String(),</span><br><span class="line">&#125;).Info()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func IsUnlogHost(h string, url string) bool &#123;</span><br><span class="line">if strings.Contains(h, &#96;lvscheck.xitong.xxx&#96;) &amp;&amp; url &#x3D;&#x3D; &quot;&#x2F;status&quot; &#123;</span><br><span class="line">return true</span><br><span class="line">&#125; else &#123;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>        <h3 id="ä¸šåŠ¡é€»è¾‘ä½¿ç”¨"   >          <a href="#ä¸šåŠ¡é€»è¾‘ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸šåŠ¡é€»è¾‘ä½¿ç”¨" class="headerlink" title="ä¸šåŠ¡é€»è¾‘ä½¿ç”¨"></a>ä¸šåŠ¡é€»è¾‘ä½¿ç”¨</h3>      <figure class="highlight go"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="æ•ˆæœ"   >          <a href="#æ•ˆæœ" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h3>      <p><img src="http:///asdasdasda.com" alt="Kibana"></p>        <h2 id="æ³¨æ„"   >          <a href="#æ³¨æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2>      <ul><li>åœ¨æ—¥å¿—ä¸­é—´ä»¶è·å–è¯·æ±‚Bodyæ—¶ å¯èƒ½å¯¼è‡´æ¥å£æœåŠ¡æ— æ³•æ­£å¸¸æ¥å—æäº¤å‚æ•°çš„é—®é¢˜:å¯ä»¥åœ¨è·å–è¯·æ±‚å‚æ•°æ—¶é¢„å…ˆä½¿ç”¨ ParseForm() <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; middleware</span><br><span class="line"></span><br><span class="line">_ &#x3D; r.ParseForm()</span><br><span class="line">buf :&#x3D; new(bytes.Buffer)</span><br><span class="line">_, _ &#x3D; buf.ReadFrom(r.Body)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; API</span><br><span class="line">req.ParseForm()</span><br><span class="line">var paramsList &#x3D; []string&#123;&quot;appId&quot;, &quot;token&quot;.....&#125;</span><br><span class="line">e, reqData :&#x3D; GetParams(req.Form, paramsList, paramsList)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> es </tag>
            
            <tag> log </tag>
            
            <tag> logrus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PythonæŠ“å–é¡µé¢æ•°æ®åˆ†è¯ç»Ÿè®¡å±•ç¤º</title>
      <link href="2019/06/18/Python%E6%8A%93%E5%8F%96%E9%A1%B5%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%88%86%E8%AF%8D%E7%BB%9F%E8%AE%A1%E5%B1%95%E7%A4%BA/"/>
      <url>2019/06/18/Python%E6%8A%93%E5%8F%96%E9%A1%B5%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%88%86%E8%AF%8D%E7%BB%9F%E8%AE%A1%E5%B1%95%E7%A4%BA/</url>
      
        <content type="html"><![CDATA[        <h1 id="PythonæŠ“å–äº¬ä¸œè¯„è®ºæ•°æ®ç”Ÿæˆè¯äº‘"   >          <a href="#PythonæŠ“å–äº¬ä¸œè¯„è®ºæ•°æ®ç”Ÿæˆè¯äº‘" class="heading-link"><i class="fas fa-link"></i></a><a href="#PythonæŠ“å–äº¬ä¸œè¯„è®ºæ•°æ®ç”Ÿæˆè¯äº‘" class="headerlink" title="PythonæŠ“å–äº¬ä¸œè¯„è®ºæ•°æ®ç”Ÿæˆè¯äº‘"></a>PythonæŠ“å–äº¬ä¸œè¯„è®ºæ•°æ®ç”Ÿæˆè¯äº‘</h1>      <blockquote><p>å‰æ:æƒ³æŠ“å–å•†å“è¯„è®ºåˆ†æå…³é”®è¯å‡ºç°é¢‘ç‡</p></blockquote><p><img   src="https://note.youdao.com/yws/api/personal/file/94251ED148A448729CFCFE6434C6EADF?method=download&shareKey=03ff9d0b39c0895dd71e91f6ecfe6c22" style=""  alt="aaa"></p>        <h2 id="å®ç°æ–¹æ¡ˆ"   >          <a href="#å®ç°æ–¹æ¡ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°æ–¹æ¡ˆ" class="headerlink" title="å®ç°æ–¹æ¡ˆ"></a>å®ç°æ–¹æ¡ˆ</h2>      <ul><li>æ‰“å¼€äº¬ä¸œSKUè¯¦æƒ…é¡µé¢ï¼ŒæŸ¥çœ‹è¯„è®ºï¼Œä¸‹ä¸€é¡µï¼ˆXHR è¯·æ±‚ï¼‰æ‰¾åˆ°è¯„è®ºæ•°æ®æ¥å£</li><li>ä½¿ç”¨åˆ°çš„Python ç»„ä»¶ï¼š<ul><li>requests,</li><li>jieba,</li><li>numpy,</li><li>pandas,</li><li>matplotlib,</li><li>PIL(Pillow)</li></ul></li></ul>        <h2 id="ç»†èŠ‚æ­¥éª¤"   >          <a href="#ç»†èŠ‚æ­¥éª¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç»†èŠ‚æ­¥éª¤" class="headerlink" title="ç»†èŠ‚æ­¥éª¤"></a>ç»†èŠ‚æ­¥éª¤</h2>      <ul><li>è¯„è®ºæ¥å£åœ°å€æ‹¼æ¥</li><li>è¿”å›æ•°æ®ä¸ºJSONPï¼Œå­—ç¬¦ä¸²æˆªå–ä¸€ä¸‹ï¼ˆå¯ä»¥è‡ªå®šä¹‰callbackå‚æ•°ï¼‰</li><li>åˆ‡åˆ†è¯</li><li>åœç”¨è¯</li><li>è¯ç»„ç»Ÿè®¡ï¼šwordDataâ€¦â€¦agg(total=â€™countâ€™)</li><li>æ•°æ®ä¿å­˜ï¼šå¯ä»¥ä½¿ç”¨å…¶ä»–é€»è¾‘å­˜æ¡£å…¥æ•°æ®åº“</li><li>è¯äº‘å›¾ç‰‡ç”Ÿæˆã€å±•ç¤º</li></ul>        <h2 id="å°é—®é¢˜"   >          <a href="#å°é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#å°é—®é¢˜" class="headerlink" title="å°é—®é¢˜"></a>å°é—®é¢˜</h2>      <ul><li>è¯·æ±‚æ•°æ®æ¥å£é¢‘ç‡é¢éœ€è¦æ§åˆ¶ ä¸è¦æ€¥ä¸è¦æ…Œ</li><li>æ–‡æœ¬è¯»å–çš„æ ¼å¼ï¼šGBK </li><li><code>wordData......agg(</code><strong>total=â€™countâ€™</strong><code>)</code></li><li>è¯äº‘å›¾ç”Ÿæˆè®¾ç½®çš„å­—ä½“ï¼šæŒ‘ä¸ªç³»ç»Ÿè‡ªå¸¦çš„ | æˆ–è€…Copyä½ çš„å­—ä½“æ–‡ä»¶åˆ°ç³»ç»Ÿå­—ä½“ç›®å½•ä¸‹<ul><li>Winï¼šsimsun.ttc  </li><li>Mac:<code>[ ~ | /System]/Libray/Fonts</code></li></ul></li></ul>        <h2 id="å®Œæ•´ä»£ç "   >          <a href="#å®Œæ•´ä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2>      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="comment"># æ•°æ®çˆ¬å–æ¨¡å—</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_comments</span>():</span></span><br><span class="line">    all_comments = <span class="string">&quot;&quot;</span></span><br><span class="line">    fetchJSON_comment = <span class="string">&quot;fetchJSON_comment9&quot;</span></span><br><span class="line">    skuID =  <span class="string">&quot;1109759&quot;</span> <span class="comment"># &quot;4093841&quot; # &quot;100004549676&quot;  #</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        url2 = <span class="built_in">str</span>(i)</span><br><span class="line">        url1c = <span class="string">&#x27;https://club.jd.com/comment/productPageComments.action?callback=&#x27;</span> + \</span><br><span class="line">            fetchJSON_comment+url2+<span class="string">&#x27;&amp;productId=&#x27;</span>+skuID+<span class="string">&#x27;&amp;score=0&amp;sortType=5&amp;page=&#x27;</span></span><br><span class="line">        url3c = <span class="string">&#x27;&amp;pageSize=10&amp;isShadowSku=0&amp;rid=0&amp;fold=1&#x27;</span></span><br><span class="line"></span><br><span class="line">        finalurlc = url1c+url2+url3c</span><br><span class="line">        xba = requests.get(finalurlc)</span><br><span class="line">        <span class="comment"># fetchJSON_comment(</span></span><br><span class="line">        print(finalurlc, xba.text[<span class="number">0</span>:<span class="built_in">len</span>(fetchJSON_comment+url2)+<span class="number">1</span>])</span><br><span class="line">        data = json.loads(xba.text[<span class="built_in">len</span>(fetchJSON_comment+url2)+<span class="number">1</span>:-<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> data[<span class="string">&#x27;comments&#x27;</span>]:</span><br><span class="line">            content = j[<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">            all_comments = all_comments+content</span><br><span class="line">        print(i, xba.text[<span class="number">0</span>:<span class="number">20</span>])</span><br><span class="line">    <span class="keyword">return</span> all_comments</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®æ¸…æ´—å¤„ç†æ¨¡å—</span></span><br><span class="line"></span><br><span class="line">xt=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data_clear</span>(<span class="params">xt</span>):</span></span><br><span class="line">    xt = get_comments()</span><br><span class="line">    sys.exit(xt)</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;[\u4e00-\u9fa5]+&#x27;</span>)</span><br><span class="line">    filedata = re.findall(pattern, xt)</span><br><span class="line">    xx = <span class="string">&#x27;&#x27;</span>.join(filedata)</span><br><span class="line">    clear = jieba.lcut(xx)   <span class="comment"># åˆ‡åˆ†è¯</span></span><br><span class="line">    cleared = pd.DataFrame(&#123;<span class="string">&#x27;keywords&#x27;</span>: clear&#125;)</span><br><span class="line">    stopwords = pd.read_csv(<span class="string">&quot;chineseStopWords.txt&quot;</span>, index_col=<span class="literal">False</span>,</span><br><span class="line">                            quoting=<span class="number">3</span>, sep=<span class="string">&quot;\t&quot;</span>, names=[<span class="string">&#x27;stopword&#x27;</span>], encoding=<span class="string">&#x27;GBK&#x27;</span>)</span><br><span class="line">    cleared = cleared[~cleared.keywords.isin(stopwords.stopword)]</span><br><span class="line">    <span class="comment"># count_words = cleared.groupby(by=[&#x27;clear&#x27;])[&#x27;clear&#x27;].agg(&#123;&quot;num&quot;: numpy.size&#125;)</span></span><br><span class="line">    count_words = cleared.groupby(<span class="string">&#x27;keywords&#x27;</span>)[<span class="string">&#x27;keywords&#x27;</span>].agg(total=<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    count_words = count_words.reset_index().sort_values(</span><br><span class="line">        by=[<span class="string">&quot;total&quot;</span>], ascending=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># df = pd.DataFrame(count_words)</span></span><br><span class="line">    <span class="comment"># if os.path.exists(&quot;count_words.csv&quot;):</span></span><br><span class="line">    <span class="comment">#     os.remove(&#x27;count_words.csv&#x27;)</span></span><br><span class="line">    <span class="comment"># df.to_csv(&#x27;count_words.csv&#x27;, encoding=&#x27;GBK&#x27;)</span></span><br><span class="line">    xt = count_words</span><br><span class="line">    <span class="keyword">return</span> count_words</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯äº‘å±•ç¤ºæ¨¡å—</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_wordclound</span>():</span></span><br><span class="line">    <span class="comment"># d = path.dirname(__file__)</span></span><br><span class="line">    <span class="comment"># msk = np.array(Image.open(path.join(d, &quot;151.jpg&quot;)))</span></span><br><span class="line">    word_frequence = &#123;x[<span class="number">0</span>]: x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> data_clear(xt).head(<span class="number">200</span>).values&#125;</span><br><span class="line">    wordcloud = WordCloud(font_path=<span class="string">&quot;simsun.ttc&quot;</span>, <span class="comment"># mask=msk,</span></span><br><span class="line">                          background_color=<span class="string">&quot;#EEEEEE&quot;</span>, max_font_size=<span class="number">250</span>, width=<span class="number">2100</span>, height=<span class="number">1200</span>)</span><br><span class="line">    wordcloud = wordcloud.fit_words(word_frequence)</span><br><span class="line">    plt.imshow(wordcloud)</span><br><span class="line">    plt.axis(<span class="string">&quot;off&quot;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    make_wordclound()</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> requests </tag>
            
            <tag> jieba </tag>
            
            <tag> numpy </tag>
            
            <tag> pandas </tag>
            
            <tag> matplotlib </tag>
            
            <tag> PIL </tag>
            
            <tag> Pillow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sonarä»£ç æ£€æŸ¥æœåŠ¡éƒ¨ç½²</title>
      <link href="2019/06/15/Sonar%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/"/>
      <url>2019/06/15/Sonar%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[        <h2 id="SonarQubeä»£ç æ£€æŸ¥æœåŠ¡éƒ¨ç½²"   >          <a href="#SonarQubeä»£ç æ£€æŸ¥æœåŠ¡éƒ¨ç½²" class="heading-link"><i class="fas fa-link"></i></a><a href="#SonarQubeä»£ç æ£€æŸ¥æœåŠ¡éƒ¨ç½²" class="headerlink" title="SonarQubeä»£ç æ£€æŸ¥æœåŠ¡éƒ¨ç½²"></a>SonarQubeä»£ç æ£€æŸ¥æœåŠ¡éƒ¨ç½²</h2>      <blockquote><p>å‰è¨€ï¼š å°ç»„å†…çš„ä»£ç æ£€æŸ¥æœåŠ¡<br>éƒ¨ç½²ï¼š Docker</p></blockquote><p>[TOC]</p>        <h2 id="æœåŠ¡æ„æˆ"   >          <a href="#æœåŠ¡æ„æˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#æœåŠ¡æ„æˆ" class="headerlink" title="æœåŠ¡æ„æˆ"></a>æœåŠ¡æ„æˆ</h2>      <ul><li>PostgreSQL</li><li>SonarQube</li></ul>        <h2 id="é•œåƒ"   >          <a href="#é•œåƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#é•œåƒ" class="headerlink" title="é•œåƒ"></a>é•œåƒ</h2>      <span id="more"></span>        <h3 id="SonarQube"   >          <a href="#SonarQube" class="heading-link"><i class="fas fa-link"></i></a><a href="#SonarQube" class="headerlink" title="SonarQube"></a>SonarQube</h3>      <figure class="highlight dockerfile"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> sonarqube:<span class="number">8.2</span>-community</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> run.sh /opt/sonarqube/bin/</span></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt install -y gosu</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> sonarqube</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;/opt/sonarqube/bin/run.sh&quot;</span>]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># run.sh</span></span><br><span class="line">        .</span><br><span class="line">        <span class="comment"># map legacy env variables</span></span><br><span class="line">        set_prop_from_env_var <span class="string">&quot;sonar.jdbc.username&quot;</span> <span class="string">&quot;$&#123;SONARQUBE_JDBC_USERNAME:-&#125;&quot;</span></span><br><span class="line">        set_prop_from_env_var <span class="string">&quot;sonar.jdbc.password&quot;</span> <span class="string">&quot;$&#123;SONARQUBE_JDBC_PASSWORD:-&#125;&quot;</span></span><br><span class="line">        set_prop_from_env_var <span class="string">&quot;sonar.jdbc.url&quot;</span> <span class="string">&quot;$&#123;SONARQUBE_JDBC_URL:-&#125;&quot;</span></span><br><span class="line">        set_prop_from_env_var <span class="string">&quot;sonar.web.javaAdditionalOpts&quot;</span> <span class="string">&quot;$&#123;SONARQUBE_WEB_JVM_OPTS:-&#125;&quot;</span></span><br><span class="line">        </span><br><span class="line">        exec gosu sonarqube java -jar <span class="string">&quot;lib/sonar-application-$SONAR_VERSION.jar&quot;</span> \</span><br><span class="line">          -Dsonar.log.console=true \</span><br><span class="line">          <span class="string">&quot;$&#123;sq_opts[@]&#125;&quot;</span> \</span><br><span class="line">          <span class="string">&quot;$@&quot;</span></span><br></pre></td></tr></table></div></figure>        <h3 id="PostgreSQL"   >          <a href="#PostgreSQL" class="heading-link"><i class="fas fa-link"></i></a><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3>      <figure class="highlight dockerfile"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> postgres:latest</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> postgres.log /opt/</span></span><br><span class="line"><span class="comment"># POSTGRESQLä½¿ç”¨æœ€æ–°é•œåƒ</span></span><br></pre></td></tr></table></div></figure>        <h3 id="æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼Œè¿œç«¯éƒ¨ç½²"   >          <a href="#æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼Œè¿œç«¯éƒ¨ç½²" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼Œè¿œç«¯éƒ¨ç½²" class="headerlink" title="æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼Œè¿œç«¯éƒ¨ç½²"></a>æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼Œè¿œç«¯éƒ¨ç½²</h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">starkctl push -u xxx -p xxx r.addops.xxx.cn/namespace/imagename:tag</span><br></pre></td></tr></table></div></figure>        <h3 id="å…¶ä»–"   >          <a href="#å…¶ä»–" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3>      <figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ¬åœ°æœåŠ¡Docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mydb:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">sonar</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5433:5432&quot;</span></span><br><span class="line">  <span class="attr">sonarqube:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sonarqube</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">sonar.jdbc.username:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">sonar.jdbc.password:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">sonar.jdbc.url:</span> <span class="string">jdbc:postgresql://mydb:5432/sonar</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9823:9000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.sonar:/home/sonarqube/.sonar</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./scaner:/opt/sonarqube/scanner</span></span><br></pre></td></tr></table></div></figure>        <h3 id="é—®é¢˜"   >          <a href="#é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3>      <blockquote><p>å¯åŠ¨å®¹å™¨çš„æ—¶å€™ä¼šå¯åŠ¨å†…ç½®çš„ ES æœåŠ¡ï¼Œè¿™é‡Œè¦æ±‚ä¸èƒ½ä½¿ç”¨ root è´¦æˆ·è¿è¡Œ,éœ€è¦ç”¨åˆ° gosu æˆ– su-exec å®¹å™¨å†…åˆ‡æ¢ç”¨æˆ·æ‰§è¡Œè„šæœ¬</p></blockquote>        <h3 id="ç›¸å…³è¿æ¥"   >          <a href="#ç›¸å…³è¿æ¥" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›¸å…³è¿æ¥" class="headerlink" title="ç›¸å…³è¿æ¥"></a>ç›¸å…³è¿æ¥</h3>      <p># <span class="exturl"><a class="exturl__link"   href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices" >https://docs.docker.com/develop/develop-images/dockerfile_best-practices</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> <br/><br># <span class="exturl"><a class="exturl__link"   href="https://github.com/SonarSource/docker-sonarqube" >https://github.com/SonarSource/docker-sonarqube</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>]]></content>
      
      
      
        <tags>
            
            <tag> ci/cd </tag>
            
            <tag> sonar </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitlab CI/CD é›†æˆ SonarQube æ‰«ææœåŠ¡</title>
      <link href="2019/06/15/Gitlab-CI-CD-%E9%9B%86%E6%88%90-SonarQube-%E6%89%AB%E6%8F%8F%E6%9C%8D%E5%8A%A1/"/>
      <url>2019/06/15/Gitlab-CI-CD-%E9%9B%86%E6%88%90-SonarQube-%E6%89%AB%E6%8F%8F%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[        <h1 id="Gitlab-CI-CD-é›†æˆ-SonarQube-æ‰«ææœåŠ¡"   >          <a href="#Gitlab-CI-CD-é›†æˆ-SonarQube-æ‰«ææœåŠ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#Gitlab-CI-CD-é›†æˆ-SonarQube-æ‰«ææœåŠ¡" class="headerlink" title="Gitlab CI/CD é›†æˆ SonarQube æ‰«ææœåŠ¡"></a>Gitlab CI/CD é›†æˆ SonarQube æ‰«ææœåŠ¡</h1>      <p>[TOC]</p><pre><code>ç¯å¢ƒï¼šDockergitlabgitlab-runnersonarqubepostgresql</code></pre>        <h2 id="ä½¿ç”¨ç¤ºä¾‹"   >          <a href="#ä½¿ç”¨ç¤ºä¾‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h2>      <figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .gitlab-ci.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sonar-scanner</span></span><br><span class="line"><span class="attr">sonar:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">sonar-scanner</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sonar-scanner</span> </span><br><span class="line">      <span class="string">-Dsonar.projectKey=cd_demo</span> </span><br><span class="line">      <span class="string">-Dsonar.sources=.</span> </span><br><span class="line">      <span class="string">-Dsonar.host.url=http://10.18.27.80:9823</span> </span><br><span class="line">      <span class="string">-Dsonar.login=a138bc0d36c7130bb30aebbaffbc44148b6ab8e4</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sonar</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">always</span></span><br></pre></td></tr></table></div></figure>        <h2 id="Sonar-æœåŠ¡"   >          <a href="#Sonar-æœåŠ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#Sonar-æœåŠ¡" class="headerlink" title="Sonar æœåŠ¡"></a>Sonar æœåŠ¡</h2>      <ul><li><span class="exturl"><a class="exturl__link"   href="http://note.youdao.com/noteshare?id=61644a0153db0c34075be66430fbe3c4" >SonarQube ä»£ç æ£€æŸ¥æœåŠ¡éƒ¨ç½²</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li></ul>        <h3 id="Sonar-é›†æˆ-GitLab"   >          <a href="#Sonar-é›†æˆ-GitLab" class="heading-link"><i class="fas fa-link"></i></a><a href="#Sonar-é›†æˆ-GitLab" class="headerlink" title="Sonar é›†æˆ GitLab"></a>Sonar é›†æˆ GitLab</h3>      <ul><li>admin å®‰è£… git æ’ä»¶ <code>Administration</code>-&gt;<code>marketpalce</code>-&gt; <code>search git</code>-&gt;<code>restart server</code></li><li><code>ALM Intergrations</code><br><img   src="https://note.youdao.com/yws/api/personal/file/E6645A1C4C6E47B78402FED13B5F369A?method=download&shareKey=814d1fda2ad408c56016122cef5c90fa" style=""  alt="sonar-gitlab"></li><li><code>Gitlab Application</code> <code>Token-Secret</code><br><img   src="https://note.youdao.com/yws/api/personal/file/4DE448654E9F41D7A1CC7AE6A8E375CF?method=download&shareKey=90a053673cc128ed3be7b9cf566b5bc6" style=""  alt="Gitlab Application T-S"></li></ul>        <h2 id="Gitlab-runner-æœåŠ¡"   >          <a href="#Gitlab-runner-æœåŠ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#Gitlab-runner-æœåŠ¡" class="headerlink" title="Gitlab-runner æœåŠ¡"></a>Gitlab-runner æœåŠ¡</h2>      <ul><li>æ„å»º <code>gitlab-runner</code> é•œåƒï¼Œé›†æˆ <code>node</code> ,<code>sonar-scanner</code></li><li>æ³¨å†Œ <code>Runner</code> ï¼š<ul><li><code>gitlab-runner</code> <code>register</code></li><li>è¾“å…¥ <code>gitlab-host</code></li><li>è¾“å…¥ <code>runner-token</code></li><li>è¾“å…¥ <code>tag</code></li><li>é€‰æ‹©æ‰§è¡Œæ–¹å¼ <code>shell</code></li></ul></li><li>å¼€å¯ <code>Runner</code> ä¸åŒ¹é… <code>tag</code> æ‰§è¡Œ,åœ¨ <code>CI/CD</code> -&gt; <code>runner</code> çš„è®¾ç½®é‡Œ</li></ul><p><img   src="https://note.youdao.com/yws/api/personal/file/B4C37DC2CA36420180D3CC8C00A1DC4D?method=download&shareKey=d17249b1446369fff0a6912c6f824eb7" style=""  alt="æ³¨å†Œ"></p><hr>        <h3 id="Gitlab-runner-å®¹å™¨ç¼–æ’"   >          <a href="#Gitlab-runner-å®¹å™¨ç¼–æ’" class="heading-link"><i class="fas fa-link"></i></a><a href="#Gitlab-runner-å®¹å™¨ç¼–æ’" class="headerlink" title="Gitlab-runner å®¹å™¨ç¼–æ’"></a>Gitlab-runner å®¹å™¨ç¼–æ’</h3>      <pre><code>docker-compose.yml</code></pre><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">runner:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">&#x27;gitlab-runner&#x27;</span></span><br><span class="line">  <span class="attr">build:</span> <span class="string">../../server/gitlab-runner/</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8093:8093&#x27;</span></span><br><span class="line">  <span class="comment"># volumes:</span></span><br><span class="line">  <span class="comment">#   - &#x27;$GITLAB_HOME/gitlab-runner/config:/etc/gitlab-runner&#x27;</span></span><br><span class="line">  <span class="comment">#   - &#x27;/var/run/docker.sock:/var/run/docker.sock&#x27;</span></span><br><span class="line"><span class="attr">web:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&#x27;gitlab/gitlab-ee:latest&#x27;</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">&#x27;gitlab.example.com&#x27;</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">external_url</span> <span class="string">&#x27;http://gitlab.example.com:8929&#x27;</span></span><br><span class="line">      <span class="string">gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;]</span> <span class="string">=</span> <span class="number">2224</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8929:8929&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;2224:22&#x27;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;$GITLAB_HOME/config:/etc/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;$GITLAB_HOME/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;$GITLAB_HOME/data:/var/opt/gitlab&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure><pre><code>gitlab-runner/Dockerfile</code></pre><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM gitlab&#x2F;gitlab-runner:latest</span><br><span class="line"></span><br><span class="line">LABEL MAINTAINER&#x3D;baqianxin@360.cn</span><br><span class="line"></span><br><span class="line">RUN export LANG&#x3D;en_US.UTF-8  &amp;&amp; export LANGUAGE&#x3D;en_US</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp;  apt-get  install -y  nodejs vim unzip </span><br><span class="line">RUN cd &#x2F;opt &amp;&amp; \ </span><br><span class="line">wget https:&#x2F;&#x2F;binaries.sonarsource.com&#x2F;Distribution&#x2F;sonar-scanner-cli&#x2F;sonar-scanner-cli-4.0.0.1744-linux.zip &amp;&amp; \</span><br><span class="line">unzip sonar-scanner-cli-4.0.0.1744-linux.zip &amp;&amp; \ </span><br><span class="line">mv sonar-scanner-4.0.0.1744-linux sonar-scanner</span><br><span class="line"></span><br><span class="line">RUN  ln -s &#x2F;opt&#x2F;sonar-scanner&#x2F;bin&#x2F;sonar-scanner &#x2F;usr&#x2F;bin&#x2F;sonar-scanner &amp;&amp; sonar-scanner -v</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="æ³¨æ„é—®é¢˜"   >          <a href="#æ³¨æ„é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³¨æ„é—®é¢˜" class="headerlink" title="æ³¨æ„é—®é¢˜"></a>æ³¨æ„é—®é¢˜</h3>      <ul><li>ç³»ç»Ÿè¯­è¨€éœ€è®¾ç½® LCALL LANGUAGE LANG=en_US.UTF-8</li></ul><pre><code>[submodule &quot;golang/example&quot;]    active = true    url = git@github.com:baqianxin/examples.git[submodule &quot;spider/chineseocr_lite&quot;]    url = git@github.com:baqianxin/chineseocr_lite.git    active = true</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> ci/cd </tag>
            
            <tag> soanrqube </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go-gin esæŸ¥è¯¢ä½¿ç”¨å¤šæ¡ä»¶ä¸èšåˆ</title>
      <link href="2019/05/25/go-gin-es%E6%9F%A5%E8%AF%A2%E4%BD%BF%E7%94%A8%E5%A4%9A%E6%9D%A1%E4%BB%B6%E4%B8%8E%E8%81%9A%E5%90%88/"/>
      <url>2019/05/25/go-gin-es%E6%9F%A5%E8%AF%A2%E4%BD%BF%E7%94%A8%E5%A4%9A%E6%9D%A1%E4%BB%B6%E4%B8%8E%E8%81%9A%E5%90%88/</url>
      
        <content type="html"><![CDATA[        <h2 id="esæŸ¥è¯¢-term-ä¸-match"   >          <a href="#esæŸ¥è¯¢-term-ä¸-match" class="heading-link"><i class="fas fa-link"></i></a><a href="#esæŸ¥è¯¢-term-ä¸-match" class="headerlink" title="esæŸ¥è¯¢ term ä¸ match"></a>esæŸ¥è¯¢ term ä¸ match</h2>              <h2 id="esæŸ¥è¯¢-must-ä¸-should"   >          <a href="#esæŸ¥è¯¢-must-ä¸-should" class="heading-link"><i class="fas fa-link"></i></a><a href="#esæŸ¥è¯¢-must-ä¸-should" class="headerlink" title="esæŸ¥è¯¢ must ä¸ should"></a>esæŸ¥è¯¢ must ä¸ should</h2>      <ul><li>mustçš„ä¸¤ä¸ªæ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³</li><li>shouldä¸­çš„ä¸¤ä¸ªæ¡ä»¶è‡³å°‘æ»¡è¶³ä¸€ä¸ªå°±å¯ä»¥<span id="more"></span></li></ul><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;dns_cache_ms_log_queue_2019*&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;Data.Tid.keyword&quot;: &quot;445f395f647c1b36&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;Host.keyword&quot;: &quot;p53577v.hulk.shbt.qihoo.net_001&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>        <h2 id="es-ä½¿ç”¨æ’åºå­—æ®µçš„é—®é¢˜"   >          <a href="#es-ä½¿ç”¨æ’åºå­—æ®µçš„é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#es-ä½¿ç”¨æ’åºå­—æ®µçš„é—®é¢˜" class="headerlink" title="es ä½¿ç”¨æ’åºå­—æ®µçš„é—®é¢˜"></a>es ä½¿ç”¨æ’åºå­—æ®µçš„é—®é¢˜</h2>      <ul><li><span class="exturl"><a class="exturl__link"   href="https://my.oschina.net/dabird/blog/1926042" >es sort all shards failed [type=search_phase_execution_exception]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li><span class="exturl"><a class="exturl__link"   href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/search-request-sort.html#_ignoring_unmapped_fields" >Ignoring Unmapped Fields</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li></ul><figure class="highlight go"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚ä¸æ’åºçš„å­—æ®µç±»å‹ä¸æ˜ç¡® CreateTime [æœªæ˜ å°„ç±»å‹å­—æ®µ]</span></span><br><span class="line">client.Sort(<span class="string">&quot;CreateTime&quot;</span>, <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// æ›¿æ¢ä¸ºé»˜è®¤æ—¶é—´å­—æ®µ</span></span><br><span class="line">client.Sort(<span class="string">&quot;@timestamp&quot;</span>, <span class="literal">false</span>)</span><br></pre></td></tr></table></div></figure>        <h2 id="olivere-elastic-ä½¿ç”¨"   >          <a href="#olivere-elastic-ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#olivere-elastic-ä½¿ç”¨" class="headerlink" title="olivere/elastic ä½¿ç”¨"></a>olivere/elastic ä½¿ç”¨</h2>      <ul><li>NewBoolQuery å¤šæ¡ä»¶æŸ¥è¯¢å™¨</li><li>q.Must / q.Should æ·»åŠ æŸ¥è¯¢å™¨</li><li>å…¶ä»–æŸ¥è¯¢å™¨ NewTermQuery NewMatchQuery â€¦</li><li>åˆ†é¡µ From(OFFSET) / Size(PAGESIZ)</li><li>æ’åº Sort(FIELD,DESC_BOOL)</li></ul><figure class="highlight go"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">client := GetEsClient().Search().Index(<span class="string">&quot;dns_cache_ms_log_queue_20*&quot;</span>)</span><br><span class="line">boolQuery := elastic.NewBoolQuery()</span><br><span class="line"></span><br><span class="line">termQuery := elastic.NewTermQuery(<span class="string">&quot;Data.Tid.keyword&quot;</span>, tid)</span><br><span class="line">termQueryHost := elastic.NewTermQuery(<span class="string">&quot;Host.keyword&quot;</span>, host)</span><br><span class="line">boolQuery.Must(termQuery)</span><br><span class="line">boolQuery.Must(termQueryHost)</span><br><span class="line">client = client.Query(boolQuery)</span><br><span class="line">PrintDSL(boolQuery) <span class="comment">// æ‰“å°æŸ¥è¯¢å™¨ç”Ÿæˆçš„ json æ•°æ®</span></span><br><span class="line">searchResult, err := client.From(page*ES_PAGE_SIZE).Size(ES_PAGE_SIZE).Sort(<span class="string">&quot;@timestamp&quot;</span>, <span class="literal">false</span>).</span><br><span class="line">    Pretty(<span class="literal">true</span>). <span class="comment">// æŸ¥è¯¢ç»“æœè¿”å›å¯è¯»æ€§è¾ƒå¥½çš„JSONæ ¼å¼</span></span><br><span class="line">    Do(context.Background())</span><br><span class="line">fmt.Printf(<span class="string">&quot;æŸ¥è¯¢æ¶ˆè€—æ—¶é—´ %d ms, ç»“æœæ€»æ•°: %d\n&quot;</span>, searchResult.TookInMillis, searchResult.TotalHits())</span><br></pre></td></tr></table></div></figure>        <h2 id="èšåˆæŸ¥è¯¢"   >          <a href="#èšåˆæŸ¥è¯¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#èšåˆæŸ¥è¯¢" class="headerlink" title="èšåˆæŸ¥è¯¢"></a>èšåˆæŸ¥è¯¢</h2>      <ul><li>s</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> gin </tag>
            
            <tag> es </tag>
            
            <tag> å¤šæ¡ä»¶ </tag>
            
            <tag> èšåˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP å¤„ç†è¿”å›å¤§æ–‡ä»¶çš„æ¥å£</title>
      <link href="2019/03/25/PHP-%E5%A4%84%E7%90%86%E8%BF%94%E5%9B%9E%E5%A4%A7%E6%96%87%E4%BB%B6%E7%9A%84%E6%8E%A5%E5%8F%A3/"/>
      <url>2019/03/25/PHP-%E5%A4%84%E7%90%86%E8%BF%94%E5%9B%9E%E5%A4%A7%E6%96%87%E4%BB%B6%E7%9A%84%E6%8E%A5%E5%8F%A3/</url>
      
        <content type="html"><![CDATA[<p>å¤„ç†çš„ä¸»è¦é€»è¾‘ç‚¹åœ¨ BasicAuthè¯·æ±‚,æ–‡ä»¶æµå¤„ç†,è¡Œè¯»å–,CSV-Tabæ ¼å¼åŒ–,å¤§æ•°ç»„åˆ†æ®µæ‰¹é‡ä¿å­˜,Textç±»å‹å®¹é‡;</p><p>å®é™…åœºæ™¯:æ•°æ®ä¸­å¿ƒæä¾›çš„ä¸€ä»½æƒ…æŠ¥æ•°æ®1.6wæ¡è®°å½•,æ¯æ¡è®°å½•0.5k,å­—æ®µ10+;</p><ul><li><p>æ¥å£é‰´æƒ:<br>  basic Auth</p></li><li><p>ä½¿ç”¨GuzzleHttpè¯·æ±‚</p><ul><li>option è®¾ç½® auth=&gt;[name,password]<ul><li>option è®¾ç½®è¶…æ—¶æ—¶é—´<span id="more"></span></li></ul></li></ul></li><li><p>è·å–è¿”å›æ•°æ®</p><ul><li>$response = $client-&gt;get(â€¦);</li><li>è·å–è¿”å›æ•°æ®çš„ stream $response-&gt;getBody();</li><li>æ•°æ®ç¼“å­˜è·¯å¾„ â€œ php:/temp â€œ (å¯è‡ªå®šä¹‰é…ç½®php.ini)</li><li>åˆ¤æ–­æ–‡ä»¶å¤§å°,è·å–å†…å®¹,å†™å…¥æŒ‡å®šè·¯å¾„ $tmpPath</li><li>è¡Œè¯»å– fgets() | SplFileObject</li><li>æ ¼å¼åŒ– Tab str_getcsv()</li><li>è¿”å›æ•°ç»„</li></ul></li><li><p>å¤§æ•°ç»„å†™å…¥ MySQL</p><ul><li>æ‰¹é‡å†™å…¥ MySQLæœ€å¤§å ä½ç¬¦é™åˆ¶ 65535</li><li><code>SQLSTATE[HY000]: General error: 1390 Prepared statement contains too many placeholders.</code></li><li>MAX_NUM = int( 65535 / count( saveData[0] ) )</li><li>åˆ†æ®µå†™å…¥ array_chunk( , MAX_NUM , ) è¿”å›åˆ†æ®µæ•°ç»„åˆ—è¡¨</li><li>éå†å†™å…¥ MySQL</li><li>å†™å…¥æˆåŠŸå å‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–ä¸šåŠ¡</li><li>é‡Šæ”¾å†…å­˜,åˆ é™¤ä¸´æ—¶æ–‡ä»¶</li></ul></li><li><p>MySQL text ç±»å‹å¤§å°</p><ul><li><code>ERROR: SQLSTATE[22001]: String data, right truncated: 1406 Data too long for column</code><figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TEXT 65,535 bytes ~64kb</span><br><span class="line">MEDIUMTEXT 16,777,215 bytes ~16Mb</span><br><span class="line">LONGTEXT 4,294,967,295 bytes ~4Gb</span><br><span class="line"></span><br><span class="line">ERROR: SQLSTATE[22001]: String data, right truncated: 1406 Data too long for column </span><br></pre></td></tr></table></div></figure></li></ul></li><li><p>ç¤ºä¾‹ä»£ç </p>  <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Console</span>\<span class="title">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">QueueJob</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">SpecialName</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class     SyncNetlabBlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>  App\Console\Commands</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncNetlabBlock</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&#x27;sync:netlab-blocklist&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;xxxxxxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ•°æ®</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢åŒ¹é…ç‰¹å®šåŸŸåè§£æ special_name</span></span><br><span class="line"><span class="comment">     *      æœ‰åˆ™ä¸æ·»åŠ </span></span><br><span class="line"><span class="comment">     *      æ— åˆ™æ–°å¢</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$saveData</span> = [];</span><br><span class="line">        <span class="variable">$queueData</span> = [];</span><br><span class="line">        <span class="variable">$specialNameModel</span> = <span class="keyword">new</span> SpecialName();</span><br><span class="line">        <span class="variable">$netlabBlockList</span> = <span class="keyword">$this</span>-&gt;getNetlabData();</span><br><span class="line">        <span class="variable">$netlabBlockList</span> = <span class="keyword">$this</span>-&gt;distinctDomainName(<span class="variable">$netlabBlockList</span>);</span><br><span class="line">        <span class="comment">// æ„é€ æ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$netlabBlockList</span> <span class="keyword">as</span> <span class="variable">$qname</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable">$item</span> = [</span><br><span class="line">                <span class="string">&#x27;qname&#x27;</span> =&gt; <span class="variable">$qname</span>,</span><br><span class="line">                ......</span><br><span class="line">            ];</span><br><span class="line">            <span class="variable">$saveData</span>[] = <span class="variable">$item</span>;</span><br><span class="line">            <span class="variable">$queueData</span>[] = <span class="variable">$specialNameModel</span>-&gt;formatMessage(<span class="variable">$item</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åˆ†æ®µå†™å…¥æ•°æ®åº“</span></span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$saveData</span>[<span class="number">0</span>]) * count(<span class="variable">$saveData</span>) &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">            print_r(<span class="string">&quot;å¼€å¯åˆ†æ®µå†™å…¥Mysql:&quot;</span> . count(<span class="variable">$saveData</span>) . PHP_EOL);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;partitionSave(<span class="variable">$saveData</span>, <span class="variable">$queueData</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å…¥æ•°æ®åº“</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$saveData</span> &amp;&amp; DB::table(<span class="variable">$specialNameModel</span>-&gt;getTable())-&gt;insert(<span class="variable">$saveData</span>)) &#123;</span><br><span class="line">            <span class="comment">// å‘é€é€šçŸ¥</span></span><br><span class="line">            <span class="variable">$specialNameModel</span>-&gt;dispatch(<span class="keyword">new</span> QueueJob(QueueJob::ADD_SPECIAL_NAME, <span class="variable">$queueData</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$saveData</span>, <span class="variable">$queueData</span>, <span class="variable">$netlabBlockList</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†æ®µ æ’å…¥æ•°æ®åº“-å‘é€æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $saveData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $queueData</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">partitionSave</span>(<span class="params"><span class="variable">$saveData</span>, <span class="variable">$queueData</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$specialNameModel</span> = <span class="keyword">new</span> SpecialName();</span><br><span class="line">        <span class="variable">$groupSave</span> = array_chunk(<span class="variable">$saveData</span>, <span class="number">5000</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$groupQueue</span> = array_chunk(<span class="variable">$queueData</span>, <span class="number">5000</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; count(<span class="variable">$groupSave</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            print_r(<span class="string">&quot;chunk_<span class="subst">&#123;$i&#125;</span>ä¿å­˜æˆåŠŸ_COUNT()&quot;</span> . count(<span class="variable">$groupSave</span>[<span class="variable">$i</span>]) . PHP_EOL);</span><br><span class="line">            <span class="comment">// å†™å…¥æ•°æ®åº“</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$groupSave</span>[<span class="variable">$i</span>] &amp;&amp; DB::table(<span class="variable">$specialNameModel</span>-&gt;getTable())-&gt;insert(<span class="variable">$groupSave</span>[<span class="variable">$i</span>])) &#123;</span><br><span class="line">                <span class="comment">// å‘é€é€šçŸ¥</span></span><br><span class="line">                <span class="variable">$specialNameModel</span>-&gt;dispatch(<span class="keyword">new</span> QueueJob(QueueJob::ADD_SPECIAL_NAME, <span class="variable">$groupQueue</span>[<span class="variable">$i</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚netlabæ¥å£è·å–æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNetlabData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$netlabBlockList</span> = <span class="variable">$options</span> = [];</span><br><span class="line">        <span class="variable">$httpClient</span> = <span class="keyword">new</span> Client();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$path</span> = <span class="string">&quot;/tmp/netlab_blocklist_&quot;</span> . date(<span class="string">&quot;YmdHis&quot;</span>) . <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">        <span class="variable">$url</span> = <span class="string">&quot;xxxxx&quot;</span>;</span><br><span class="line">        <span class="variable">$user</span> = <span class="string">&#x27;xxxxx&#x27;</span>;</span><br><span class="line">        <span class="variable">$password</span> = <span class="string">&#x27;xxxxx&#x27;</span>;</span><br><span class="line">        <span class="variable">$options</span>[<span class="string">&#x27;auth&#x27;</span>] = [<span class="variable">$user</span>, <span class="variable">$password</span>];</span><br><span class="line">        <span class="variable">$options</span>[<span class="string">&#x27;timeout&#x27;</span>] = <span class="number">7200</span>;</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable">$httpClient</span>-&gt;get(<span class="variable">$url</span>, <span class="variable">$options</span>);</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$response</span>-&gt;getBody();</span><br><span class="line">        <span class="variable">$wreturn</span> = file_put_contents(<span class="variable">$path</span>, <span class="variable">$data</span>-&gt;getContents());</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$wreturn</span>) &#123;</span><br><span class="line">            <span class="variable">$netlabBlockList</span> = <span class="keyword">$this</span>-&gt;readBlockListByLine(<span class="variable">$path</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ é™¤æ–‡ä»¶</span></span><br><span class="line">        unlink(<span class="variable">$path</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$netlabBlockList</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $netlabBlockList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">distinctDomainName</span>(<span class="params"><span class="variable">$netlabBlockList</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰æ•°æ®åº“æ•°æ®-Aè®°å½•åŸŸå-è¿‡æ»¤å·²å­˜åœ¨æ•°æ®</span></span><br><span class="line">        <span class="variable">$queryData</span> = SpecialName::query()-&gt;where(<span class="string">&#x27;qtype&#x27;</span>, SpecialName::DEFAULT_TYPE_A)</span><br><span class="line">            -&gt;get(<span class="string">&#x27;qname&#x27;</span>)-&gt;toArray();</span><br><span class="line">        <span class="variable">$queryData</span> = array_column(<span class="variable">$queryData</span>, <span class="string">&#x27;qname&#x27;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$queryData</span> <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$netlabBlockList</span>[<span class="variable">$val</span>])) &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable">$netlabBlockList</span>[<span class="variable">$val</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$netlabBlockList</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  SplFileObject</span></span><br><span class="line"><span class="comment">     * è¡Œè¯»å–-è½¬æ¢ä¸ºæ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $fileUrl</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $isTab</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readBlockListByLine</span>(<span class="params"><span class="variable">$fileUrl</span>, <span class="variable">$isTab</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        file_exists(<span class="variable">$fileUrl</span>) <span class="keyword">or</span> <span class="keyword">exit</span>(<span class="string">&quot;There is no file&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file</span> = fopen(<span class="variable">$fileUrl</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="variable">$delimiter</span> = <span class="variable">$isTab</span> ? <span class="string">&quot;\t&quot;</span> : <span class="string">&quot;,&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$buffer</span> = [];</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (!feof(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="variable">$line</span> = fgets(<span class="variable">$file</span>);<span class="comment">//fgets()å‡½æ•°ä»æ–‡ä»¶æŒ‡é’ˆä¸­è¯»å–ä¸€è¡Œ</span></span><br><span class="line">            <span class="variable">$data</span> = str_getcsv(<span class="variable">$line</span>, <span class="variable">$delimiter</span>);</span><br><span class="line">            <span class="keyword">if</span> (count(<span class="variable">$data</span>) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$buffer</span>[<span class="variable">$data</span>[<span class="number">1</span>]] = <span class="variable">$data</span>[<span class="number">10</span>];</span><br><span class="line">            <span class="variable">$i</span>++;</span><br><span class="line">        &#125;</span><br><span class="line">        fclose(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$buffer</span> = array_filter(<span class="variable">$buffer</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$buffer</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> MySQL </tag>
            
            <tag> Text </tag>
            
            <tag> CSV </tag>
            
            <tag> Laravel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Ginç¤ºä¾‹ä»£ç </title>
      <link href="2019/03/12/Go-Gin%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81/"/>
      <url>2019/03/12/Go-Gin%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[        <h3 id="Gin-Example"   >          <a href="#Gin-Example" class="heading-link"><i class="fas fa-link"></i></a><a href="#Gin-Example" class="headerlink" title="Gin Example"></a>Gin Example</h3>      <ul><li>è·¯ç”±</li><li>ä¸­é—´ä»¶</li><li>å¹³æ»‘é€€å‡º(å¹³æ»‘é‡å¯)</li><li>åŒæ­¥|å¼‚æ­¥(goroutine)</li><li>WebSocket</li><li>Bind(Query|Form|Json)</li><li>JSONP|JSON|SecureJSON|PureJson</li><li>XML|YAML<span id="more"></span></li><li>ProtoBuf</li><li>é™æ€é¡µé¢æ¸²æŸ“</li><li>æ–‡ä»¶ä¸‹è½½</li><li>Swaggeræ¥å£æ–‡æ¡£</li><li>Wire (ä¾èµ–æ³¨å…¥DI)</li></ul><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;context&quot;</span><br><span class="line">&quot;flag&quot;</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">_ &quot;gogin&#x2F;docs&quot;</span><br><span class="line">&quot;gogin&#x2F;module&quot;</span><br><span class="line">&quot;io&quot;</span><br><span class="line">&quot;io&#x2F;ioutil&quot;</span><br><span class="line">&quot;log&quot;</span><br><span class="line">&quot;net&quot;</span><br><span class="line">&quot;net&#x2F;http&quot;</span><br><span class="line">&quot;os&quot;</span><br><span class="line">&quot;os&#x2F;signal&quot;</span><br><span class="line">&quot;time&quot;</span><br><span class="line"></span><br><span class="line">&quot;github.com&#x2F;gin-gonic&#x2F;gin&quot;</span><br><span class="line">&quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;proto&quot;</span><br><span class="line">gs &quot;github.com&#x2F;swaggo&#x2F;gin-swagger&quot;</span><br><span class="line">&quot;github.com&#x2F;swaggo&#x2F;gin-swagger&#x2F;swaggerFiles&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">server   *http.Server</span><br><span class="line">listener net.Listener &#x3D; nil</span><br><span class="line"></span><br><span class="line">graceful &#x3D; flag.Bool(&quot;graceful&quot;, false, &quot;listen on fd open 3 (internal use only)&quot;)</span><br><span class="line">message  &#x3D; flag.String(&quot;message&quot;, &quot;Hello World&quot;, &quot;message to send&quot;)</span><br><span class="line">err      error</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç»‘å®šform</span><br><span class="line">type LoginForm struct &#123;</span><br><span class="line">User     string &#96;form:&quot;user&quot; binding:&quot;required&quot;&#96;</span><br><span class="line">Password string &#96;form:&quot;password&quot; binding:&quot;required&quot;&#96;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç»‘å®š JSON</span><br><span class="line">&#x2F;&#x2F; Methods - Bind, BindJSON, BindXML, BindQuery, BindYAML</span><br><span class="line">&#x2F;&#x2F; Methods - ShouldBind, ShouldBindJSON, ShouldBindXML, ShouldBindQuery, ShouldBindYAML</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç»‘å®šuri</span><br><span class="line">type Person struct &#123;</span><br><span class="line">ID   string &#96;uri:&quot;id&quot; binding:&quot;required,uuid&quot;&#96;</span><br><span class="line">Name string &#96;uri:&quot;name&quot; binding:&quot;required&quot;&#96;</span><br><span class="line">&#125;</span><br><span class="line">type Login struct &#123;</span><br><span class="line">User     string &#96;form:&quot;user&quot; json:&quot;user&quot; xml:&quot;user&quot;  binding:&quot;required&quot;&#96;</span><br><span class="line">Password string &#96;form:&quot;password&quot; json:&quot;password&quot; xml:&quot;password&quot; binding:&quot;required&quot;&#96;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; swagger-api-doc Swaggeræ¥å£æ–‡æ¡£</span><br><span class="line">&#x2F;&#x2F; @Summary Swaggeræ¥å£æ–‡æ¡£</span><br><span class="line">&#x2F;&#x2F; @Description Swaggeræ¥å£æ–‡æ¡£</span><br><span class="line">&#x2F;&#x2F; @Tags Tags æ ‡ç­¾</span><br><span class="line">&#x2F;&#x2F; @Accept application&#x2F;json</span><br><span class="line">&#x2F;&#x2F; @Produce application&#x2F;json</span><br><span class="line">&#x2F;&#x2F; @Param Authorization header string false &quot;Bearer ç”¨æˆ·ä»¤ç‰Œ&quot;</span><br><span class="line">&#x2F;&#x2F; @Param object query Login false &quot;æŸ¥è¯¢å‚æ•°&quot;</span><br><span class="line">&#x2F;&#x2F; @Security ApiKeyAuth</span><br><span class="line">&#x2F;&#x2F; @Success 200 &#123;object&#125; Person</span><br><span class="line">&#x2F;&#x2F; @Router &#x2F;swagger-api-doc [get]</span><br><span class="line">func main() &#123;</span><br><span class="line">&#x2F;&#x2F; basic</span><br><span class="line">r :&#x3D; gin.Default()</span><br><span class="line">r.GET(&quot;&#x2F;ping&quot;, func(c *gin.Context) &#123;</span><br><span class="line">c.JSON(200, gin.H&#123;</span><br><span class="line">&quot;message&quot;: &quot;pong&quot;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; jsonp</span><br><span class="line">r.GET(&quot;&#x2F;JSONP&quot;, func(c *gin.Context) &#123;</span><br><span class="line">data :&#x3D; map[string]interface&#123;&#125;&#123;</span><br><span class="line">&quot;foo&quot;: &quot;bar&quot;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; &#x2F;JSONP?callback&#x3D;x</span><br><span class="line">&#x2F;&#x2F; å°†è¾“å‡ºï¼šx(&#123;\&quot;foo\&quot;:\&quot;bar\&quot;&#125;)</span><br><span class="line">c.JSONP(http.StatusOK, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; http server pusher</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; form bind</span><br><span class="line">r.POST(&quot;&#x2F;login&quot;, func(c *gin.Context) &#123;</span><br><span class="line">&#x2F;&#x2F; ä½ å¯ä»¥ä½¿ç”¨æ˜¾å¼ç»‘å®šå£°æ˜ç»‘å®š multipart formï¼š</span><br><span class="line">&#x2F;&#x2F; c.ShouldBindWith(&amp;form, binding.Form)</span><br><span class="line">&#x2F;&#x2F; æˆ–è€…ç®€å•åœ°ä½¿ç”¨ ShouldBind æ–¹æ³•è‡ªåŠ¨ç»‘å®šï¼š</span><br><span class="line">var form LoginForm</span><br><span class="line">&#x2F;&#x2F; åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ç»‘å®š</span><br><span class="line">if c.ShouldBind(&amp;form) &#x3D;&#x3D; nil &#123;</span><br><span class="line">if form.User &#x3D;&#x3D; &quot;user&quot; &amp;&amp; form.Password &#x3D;&#x3D; &quot;password&quot; &#123;</span><br><span class="line">c.JSON(200, gin.H&#123;&quot;status&quot;: &quot;you are logged in&quot;&#125;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">c.JSON(401, gin.H&#123;&quot;status&quot;: &quot;unauthorized&quot;&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">c.JSON(500, gin.H&#123;&quot;status&quot;: &quot;request failed&quot;&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; curl -v localhost:8088&#x2F;thinkerou&#x2F;987fbc97-4bed-5078-9f07-9141ba07c9f3</span><br><span class="line">&#x2F;&#x2F; curl -v localhost:8088&#x2F;thinkerou&#x2F;not-uuid</span><br><span class="line">&#x2F;&#x2F; r.GET(&quot;&#x2F;:name&#x2F;:id&quot;, func(c *gin.Context) &#123;</span><br><span class="line">&#x2F;&#x2F; var person Person</span><br><span class="line">&#x2F;&#x2F; if err :&#x3D; c.ShouldBindUri(&amp;person); err !&#x3D; nil &#123;</span><br><span class="line">&#x2F;&#x2F; c.JSON(400, gin.H&#123;&quot;msg&quot;: err&#125;)</span><br><span class="line">&#x2F;&#x2F; return</span><br><span class="line">&#x2F;&#x2F; &#125;</span><br><span class="line">&#x2F;&#x2F; c.JSON(200, gin.H&#123;&quot;name&quot;: person.Name, &quot;uuid&quot;: person.ID&#125;)</span><br><span class="line">&#x2F;&#x2F; &#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; form-post</span><br><span class="line">r.POST(&quot;&#x2F;form_post&quot;, func(c *gin.Context) &#123;</span><br><span class="line">message :&#x3D; c.PostForm(&quot;message&quot;)</span><br><span class="line">nick :&#x3D; c.DefaultPostForm(&quot;nick&quot;, &quot;anonymous&quot;)</span><br><span class="line"></span><br><span class="line">c.JSON(200, gin.H&#123;</span><br><span class="line">&quot;status&quot;:  &quot;posted&quot;,</span><br><span class="line">&quot;message&quot;: message,</span><br><span class="line">&quot;nick&quot;:    nick,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Query | POST Form</span><br><span class="line">r.POST(&quot;&#x2F;post&quot;, func(c *gin.Context) &#123;</span><br><span class="line"></span><br><span class="line">id :&#x3D; c.Query(&quot;id&quot;)</span><br><span class="line">page :&#x3D; c.DefaultQuery(&quot;page&quot;, &quot;0&quot;)</span><br><span class="line">name :&#x3D; c.PostForm(&quot;name&quot;)</span><br><span class="line">message :&#x3D; c.PostForm(&quot;message&quot;)</span><br><span class="line">rs :&#x3D; fmt.Sprintf(&quot;id: %s; page: %s; name: %s; message: %s&quot;, id, page, name, message)</span><br><span class="line">fmt.Printf(rs)</span><br><span class="line">c.String(200, rs)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; JSON response</span><br><span class="line">&#x2F;&#x2F; æä¾› unicode å®ä½“</span><br><span class="line">r.GET(&quot;&#x2F;json&quot;, func(c *gin.Context) &#123;</span><br><span class="line">c.JSON(200, gin.H&#123;</span><br><span class="line">&quot;html&quot;: &quot;&lt;b&gt;Hello, world!&lt;&#x2F;b&gt;&quot;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æä¾›å­—é¢å­—ç¬¦</span><br><span class="line">r.GET(&quot;&#x2F;purejson&quot;, func(c *gin.Context) &#123;</span><br><span class="line">c.PureJSON(200, gin.H&#123;</span><br><span class="line">&quot;html&quot;: &quot;&lt;b&gt;Hello, world!&lt;&#x2F;b&gt;&quot;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„ SecureJSON å‰ç¼€</span><br><span class="line">&#x2F;&#x2F; r.SecureJsonPrefix(&quot;)]&#125;&#39;,\n&quot;)</span><br><span class="line">r.GET(&quot;&#x2F;someJSON&quot;, func(c *gin.Context) &#123;</span><br><span class="line">names :&#x3D; []string&#123;&quot;lena&quot;, &quot;austin&quot;, &quot;foo&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å°†è¾“å‡ºï¼šwhile(1);[&quot;lena&quot;,&quot;austin&quot;,&quot;foo&quot;]</span><br><span class="line">c.SecureJSON(http.StatusOK, names)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.GET(&quot;&#x2F;moreJSON&quot;, func(c *gin.Context) &#123;</span><br><span class="line">&#x2F;&#x2F; ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“</span><br><span class="line">var msg struct &#123;</span><br><span class="line">Name    string &#96;json:&quot;user&quot;&#96;</span><br><span class="line">Message string</span><br><span class="line">Number  int</span><br><span class="line">&#125;</span><br><span class="line">msg.Name &#x3D; &quot;Lena&quot;</span><br><span class="line">msg.Message &#x3D; &quot;hey&quot;</span><br><span class="line">msg.Number &#x3D; 123</span><br><span class="line">&#x2F;&#x2F; æ³¨æ„ msg.Name åœ¨ JSON ä¸­å˜æˆäº† &quot;user&quot;</span><br><span class="line">&#x2F;&#x2F; å°†è¾“å‡ºï¼š&#123;&quot;user&quot;: &quot;Lena&quot;, &quot;Message&quot;: &quot;hey&quot;, &quot;Number&quot;: 123&#125;</span><br><span class="line">c.JSON(http.StatusOK, msg)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.GET(&quot;&#x2F;someXML&quot;, func(c *gin.Context) &#123;</span><br><span class="line">c.XML(http.StatusOK, gin.H&#123;&quot;message&quot;: &quot;hey&quot;, &quot;status&quot;: http.StatusOK&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.GET(&quot;&#x2F;someYAML&quot;, func(c *gin.Context) &#123;</span><br><span class="line">c.YAML(http.StatusOK, gin.H&#123;&quot;message&quot;: &quot;hey&quot;, &quot;status&quot;: http.StatusOK&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; protoBuf</span><br><span class="line">r.GET(&quot;&#x2F;someProtoBuf&quot;, func(c *gin.Context) &#123;</span><br><span class="line">age :&#x3D; int32(12) &#x2F;&#x2F;[]int64&#123;int64(1), int64(2)&#125;</span><br><span class="line">name :&#x3D; &quot;test&quot;</span><br><span class="line">&#x2F;&#x2F; protobuf çš„å…·ä½“å®šä¹‰å†™åœ¨ testdata&#x2F;protoexample æ–‡ä»¶ä¸­ã€‚</span><br><span class="line">data :&#x3D; &amp;module.User&#123;</span><br><span class="line">Name: name,</span><br><span class="line">Age:  age,</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; è¯·æ³¨æ„ï¼Œæ•°æ®åœ¨å“åº”ä¸­å˜ä¸ºäºŒè¿›åˆ¶æ•°æ®</span><br><span class="line">&#x2F;&#x2F; å°†è¾“å‡ºè¢« module.User protobuf åºåˆ—åŒ–äº†çš„æ•°æ®</span><br><span class="line">c.ProtoBuf(http.StatusOK, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; pares proto</span><br><span class="line">r.GET(&quot;&#x2F;paresProto&quot;, func(c *gin.Context) &#123;</span><br><span class="line">resp, err :&#x3D; http.Get(&quot;http:&#x2F;&#x2F;localhost:8989&#x2F;someProtoBuf&quot;)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">defer resp.Body.Close()</span><br><span class="line">body, err :&#x3D; ioutil.ReadAll(resp.Body)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">user :&#x3D; &amp;module.User&#123;&#125;</span><br><span class="line">proto.UnmarshalMerge(body, user)</span><br><span class="line">c.String(200, user.String())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ¸²æŸ“é¡µé¢</span><br><span class="line">r.LoadHTMLFiles(&quot;..&#x2F;web&#x2F;index.html&quot;)</span><br><span class="line">r.StaticFile(&quot;&#x2F;cws.js&quot;, &quot;..&#x2F;web&#x2F;cws.js&quot;)</span><br><span class="line">r.GET(&quot;&#x2F;html&quot;, func(c *gin.Context) &#123;</span><br><span class="line">c.HTML(200, &quot;index.html&quot;, nil)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¯·æ±‚èµ„æº-ä¸‹è½½æ–‡ä»¶</span><br><span class="line">r.GET(&quot;&#x2F;someDataFromReader&quot;, func(c *gin.Context) &#123;</span><br><span class="line">response, err :&#x3D; http.Get(&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;gin-gonic&#x2F;logo&#x2F;master&#x2F;color.png&quot;)</span><br><span class="line">if err !&#x3D; nil || response.StatusCode !&#x3D; http.StatusOK &#123;</span><br><span class="line">c.Status(http.StatusServiceUnavailable)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reader :&#x3D; response.Body</span><br><span class="line">contentLength :&#x3D; response.ContentLength</span><br><span class="line">contentType :&#x3D; response.Header.Get(&quot;Content-Type&quot;)</span><br><span class="line"></span><br><span class="line">extraHeaders :&#x3D; map[string]string&#123;</span><br><span class="line">&#x2F;&#x2F; ä¸‹è½½æ–‡ä»¶</span><br><span class="line">&#x2F;&#x2F; &quot;Content-Disposition&quot;: &#96;attachment; filename&#x3D;&quot;gopher.png&quot;&#96;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.DataFromReader(http.StatusOK, contentLength, contentType, reader, extraHeaders)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ¨¡æ‹Ÿä¸€äº›ç§äººæ•°æ®</span><br><span class="line">var secrets &#x3D; gin.H&#123;</span><br><span class="line">&quot;foo&quot;:    gin.H&#123;&quot;email&quot;: &quot;foo@bar.com&quot;, &quot;phone&quot;: &quot;123433&quot;&#125;,</span><br><span class="line">&quot;austin&quot;: gin.H&#123;&quot;email&quot;: &quot;austin@example.com&quot;, &quot;phone&quot;: &quot;666&quot;&#125;,</span><br><span class="line">&quot;lena&quot;:   gin.H&#123;&quot;email&quot;: &quot;lena@guapa.com&quot;, &quot;phone&quot;: &quot;523443&quot;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è·¯ç”±ç»„ä½¿ç”¨ gin.BasicAuth() ä¸­é—´ä»¶</span><br><span class="line">&#x2F;&#x2F; gin.Accounts æ˜¯ map[string]string çš„ä¸€ç§å¿«æ·æ–¹å¼</span><br><span class="line">authorized :&#x3D; r.Group(&quot;&#x2F;admin&quot;, gin.BasicAuth(gin.Accounts&#123;</span><br><span class="line">&quot;foo&quot;:    &quot;bar&quot;,</span><br><span class="line">&quot;austin&quot;: &quot;1234&quot;,</span><br><span class="line">&quot;lena&quot;:   &quot;hello2&quot;,</span><br><span class="line">&quot;manu&quot;:   &quot;4321&quot;,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; &#x2F;admin&#x2F;secrets ç«¯ç‚¹</span><br><span class="line">&#x2F;&#x2F; è§¦å‘ &quot;localhost:8080&#x2F;admin&#x2F;secrets</span><br><span class="line">authorized.GET(&quot;&#x2F;secrets&quot;, func(c *gin.Context) &#123;</span><br><span class="line">&#x2F;&#x2F; è·å–ç”¨æˆ·ï¼Œå®ƒæ˜¯ç”± BasicAuth ä¸­é—´ä»¶è®¾ç½®çš„</span><br><span class="line">user :&#x3D; c.MustGet(gin.AuthUserKey).(string)</span><br><span class="line">if secret, ok :&#x3D; secrets[user]; ok &#123;</span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;&quot;user&quot;: user, &quot;secret&quot;: secret&#125;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;&quot;user&quot;: user, &quot;secret&quot;: &quot;NO SECRET :(&quot;&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å…¨å±€ä¸­é—´ä»¶  å•è·¯ç”±å¤šä¸­é—´ä»¶ è·¯ç”±ç»„åµŒå¥—</span><br><span class="line">&#x2F;&#x2F; TODO:more</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ä¸­é—´ä»¶ goroutine</span><br><span class="line">r.GET(&quot;&#x2F;long_async&quot;, func(c *gin.Context) &#123;</span><br><span class="line">&#x2F;&#x2F; åˆ›å»ºåœ¨ goroutine ä¸­ä½¿ç”¨çš„å‰¯æœ¬</span><br><span class="line">cCp :&#x3D; c.Copy()</span><br><span class="line">go func() &#123;</span><br><span class="line">&#x2F;&#x2F; ç”¨ time.Sleep() æ¨¡æ‹Ÿä¸€ä¸ªé•¿ä»»åŠ¡ã€‚</span><br><span class="line">time.Sleep(5 * time.Second)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¯·æ³¨æ„æ‚¨ä½¿ç”¨çš„æ˜¯å¤åˆ¶çš„ä¸Šä¸‹æ–‡ &quot;cCp&quot;ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦</span><br><span class="line">log.Println(&quot;Done! in path &quot; + cCp.Request.URL.Path)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.GET(&quot;&#x2F;long_sync&quot;, func(c *gin.Context) &#123;</span><br><span class="line">&#x2F;&#x2F; ç”¨ time.Sleep() æ¨¡æ‹Ÿä¸€ä¸ªé•¿ä»»åŠ¡ã€‚</span><br><span class="line">time.Sleep(5 * time.Second)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å› ä¸ºæ²¡æœ‰ä½¿ç”¨ goroutineï¼Œä¸éœ€è¦æ‹·è´ä¸Šä¸‹æ–‡</span><br><span class="line">log.Println(&quot;Done! in path &quot; + c.Request.URL.Path)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; swagger api doc</span><br><span class="line">r.GET(&quot;&#x2F;swagger&#x2F;*any&quot;, gs.WrapHandler(swaggerFiles.Handler))</span><br><span class="line"></span><br><span class="line">uf, e :&#x3D; UserLoader()</span><br><span class="line">fmt.Println(uf, e)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç¦ç”¨æ§åˆ¶å°é¢œè‰²ï¼Œå°†æ—¥å¿—å†™å…¥æ–‡ä»¶æ—¶ä¸éœ€è¦æ§åˆ¶å°é¢œè‰²ã€‚</span><br><span class="line">&#x2F;&#x2F; gin.DisableConsoleColor()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è®°å½•åˆ°æ–‡ä»¶ã€‚</span><br><span class="line">f, _ :&#x3D; os.Create(&quot;gin.log&quot;)</span><br><span class="line">gin.DefaultWriter &#x3D; io.MultiWriter(f)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¦‚æœéœ€è¦åŒæ—¶å°†æ—¥å¿—å†™å…¥æ–‡ä»¶å’Œæ§åˆ¶å°ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹ä»£ç ã€‚</span><br><span class="line">&#x2F;&#x2F; gin.DefaultWriter &#x3D; io.MultiWriter(f, os.Stdout)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¹³æ»‘å…³æœº</span><br><span class="line">r.GET(&quot;&#x2F;&quot;, func(c *gin.Context) &#123;</span><br><span class="line">time.Sleep(5 * time.Second)</span><br><span class="line">c.String(http.StatusOK, &quot;Welcome Gin Server&quot;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">srv :&#x3D; &amp;http.Server&#123;</span><br><span class="line">Addr:    &quot;:8989&quot;,</span><br><span class="line">Handler: r,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">go func() &#123;</span><br><span class="line">&#x2F;&#x2F; æœåŠ¡è¿æ¥</span><br><span class="line">if err :&#x3D; srv.ListenAndServe(); err !&#x3D; nil &amp;&amp; err !&#x3D; http.ErrServerClosed &#123;</span><br><span class="line">log.Fatalf(&quot;listen: %s\n&quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç­‰å¾…ä¸­æ–­ä¿¡å·ä»¥ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ï¼ˆè®¾ç½® 5 ç§’çš„è¶…æ—¶æ—¶é—´ï¼‰</span><br><span class="line">quit :&#x3D; make(chan os.Signal)</span><br><span class="line">signal.Notify(quit, os.Interrupt)</span><br><span class="line"></span><br><span class="line">sig :&#x3D; &lt;-quit</span><br><span class="line">log.Println(sig)</span><br><span class="line">log.Println(&quot;Shutdown Server ...&quot;)</span><br><span class="line"></span><br><span class="line">ctx, cancel :&#x3D; context.WithTimeout(context.Background(), 5*time.Second)</span><br><span class="line">defer cancel()</span><br><span class="line"></span><br><span class="line">if err :&#x3D; srv.Shutdown(ctx); err !&#x3D; nil &#123;</span><br><span class="line">log.Fatal(&quot;Server Shutdown:&quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">log.Println(&quot;Server exiting&quot;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; r.Run(&quot;:8989&quot;) &#x2F;&#x2F; listen and serve on 0.0.0.0:8080 (for windows &quot;localhost:8080&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Gin </tag>
            
            <tag> Wire </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golangä½¿ç”¨WebSocket+ChromeDPå®ç°å®æ—¶é¡µé¢ç›‘æ§</title>
      <link href="2019/03/05/Golang%E4%BD%BF%E7%94%A8WebSocket-ChromeDP%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E9%A1%B5%E9%9D%A2%E7%9B%91%E6%8E%A7/"/>
      <url>2019/03/05/Golang%E4%BD%BF%E7%94%A8WebSocket-ChromeDP%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E9%A1%B5%E9%9D%A2%E7%9B%91%E6%8E%A7/</url>
      
        <content type="html"><![CDATA[        <h1 id="WebSocket-Chromedpå®ç°é¡µé¢å®æ—¶ç›‘æ§"   >          <a href="#WebSocket-Chromedpå®ç°é¡µé¢å®æ—¶ç›‘æ§" class="heading-link"><i class="fas fa-link"></i></a><a href="#WebSocket-Chromedpå®ç°é¡µé¢å®æ—¶ç›‘æ§" class="headerlink" title="WebSocket+Chromedpå®ç°é¡µé¢å®æ—¶ç›‘æ§"></a>WebSocket+Chromedpå®ç°é¡µé¢å®æ—¶ç›‘æ§</h1>              <h2 id="å‡ºå‘ç‚¹"   >          <a href="#å‡ºå‘ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‡ºå‘ç‚¹" class="headerlink" title="å‡ºå‘ç‚¹"></a>å‡ºå‘ç‚¹</h2>      <ul><li><p>ç†è§£ä¸åº”ç”¨ Golang çš„ Gorouting</p></li><li><p>Channel é€šé“ <code>chan</code> </p></li><li><p>WebSocket </p></li><li><p>chromedp </p><blockquote><p>æŸ¥çœ‹ socket ä½¿ç”¨æ—¶,æƒ³åˆ°èƒ½å¦ç»“åˆåº”ç”¨ä¸‹ chan, æ­£å¥½åˆçœ‹åˆ°chromedp çš„æ–‡ç« .å°±æ€è€ƒèƒ½å¦é€šè¿‡ websocket + chan å®ç° headless chrome ç›‘æ§é¡µé¢ä¿¡æ¯</p></blockquote><span id="more"></span>        <h2 id="Socket"   >          <a href="#Socket" class="heading-link"><i class="fas fa-link"></i></a><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h2>      <p>ç½‘ç»œä¸­çš„ Socket å¹¶ä¸æ˜¯ä»€ä¹ˆåè®®ï¼Œè€Œæ˜¯ä¸ºäº†ä½¿ç”¨ TCPï¼ŒUDP è€ŒæŠ½è±¡å‡ºæ¥çš„ä¸€å±‚ APIï¼Œå®ƒæ˜¯ä½äºåº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¹‹é—´çš„ä¸€ä¸ªæŠ½è±¡å±‚ã€‚Socket æ˜¯å¯¹ TCP/IP çš„å°è£…ï¼›<br>Golang æœ¬èº«net åŒ… å³å¯å®ç° Socket æœåŠ¡ .</p></li></ul>        <h2 id="WebSocket"   >          <a href="#WebSocket" class="heading-link"><i class="fas fa-link"></i></a><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2>      <p> WebSocket æ˜¯ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®. å› ä¸ºä¸äº†è§£WebSocketå¯¼è‡´é—¹äº†ä¸ªç¬‘è¯æ‰€ä»¥åˆ—å‡ºæ¥</p><ul><li>WebSocket ä¸ HTTPéƒ½æ˜¯åŸºäºTCP/IPåè®®ä¸Šçš„,å¯é æ€§ä¼ è¾“åè®®,éƒ½æ˜¯åº”ç”¨å±‚åè®®.</li><li>WebSocketæ˜¯åŒå‘é€šä¿¡åè®®ï¼Œæ¨¡æ‹ŸSocketåè®®ï¼Œå¯ä»¥åŒå‘å‘é€æˆ–æ¥å—ä¿¡æ¯ã€‚HTTPæ˜¯å•å‘çš„ã€‚</li><li>WebSocketæ˜¯éœ€è¦æ¡æ‰‹è¿›è¡Œå»ºç«‹è¿æ¥çš„ã€‚<ul><li>1.æµè§ˆå™¨ã€æœåŠ¡å™¨å»ºç«‹TCPè¿æ¥ï¼Œä¸‰æ¬¡æ¡æ‰‹ã€‚è¿™æ˜¯é€šä¿¡çš„åŸºç¡€ï¼Œä¼ è¾“æ§åˆ¶å±‚ï¼Œè‹¥å¤±è´¥åç»­éƒ½ä¸æ‰§è¡Œã€‚</li><li>2.TCPè¿æ¥æˆåŠŸåï¼Œæµè§ˆå™¨é€šè¿‡HTTPåè®®å‘æœåŠ¡å™¨ä¼ é€WebSocketæ”¯æŒçš„ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ã€‚ï¼ˆå¼€å§‹å‰çš„HTTPæ¡æ‰‹ï¼‰</li><li>3.æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¡æ‰‹è¯·æ±‚åï¼ŒåŒæ ·é‡‡ç”¨HTTPåè®®å›é¦ˆæ•°æ®ã€‚</li><li>4.å½“æ”¶åˆ°äº†è¿æ¥æˆåŠŸçš„æ¶ˆæ¯åï¼Œé€šè¿‡TCPé€šé“è¿›è¡Œä¼ è¾“é€šä¿¡ã€‚</li></ul></li></ul>        <h2 id="chromedp"   >          <a href="#chromedp" class="heading-link"><i class="fas fa-link"></i></a><a href="#chromedp" class="headerlink" title="chromedp"></a>chromedp</h2>      <p> ç”¨äºé©±åŠ¨ æ”¯æŒ  Chrome DevTools Protocol çš„æµè§ˆå™¨</p><blockquote><p>Package chromedp is a faster, simpler way to drive browsers supporting the <code>Chrome DevTools Protocol</code>in Go without external dependencies (like Selenium or PhantomJS).</p></blockquote> <!--more-->        <h3 id="Examples"   >          <a href="#Examples" class="heading-link"><i class="fas fa-link"></i></a><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3>      <div class="table-container"><table><thead><tr><th>Example</th><th>Description</th></tr></thead><tbody><tr><td><span class="exturl"><a class="exturl__link"   href="https://github.com/chromedp/examples/tree/master/click2" >click2</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td><td>use a selector to click on an element</td></tr><tr><td><span class="exturl"><a class="exturl__link"   href="https://github.com/chromedp/examples/tree/master/click" >click</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td><td>use a selector to click on an element</td></tr><tr><td><span class="exturl"><a class="exturl__link"   href="https://github.com/chromedp/examples/tree/master/screenshot" >screenshot</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td><td>take a screenshot of a specific element and of the entire browser viewport</td></tr></tbody></table></div>        <h2 id="åŠŸèƒ½é€»è¾‘"   >          <a href="#åŠŸèƒ½é€»è¾‘" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŠŸèƒ½é€»è¾‘" class="headerlink" title="åŠŸèƒ½é€»è¾‘"></a>åŠŸèƒ½é€»è¾‘</h2>      <ul><li>main </li><li>go func GR1 å¼€å¯æµè§ˆå™¨<ul><li>GR1 å¸¸é©»æˆªå±,å†™å…¥ å…¨å±€ chan </li></ul></li><li>go func GR2 å¼€å¯æ¶ˆæ¯è¯»å–<ul><li>GR2 è¯»å–åˆ°æ¶ˆæ¯å,å‹ç¼©å›¾ç‰‡ä¿¡æ¯,</li><li>GR2 éå†å½“å‰æ‰€æœ‰WebSocketè¿æ¥å¯¹è±¡ å‘é€å›¾ç‰‡æ•°æ®(blob|base64) </li></ul></li><li>å¯åŠ¨ WebSocket æœåŠ¡,æ¥å— å®¢æˆ·ç«¯è¿æ¥,æ’å…¥åˆ° å…¨å±€ è¿æ¥ Map ä¸­<ul><li>æ¥å—å®¢æˆ·ç«¯çš„ç‚¹å‡»äº‹ä»¶,ç­‰æ¯”è®¡ç®—,æ˜ å°„åˆ° chromedp ç›‘æ§çš„é¡µé¢ä¸­<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A--&gt;B</span><br></pre></td></tr></table></div></figure></li></ul></li></ul>        <h2 id="å®ç°ä»£ç "   >          <a href="#å®ç°ä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°ä»£ç " class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h2>              <h3 id="Golang-Server"   >          <a href="#Golang-Server" class="heading-link"><i class="fas fa-link"></i></a><a href="#Golang-Server" class="headerlink" title="Golang Server"></a>Golang Server</h3>       <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"> package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;context&quot;</span><br><span class="line">&quot;encoding&#x2F;base64&quot;</span><br><span class="line">&quot;flag&quot;</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;io&#x2F;ioutil&quot;</span><br><span class="line">&quot;log&quot;</span><br><span class="line">&quot;net&#x2F;http&quot;</span><br><span class="line">&quot;time&quot;</span><br><span class="line"></span><br><span class="line">&quot;github.com&#x2F;chromedp&#x2F;chromedp&quot;</span><br><span class="line">&quot;github.com&#x2F;gorilla&#x2F;websocket&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var addr &#x3D; flag.String(&quot;addr&quot;, &quot;localhost:9999&quot;, &quot;http service address&quot;)</span><br><span class="line"></span><br><span class="line">var upgrader &#x3D; websocket.Upgrader&#123;&#125; &#x2F;&#x2F; use default options</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç”¨æ¥è®°å½•æ‰€æœ‰çš„å®¢æˆ·ç«¯è¿æ¥</span><br><span class="line">var ConnMap map[string]*websocket.Conn</span><br><span class="line"></span><br><span class="line">var MAX_WATCH_TIME &#x3D; 500</span><br><span class="line"></span><br><span class="line">const DATE_TIME_FORMAT &#x3D; &quot;2006-01-02 15:04:05&quot;</span><br><span class="line">const DATE_FORMAT &#x3D; &quot;2006-01-02&quot;</span><br><span class="line">const DATE_FORMAT_NUM &#x3D; &quot;20060102&quot;</span><br><span class="line"></span><br><span class="line">var CH_SC &#x3D; make(chan []byte)</span><br><span class="line"></span><br><span class="line">func echo(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">&#x2F;&#x2F; å…è®¸è·¨åŸŸ</span><br><span class="line">upgrader.CheckOrigin &#x3D; func(r *http.Request) bool &#123; return true &#125;</span><br><span class="line">c, err :&#x3D; upgrader.Upgrade(w, r, nil)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">log.Print(&quot;upgrade:&quot;, err)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">defer c.Close()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ–°è¿æ¥åŠ å…¥map</span><br><span class="line">ConnMap[c.RemoteAddr().String()] &#x3D; c</span><br><span class="line"></span><br><span class="line">for &#123;</span><br><span class="line">mt, message, err :&#x3D; c.ReadMessage()</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">log.Println(&quot;read:&quot;, err)</span><br><span class="line">break</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(&quot;recv: %s&quot;, message)</span><br><span class="line">err &#x3D; c.WriteMessage(mt, message)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">log.Println(&quot;write:&quot;, err)</span><br><span class="line">break</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line">log.SetFlags(0)</span><br><span class="line">begin :&#x3D; time.Now()</span><br><span class="line">ConnMap &#x3D; make(map[string]*websocket.Conn)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¯åŠ¨ chrome å¹¶å¼€å¯æˆªå±è¿›ç¨‹</span><br><span class="line">go func() &#123;</span><br><span class="line">opts :&#x3D; append(chromedp.DefaultExecAllocatorOptions[:],</span><br><span class="line">chromedp.Flag(&quot;headless&quot;, true),</span><br><span class="line">chromedp.Flag(&quot;disable-gpu&quot;, false),</span><br><span class="line">chromedp.Flag(&quot;enable-automation&quot;, false),</span><br><span class="line">chromedp.Flag(&quot;disable-extensions&quot;, true),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">allocCtx, cancel :&#x3D; chromedp.NewExecAllocator(context.Background(), opts...)</span><br><span class="line">defer cancel()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; create context</span><br><span class="line">ctx, cancel :&#x3D; chromedp.NewContext(allocCtx, chromedp.WithLogf(log.Printf))</span><br><span class="line">defer cancel()</span><br><span class="line"></span><br><span class="line">urlstr :&#x3D; &#96;https:&#x2F;&#x2F;youku.com&#x2F;&#96;</span><br><span class="line">&#x2F;&#x2F; éœ€è¦æˆªå›¾çš„å…ƒç´ ï¼Œæ”¯æŒCSS selectorä»¥åŠXPath query</span><br><span class="line">selector :&#x3D; &#96;#m_15319&#96; &#x2F;&#x2F;&#96;#m_2556&#96; &#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">if err :&#x3D; chromedp.Run(ctx,</span><br><span class="line">&#x2F;&#x2F; emulate iPhone 7 landscape</span><br><span class="line">&#x2F;&#x2F; chromedp.Emulate(device.IPhone7landscape),</span><br><span class="line">chromedp.Navigate(urlstr),</span><br><span class="line">chromedp.EmulateViewport(1200, 0, chromedp.EmulateScale(1)),</span><br><span class="line">); err !&#x3D; nil &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var buf []byte</span><br><span class="line">for &#123;</span><br><span class="line">buf &#x3D; []byte&#123;&#125;</span><br><span class="line">if err :&#x3D; chromedp.Run(ctx, elementScreenshot(urlstr, selector, &amp;buf)); err !&#x3D; nil &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; å‘é€åˆ°å…¨å±€channel</span><br><span class="line">CH_SC &lt;- buf</span><br><span class="line">fmt.Println(int64(time.Since(begin).Seconds()), MAX_WATCH_TIME)</span><br><span class="line">&#x2F;&#x2F; if int64(time.Since(begin).Seconds()) &gt; int64(MAX_WATCH_TIME) &#123;</span><br><span class="line">&#x2F;&#x2F; return</span><br><span class="line">&#x2F;&#x2F; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¯åŠ¨å‘é€æ¶ˆæ¯é€šé“</span><br><span class="line">go func() &#123;</span><br><span class="line">for &#123;</span><br><span class="line">select &#123;</span><br><span class="line">case task :&#x3D; &lt;-CH_SC:</span><br><span class="line">&#x2F;&#x2F;task.Process()</span><br><span class="line">fmt.Println(time.Now().Format(DATE_TIME_FORMAT))</span><br><span class="line">sendPictureData(task)</span><br><span class="line">&#x2F;&#x2F; å†™å…¥æ–‡ä»¶</span><br><span class="line">if err :&#x3D; ioutil.WriteFile(&quot;youku_b.png&quot;, task, 0644); err !&#x3D; nil &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">http.HandleFunc(&quot;&#x2F;echo&quot;, echo)</span><br><span class="line">log.Fatal(http.ListenAndServe(*addr, nil))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å‘é€äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®</span><br><span class="line">func sendPictureData(picture []byte) &#123;</span><br><span class="line">&#x2F;&#x2F; img, _ :&#x3D; png.Decode(bytes.NewReader(picture))</span><br><span class="line">&#x2F;&#x2F; resizeImg :&#x3D; resize.Resize(hight, 0, img, resize.Lanczos3)</span><br><span class="line">&#x2F;&#x2F;base64å‹ç¼©</span><br><span class="line">sourcestring :&#x3D; base64.StdEncoding.EncodeToString(picture)</span><br><span class="line">&#x2F;&#x2F; err :&#x3D; c.WriteMessage(websocket.BinaryMessage, []byte(sourcestring))</span><br><span class="line">for _, c :&#x3D; range ConnMap &#123;</span><br><span class="line">err :&#x3D; c.WriteMessage(websocket.TextMessage, []byte(sourcestring))</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">log.Println(&quot;write:&quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æˆªå›¾æ–¹æ³•</span><br><span class="line">func elementScreenshot(urlstr, sel string, res *[]byte) chromedp.Tasks &#123;</span><br><span class="line">&#x2F;&#x2F; ssOpts :&#x3D; append()</span><br><span class="line">return chromedp.Tasks&#123;</span><br><span class="line">&#x2F;&#x2F; chromedp.Navigate(urlstr),</span><br><span class="line">chromedp.WaitVisible(sel, chromedp.ByID),</span><br><span class="line">&#x2F;&#x2F;chromedp.Sleep(time.Duration(3) * time.Second),</span><br><span class="line">&#x2F;&#x2F; æ‰§è¡Œæˆªå›¾</span><br><span class="line">chromedp.Screenshot(sel, res, chromedp.NodeVisible, chromedp.ByID),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>        <h3 id="JS-å¤„ç†"   >          <a href="#JS-å¤„ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#JS-å¤„ç†" class="headerlink" title="JS å¤„ç†"></a>JS å¤„ç†</h3>       <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> function arrayBufferToBase64(buffer) &#123;</span><br><span class="line">    var binary &#x3D; &#39;&#39;;</span><br><span class="line">    var bytes &#x3D; new Uint8Array(buffer);</span><br><span class="line">    var len &#x3D; bytes.byteLength;</span><br><span class="line">    for (var i &#x3D; 0; i &lt; len; i++) &#123;</span><br><span class="line">        binary +&#x3D; String.fromCharCode(bytes[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    return window.btoa(binary);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;**blob to dataURL**</span><br><span class="line">function blobToDataURL(blob, callback) &#123;</span><br><span class="line">    var a &#x3D; new FileReader();</span><br><span class="line">    a.onload &#x3D; function(e) &#123;</span><br><span class="line">        callback(e.target.result);</span><br><span class="line">    &#125;</span><br><span class="line">    a.readAsDataURL(blob);</span><br><span class="line">    return a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var canvas &#x3D; document.getElementById(&quot;animation_canvas&quot;);</span><br><span class="line">canvas.width &#x3D; 640;</span><br><span class="line">canvas.height &#x3D; 1030;</span><br><span class="line"></span><br><span class="line">var ctx &#x3D; canvas.getContext(&quot;2d&quot;);</span><br><span class="line">let ws &#x3D; new WebSocket(&quot;ws:&#x2F;&#x2F;localhost:9999&#x2F;echo&quot;);</span><br><span class="line">var player &#x3D; document.getElementById(&#39;player&#39;);</span><br><span class="line">ctx.drawImage(player, 0, 0);</span><br><span class="line"></span><br><span class="line">ws.onopen &#x3D; function () &#123;</span><br><span class="line">    ws.send(JSON.stringify(&#123; message: &quot;hello server!&quot; &#125;))</span><br><span class="line">&#125;</span><br><span class="line">ws.onmessage &#x3D; function(evt) &#123;</span><br><span class="line">    &#x2F;&#x2F; console.log(evt.data,typeof(evt.data))</span><br><span class="line">    &#x2F;&#x2F; base64æ•°æ®ç›´æ¥å±•ç¤º  </span><br><span class="line">    if(typeof(evt.data)&#x3D;&#x3D;&quot;string&quot;)&#123;</span><br><span class="line">        player.src&#x3D;&#39;data:image&#x2F;png;base64,&#39;+evt.data;</span><br><span class="line">        player.onload&#x3D;function()&#123;</span><br><span class="line">            canvas.width &#x3D; 1200;</span><br><span class="line">            canvas.height &#x3D; this.height;</span><br><span class="line">            ctx.clearRect(0,0,canvas.width,canvas.height);  </span><br><span class="line">            ctx.drawImage(this, 0, 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; äºŒè¿›åˆ¶æ•°æ®è½¬å›¾ç‰‡</span><br><span class="line">    &#x2F;&#x2F; result &#x3D; blobToDataURL(evt.data, function(dataurl) &#123;</span><br><span class="line">    &#x2F;&#x2F;     &#x2F;&#x2F; æˆªå– base64,</span><br><span class="line">    &#x2F;&#x2F;     var arr &#x3D; dataurl.split(&#39;,&#39;);</span><br><span class="line">    &#x2F;&#x2F;     var mime &#x3D; arr[0].match(&#x2F;:(.*?);&#x2F;)[1];</span><br><span class="line">    &#x2F;&#x2F;     var player &#x3D; document.getElementById(&#39;player&#39;);</span><br><span class="line">    &#x2F;&#x2F;     ctx.drawImage(player, 0, 0);</span><br><span class="line">    &#x2F;&#x2F;     var url&#x3D; arrayBufferToBase64(evt.data);</span><br><span class="line">    &#x2F;&#x2F;     player.src&#x3D;&#39;data:image&#x2F;png;base64,&#39;+arr[1];</span><br><span class="line">    &#x2F;&#x2F;     player.onload&#x3D;function()&#123;</span><br><span class="line">    &#x2F;&#x2F;         canvas.width &#x3D; 1200;</span><br><span class="line">    &#x2F;&#x2F;         canvas.height &#x3D; this.height;</span><br><span class="line">    &#x2F;&#x2F;         ctx.clearRect(0,0,canvas.width,canvas.height);  </span><br><span class="line">    &#x2F;&#x2F;         ctx.drawImage(this, 0, 0);</span><br><span class="line">    &#x2F;&#x2F;     &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; &#125;);</span><br><span class="line">&#125;</span><br><span class="line">ws.onerror &#x3D; function (event) &#123;</span><br><span class="line">    console.debug(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>]]></content>
      
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> WebSocket </tag>
            
            <tag> chromedp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux:SSH éš§é“åŠŸèƒ½</title>
      <link href="2018/09/15/Linux-SSH-%E9%9A%A7%E9%81%93%E5%8A%9F%E8%83%BD/"/>
      <url>2018/09/15/Linux-SSH-%E9%9A%A7%E9%81%93%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># æ£€æŸ¥ä»£ç†æœåŠ¡å™¨æ˜¯å¦å¯ä»¥è½¬å‘</span><br><span class="line">&#x2F;&#x2F; sshd æœåŠ¡é…ç½®</span><br><span class="line">cat &#x2F;etc&#x2F;ssh&#x2F;sshd_config | grep AllowTcp</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç³»ç»Ÿè½¬å‘è§„åˆ™</span><br><span class="line">cat &#x2F;etc&#x2F;sysctl.conf | grep ip_forward</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹</span><br><span class="line">sysctl -w net.ipv4.ip_forward&#x3D;1</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ£€æŸ¥è¿è¡Œæ—¶é…ç½®</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; é€€å‡º é‡æ–°è¿æ¥</span><br><span class="line">ssh -L 8080:127.0.0.1:8080 root@121.xxxx.xxx.xxx</span><br><span class="line"></span><br><span class="line">æœ¬åœ°ç«¯å£ï¼šç›®æ ‡æœºå™¨ï¼šç«¯å£</span><br></pre></td></tr></table></div></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> SSH éš§é“ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
