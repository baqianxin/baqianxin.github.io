<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="WebSocket+Chromedp实现页面实时监控                           出发点        理解与应用 Golang 的 Gorouting  Channel 通道 chan   WebSocket   chromedp   查看 socket 使用时,想到能否结合应用下 chan, 正好又看到chromedp 的文章.就思考能否通过 we">
<meta property="og:type" content="article">
<meta property="og:title" content="Golang使用WebSocket+ChromeDP实现实时页面监控">
<meta property="og:url" content="http://baqianxin.github.io/2019/03/05/Golang%E4%BD%BF%E7%94%A8WebSocket-ChromeDP%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E9%A1%B5%E9%9D%A2%E7%9B%91%E6%8E%A7/index.html">
<meta property="og:site_name" content="baqianxin">
<meta property="og:description" content="WebSocket+Chromedp实现页面实时监控                           出发点        理解与应用 Golang 的 Gorouting  Channel 通道 chan   WebSocket   chromedp   查看 socket 使用时,想到能否结合应用下 chan, 正好又看到chromedp 的文章.就思考能否通过 we">
<meta property="og:locale">
<meta property="article:published_time" content="2019-03-05T10:34:32.000Z">
<meta property="article:modified_time" content="2021-05-25T06:55:55.700Z">
<meta property="article:author" content="baqianxin">
<meta property="article:tag" content="WebSocket chromedp golang">
<meta name="twitter:card" content="summary"><title>Golang使用WebSocket+ChromeDP实现实时页面监控 | baqianxin</title><link ref="canonical" href="http://baqianxin.github.io/2019/03/05/Golang%E4%BD%BF%E7%94%A8WebSocket-ChromeDP%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E9%A1%B5%E9%9D%A2%E7%9B%91%E6%8E%A7/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">baqianxin</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Golang使用WebSocket+ChromeDP实现实时页面监控</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2019-03-05</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-05-25</span></span></div></header><div class="post-body">
        <h1 id="WebSocket-Chromedp实现页面实时监控"   >
          <a href="#WebSocket-Chromedp实现页面实时监控" class="heading-link"><i class="fas fa-link"></i></a><a href="#WebSocket-Chromedp实现页面实时监控" class="headerlink" title="WebSocket+Chromedp实现页面实时监控"></a>WebSocket+Chromedp实现页面实时监控</h1>
      
        <h2 id="出发点"   >
          <a href="#出发点" class="heading-link"><i class="fas fa-link"></i></a><a href="#出发点" class="headerlink" title="出发点"></a>出发点</h2>
      <ul>
<li><p>理解与应用 Golang 的 Gorouting</p>
</li>
<li><p>Channel 通道 <code>chan</code> </p>
</li>
<li><p>WebSocket </p>
</li>
<li><p>chromedp </p>
<blockquote>
<p>查看 socket 使用时,想到能否结合应用下 chan, 正好又看到chromedp 的文章.就思考能否通过 websocket + chan 实现 headless chrome 监控页面信息</p>
</blockquote>
<span id="more"></span>

        <h2 id="Socket"   >
          <a href="#Socket" class="heading-link"><i class="fas fa-link"></i></a><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h2>
      <p>网络中的 Socket 并不是什么协议，而是为了使用 TCP，UDP 而抽象出来的一层 API，它是位于应用层和传输层之间的一个抽象层。Socket 是对 TCP/IP 的封装；<br>Golang 本身net 包 即可实现 Socket 服务 .</p>
</li>
</ul>

        <h2 id="WebSocket"   >
          <a href="#WebSocket" class="heading-link"><i class="fas fa-link"></i></a><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2>
      <p> WebSocket 是一种在单个 TCP 连接上进行全双工通信的协议. 因为不了解WebSocket导致闹了个笑话所以列出来</p>
<ul>
<li>WebSocket 与 HTTP都是基于TCP/IP协议上的,可靠性传输协议,都是应用层协议.</li>
<li>WebSocket是双向通信协议，模拟Socket协议，可以双向发送或接受信息。HTTP是单向的。</li>
<li>WebSocket是需要握手进行建立连接的。<ul>
<li>1.浏览器、服务器建立TCP连接，三次握手。这是通信的基础，传输控制层，若失败后续都不执行。</li>
<li>2.TCP连接成功后，浏览器通过HTTP协议向服务器传送WebSocket支持的版本号等信息。（开始前的HTTP握手）</li>
<li>3.服务器收到客户端的握手请求后，同样采用HTTP协议回馈数据。</li>
<li>4.当收到了连接成功的消息后，通过TCP通道进行传输通信。</li>
</ul>
</li>
</ul>

        <h2 id="chromedp"   >
          <a href="#chromedp" class="heading-link"><i class="fas fa-link"></i></a><a href="#chromedp" class="headerlink" title="chromedp"></a>chromedp</h2>
      <p> 用于驱动 支持  Chrome DevTools Protocol 的浏览器</p>
<blockquote>
<p>Package chromedp is a faster, simpler way to drive browsers supporting the <code>Chrome DevTools Protocol</code>in Go without external dependencies (like Selenium or PhantomJS).</p>
</blockquote>
 <!--more-->


        <h3 id="Examples"   >
          <a href="#Examples" class="heading-link"><i class="fas fa-link"></i></a><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/chromedp/examples/tree/master/click2" >click2</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
<td>use a selector to click on an element</td>
</tr>
<tr>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/chromedp/examples/tree/master/click" >click</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
<td>use a selector to click on an element</td>
</tr>
<tr>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/chromedp/examples/tree/master/screenshot" >screenshot</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
<td>take a screenshot of a specific element and of the entire browser viewport</td>
</tr>
</tbody></table></div>

        <h2 id="功能逻辑"   >
          <a href="#功能逻辑" class="heading-link"><i class="fas fa-link"></i></a><a href="#功能逻辑" class="headerlink" title="功能逻辑"></a>功能逻辑</h2>
      <ul>
<li>main </li>
<li>go func GR1 开启浏览器<ul>
<li>GR1 常驻截屏,写入 全局 chan </li>
</ul>
</li>
<li>go func GR2 开启消息读取<ul>
<li>GR2 读取到消息后,压缩图片信息,</li>
<li>GR2 遍历当前所有WebSocket连接对象 发送图片数据(blob|base64) </li>
</ul>
</li>
<li>启动 WebSocket 服务,接受 客户端连接,插入到 全局 连接 Map 中<ul>
<li>接受客户端的点击事件,等比计算,映射到 chromedp 监控的页面中<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A--&gt;B</span><br></pre></td></tr></table></div></figure>


</li>
</ul>
</li>
</ul>

        <h2 id="实现代码"   >
          <a href="#实现代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2>
      
        <h3 id="Golang-Server"   >
          <a href="#Golang-Server" class="heading-link"><i class="fas fa-link"></i></a><a href="#Golang-Server" class="headerlink" title="Golang Server"></a>Golang Server</h3>
       <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"> package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;encoding&#x2F;base64&quot;</span><br><span class="line">	&quot;flag&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;io&#x2F;ioutil&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;net&#x2F;http&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line"></span><br><span class="line">	&quot;github.com&#x2F;chromedp&#x2F;chromedp&quot;</span><br><span class="line">	&quot;github.com&#x2F;gorilla&#x2F;websocket&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var addr &#x3D; flag.String(&quot;addr&quot;, &quot;localhost:9999&quot;, &quot;http service address&quot;)</span><br><span class="line"></span><br><span class="line">var upgrader &#x3D; websocket.Upgrader&#123;&#125; &#x2F;&#x2F; use default options</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 用来记录所有的客户端连接</span><br><span class="line">var ConnMap map[string]*websocket.Conn</span><br><span class="line"></span><br><span class="line">var MAX_WATCH_TIME &#x3D; 500</span><br><span class="line"></span><br><span class="line">const DATE_TIME_FORMAT &#x3D; &quot;2006-01-02 15:04:05&quot;</span><br><span class="line">const DATE_FORMAT &#x3D; &quot;2006-01-02&quot;</span><br><span class="line">const DATE_FORMAT_NUM &#x3D; &quot;20060102&quot;</span><br><span class="line"></span><br><span class="line">var CH_SC &#x3D; make(chan []byte)</span><br><span class="line"></span><br><span class="line">func echo(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">	&#x2F;&#x2F; 允许跨域</span><br><span class="line">	upgrader.CheckOrigin &#x3D; func(r *http.Request) bool &#123; return true &#125;</span><br><span class="line">	c, err :&#x3D; upgrader.Upgrade(w, r, nil)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		log.Print(&quot;upgrade:&quot;, err)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	defer c.Close()</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 新连接加入map</span><br><span class="line">	ConnMap[c.RemoteAddr().String()] &#x3D; c</span><br><span class="line"></span><br><span class="line">	for &#123;</span><br><span class="line">		mt, message, err :&#x3D; c.ReadMessage()</span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			log.Println(&quot;read:&quot;, err)</span><br><span class="line">			break</span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(&quot;recv: %s&quot;, message)</span><br><span class="line">		err &#x3D; c.WriteMessage(mt, message)</span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			log.Println(&quot;write:&quot;, err)</span><br><span class="line">			break</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	flag.Parse()</span><br><span class="line">	log.SetFlags(0)</span><br><span class="line">	begin :&#x3D; time.Now()</span><br><span class="line">	ConnMap &#x3D; make(map[string]*websocket.Conn)</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 启动 chrome 并开启截屏进程</span><br><span class="line">	go func() &#123;</span><br><span class="line">		opts :&#x3D; append(chromedp.DefaultExecAllocatorOptions[:],</span><br><span class="line">			chromedp.Flag(&quot;headless&quot;, true),</span><br><span class="line">			chromedp.Flag(&quot;disable-gpu&quot;, false),</span><br><span class="line">			chromedp.Flag(&quot;enable-automation&quot;, false),</span><br><span class="line">			chromedp.Flag(&quot;disable-extensions&quot;, true),</span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">		allocCtx, cancel :&#x3D; chromedp.NewExecAllocator(context.Background(), opts...)</span><br><span class="line">		defer cancel()</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; create context</span><br><span class="line">		ctx, cancel :&#x3D; chromedp.NewContext(allocCtx, chromedp.WithLogf(log.Printf))</span><br><span class="line">		defer cancel()</span><br><span class="line"></span><br><span class="line">		urlstr :&#x3D; &#96;https:&#x2F;&#x2F;youku.com&#x2F;&#96;</span><br><span class="line">		&#x2F;&#x2F; 需要截图的元素，支持CSS selector以及XPath query</span><br><span class="line">		selector :&#x3D; &#96;#m_15319&#96; &#x2F;&#x2F;&#96;#m_2556&#96; &#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">		if err :&#x3D; chromedp.Run(ctx,</span><br><span class="line">			&#x2F;&#x2F; emulate iPhone 7 landscape</span><br><span class="line">			&#x2F;&#x2F; chromedp.Emulate(device.IPhone7landscape),</span><br><span class="line">			chromedp.Navigate(urlstr),</span><br><span class="line">			chromedp.EmulateViewport(1200, 0, chromedp.EmulateScale(1)),</span><br><span class="line">		); err !&#x3D; nil &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		var buf []byte</span><br><span class="line">		for &#123;</span><br><span class="line">			buf &#x3D; []byte&#123;&#125;</span><br><span class="line">			if err :&#x3D; chromedp.Run(ctx, elementScreenshot(urlstr, selector, &amp;buf)); err !&#x3D; nil &#123;</span><br><span class="line">				log.Fatal(err)</span><br><span class="line">			&#125;</span><br><span class="line">			&#x2F;&#x2F; 发送到全局channel</span><br><span class="line">			CH_SC &lt;- buf</span><br><span class="line">			fmt.Println(int64(time.Since(begin).Seconds()), MAX_WATCH_TIME)</span><br><span class="line">			&#x2F;&#x2F; if int64(time.Since(begin).Seconds()) &gt; int64(MAX_WATCH_TIME) &#123;</span><br><span class="line">			&#x2F;&#x2F; 	return</span><br><span class="line">			&#x2F;&#x2F; &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 启动发送消息通道</span><br><span class="line">	go func() &#123;</span><br><span class="line">		for &#123;</span><br><span class="line">			select &#123;</span><br><span class="line">			case task :&#x3D; &lt;-CH_SC:</span><br><span class="line">				&#x2F;&#x2F;task.Process()</span><br><span class="line">				fmt.Println(time.Now().Format(DATE_TIME_FORMAT))</span><br><span class="line">				sendPictureData(task)</span><br><span class="line">				&#x2F;&#x2F; 写入文件</span><br><span class="line">				if err :&#x3D; ioutil.WriteFile(&quot;youku_b.png&quot;, task, 0644); err !&#x3D; nil &#123;</span><br><span class="line">					log.Fatal(err)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(&quot;&#x2F;echo&quot;, echo)</span><br><span class="line">	log.Fatal(http.ListenAndServe(*addr, nil))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 发送二进制图片数据</span><br><span class="line">func sendPictureData(picture []byte) &#123;</span><br><span class="line">	&#x2F;&#x2F; img, _ :&#x3D; png.Decode(bytes.NewReader(picture))</span><br><span class="line">	&#x2F;&#x2F; resizeImg :&#x3D; resize.Resize(hight, 0, img, resize.Lanczos3)</span><br><span class="line">	&#x2F;&#x2F;base64压缩</span><br><span class="line">	sourcestring :&#x3D; base64.StdEncoding.EncodeToString(picture)</span><br><span class="line">	&#x2F;&#x2F; err :&#x3D; c.WriteMessage(websocket.BinaryMessage, []byte(sourcestring))</span><br><span class="line">	for _, c :&#x3D; range ConnMap &#123;</span><br><span class="line">		err :&#x3D; c.WriteMessage(websocket.TextMessage, []byte(sourcestring))</span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			log.Println(&quot;write:&quot;, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 截图方法</span><br><span class="line">func elementScreenshot(urlstr, sel string, res *[]byte) chromedp.Tasks &#123;</span><br><span class="line">	&#x2F;&#x2F; ssOpts :&#x3D; append()</span><br><span class="line">	return chromedp.Tasks&#123;</span><br><span class="line">		&#x2F;&#x2F; chromedp.Navigate(urlstr),</span><br><span class="line">		chromedp.WaitVisible(sel, chromedp.ByID),</span><br><span class="line">		&#x2F;&#x2F;chromedp.Sleep(time.Duration(3) * time.Second),</span><br><span class="line">		&#x2F;&#x2F; 执行截图</span><br><span class="line">		chromedp.Screenshot(sel, res, chromedp.NodeVisible, chromedp.ByID),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="JS-处理"   >
          <a href="#JS-处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#JS-处理" class="headerlink" title="JS 处理"></a>JS 处理</h3>
       <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> function arrayBufferToBase64(buffer) &#123;</span><br><span class="line">    var binary &#x3D; &#39;&#39;;</span><br><span class="line">    var bytes &#x3D; new Uint8Array(buffer);</span><br><span class="line">    var len &#x3D; bytes.byteLength;</span><br><span class="line">    for (var i &#x3D; 0; i &lt; len; i++) &#123;</span><br><span class="line">        binary +&#x3D; String.fromCharCode(bytes[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    return window.btoa(binary);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;**blob to dataURL**</span><br><span class="line">function blobToDataURL(blob, callback) &#123;</span><br><span class="line">    var a &#x3D; new FileReader();</span><br><span class="line">    a.onload &#x3D; function(e) &#123;</span><br><span class="line">        callback(e.target.result);</span><br><span class="line">    &#125;</span><br><span class="line">    a.readAsDataURL(blob);</span><br><span class="line">    return a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var canvas &#x3D; document.getElementById(&quot;animation_canvas&quot;);</span><br><span class="line">canvas.width &#x3D; 640;</span><br><span class="line">canvas.height &#x3D; 1030;</span><br><span class="line"></span><br><span class="line">var ctx &#x3D; canvas.getContext(&quot;2d&quot;);</span><br><span class="line">let ws &#x3D; new WebSocket(&quot;ws:&#x2F;&#x2F;localhost:9999&#x2F;echo&quot;);</span><br><span class="line">var player &#x3D; document.getElementById(&#39;player&#39;);</span><br><span class="line">ctx.drawImage(player, 0, 0);</span><br><span class="line"></span><br><span class="line">ws.onopen &#x3D; function () &#123;</span><br><span class="line">    ws.send(JSON.stringify(&#123; message: &quot;hello server!&quot; &#125;))</span><br><span class="line">&#125;</span><br><span class="line">ws.onmessage &#x3D; function(evt) &#123;</span><br><span class="line">    &#x2F;&#x2F; console.log(evt.data,typeof(evt.data))</span><br><span class="line">    &#x2F;&#x2F; base64数据直接展示  </span><br><span class="line">    if(typeof(evt.data)&#x3D;&#x3D;&quot;string&quot;)&#123;</span><br><span class="line">        player.src&#x3D;&#39;data:image&#x2F;png;base64,&#39;+evt.data;</span><br><span class="line">        player.onload&#x3D;function()&#123;</span><br><span class="line">            canvas.width &#x3D; 1200;</span><br><span class="line">            canvas.height &#x3D; this.height;</span><br><span class="line">            ctx.clearRect(0,0,canvas.width,canvas.height);  </span><br><span class="line">            ctx.drawImage(this, 0, 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 二进制数据转图片</span><br><span class="line">    &#x2F;&#x2F; result &#x3D; blobToDataURL(evt.data, function(dataurl) &#123;</span><br><span class="line">    &#x2F;&#x2F;     &#x2F;&#x2F; 截取 base64,</span><br><span class="line">    &#x2F;&#x2F;     var arr &#x3D; dataurl.split(&#39;,&#39;);</span><br><span class="line">    &#x2F;&#x2F;     var mime &#x3D; arr[0].match(&#x2F;:(.*?);&#x2F;)[1];</span><br><span class="line">    &#x2F;&#x2F;     var player &#x3D; document.getElementById(&#39;player&#39;);</span><br><span class="line">    &#x2F;&#x2F;     ctx.drawImage(player, 0, 0);</span><br><span class="line">    &#x2F;&#x2F;     var url&#x3D; arrayBufferToBase64(evt.data);</span><br><span class="line">    &#x2F;&#x2F;     player.src&#x3D;&#39;data:image&#x2F;png;base64,&#39;+arr[1];</span><br><span class="line">    &#x2F;&#x2F;     player.onload&#x3D;function()&#123;</span><br><span class="line">    &#x2F;&#x2F;         canvas.width &#x3D; 1200;</span><br><span class="line">    &#x2F;&#x2F;         canvas.height &#x3D; this.height;</span><br><span class="line">    &#x2F;&#x2F;         ctx.clearRect(0,0,canvas.width,canvas.height);  </span><br><span class="line">    &#x2F;&#x2F;         ctx.drawImage(this, 0, 0);</span><br><span class="line">    &#x2F;&#x2F;     &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; &#125;);</span><br><span class="line">&#125;</span><br><span class="line">ws.onerror &#x3D; function (event) &#123;</span><br><span class="line">    console.debug(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="http://baqianxin.github.io">baqianxin</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="http://baqianxin.github.io/2019/03/05/Golang%E4%BD%BF%E7%94%A8WebSocket-ChromeDP%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E9%A1%B5%E9%9D%A2%E7%9B%91%E6%8E%A7/">http://baqianxin.github.io/2019/03/05/Golang%E4%BD%BF%E7%94%A8WebSocket-ChromeDP%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E9%A1%B5%E9%9D%A2%E7%9B%91%E6%8E%A7/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://baqianxin.github.io/tags/WebSocket-chromedp-golang/">WebSocket chromedp golang</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2019/03/12/Go-Gin%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Go-Gin示例代码</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2018/09/15/Linux-SSH-%E9%9A%A7%E9%81%93%E5%8A%9F%E8%83%BD/"><span class="paginator-prev__text">Linux:SSH 隧道功能</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WebSocket-Chromedp%E5%AE%9E%E7%8E%B0%E9%A1%B5%E9%9D%A2%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7"><span class="toc-number">1.</span> <span class="toc-text">
          WebSocket+Chromedp实现页面实时监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BA%E5%8F%91%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text">
          出发点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Socket"><span class="toc-number">1.2.</span> <span class="toc-text">
          Socket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket"><span class="toc-number">1.3.</span> <span class="toc-text">
          WebSocket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chromedp"><span class="toc-number">1.4.</span> <span class="toc-text">
          chromedp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples"><span class="toc-number">1.4.1.</span> <span class="toc-text">
          Examples</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E9%80%BB%E8%BE%91"><span class="toc-number">1.5.</span> <span class="toc-text">
          功能逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">1.6.</span> <span class="toc-text">
          实现代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Golang-Server"><span class="toc-number">1.6.1.</span> <span class="toc-text">
          Golang Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JS-%E5%A4%84%E7%90%86"><span class="toc-number">1.6.2.</span> <span class="toc-text">
          JS 处理</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">分治</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">15</div><div class="sidebar-ov-state-item__name">Archives</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>baqianxin</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>